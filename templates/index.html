{% extends "base.html" %}

{% block title %}首页 - Secretary{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header">
                <h4 class="mb-0">系统概览</h4>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-4">
                        <div class="card mb-3">
                            <div class="card-body text-center">
                                <h5 class="card-title">监控账号</h5>
                                <p class="card-text display-4" id="account-count">-</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card mb-3">
                            <div class="card-body text-center">
                                <h5 class="card-title">今日分析</h5>
                                <p class="card-text display-4" id="today-count">-</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card mb-3">
                            <div class="card-body text-center">
                                <h5 class="card-title">相关内容</h5>
                                <p class="card-text display-4" id="relevant-count">-</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row mt-4">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header">
                <h4 class="mb-0">最近分析结果</h4>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>平台</th>
                                <th>账号</th>
                                <th>时间</th>
                                <th>内容</th>
                                <th>相关性</th>
                            </tr>
                        </thead>
                        <tbody id="recent-results">
                            <tr>
                                <td colspan="5" class="text-center">加载中...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                <div class="text-end">
                    <a href="{{ url_for('results') }}" class="btn btn-primary">查看全部</a>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // 获取最近分析结果
    fetch('/api/results')
        .then(response => response.json())
        .then(data => {
            const recentResults = document.getElementById('recent-results');
            recentResults.innerHTML = '';
            
            // 显示最近10条结果
            const results = data.slice(0, 10);
            
            if (results.length === 0) {
                recentResults.innerHTML = '<tr><td colspan="5" class="text-center">暂无数据</td></tr>';
                return;
            }
            
            // 统计数据
            document.getElementById('account-count').textContent = new Set(data.map(r => r.account_id)).size;
            
            const today = new Date().toISOString().split('T')[0];
            const todayResults = data.filter(r => r.created_at.startsWith(today));
            document.getElementById('today-count').textContent = todayResults.length;
            
            const relevantResults = data.filter(r => r.is_relevant);
            document.getElementById('relevant-count').textContent = relevantResults.length;
            
            // 填充表格
            results.forEach(result => {
                const row = document.createElement('tr');
                
                const platformCell = document.createElement('td');
                platformCell.textContent = result.social_network;
                
                const accountCell = document.createElement('td');
                accountCell.textContent = result.account_id;
                
                const timeCell = document.createElement('td');
                const date = new Date(result.post_time);
                timeCell.textContent = date.toLocaleString();
                
                const contentCell = document.createElement('td');
                contentCell.textContent = result.content.length > 50 
                    ? result.content.substring(0, 50) + '...' 
                    : result.content;
                
                const relevantCell = document.createElement('td');
                relevantCell.innerHTML = result.is_relevant 
                    ? '<span class="badge bg-success">相关</span>' 
                    : '<span class="badge bg-secondary">不相关</span>';
                
                row.appendChild(platformCell);
                row.appendChild(accountCell);
                row.appendChild(timeCell);
                row.appendChild(contentCell);
                row.appendChild(relevantCell);
                
                recentResults.appendChild(row);
            });
        })
        .catch(error => {
            console.error('Error fetching results:', error);
            document.getElementById('recent-results').innerHTML = 
                '<tr><td colspan="5" class="text-center text-danger">加载失败</td></tr>';
        });
</script>
{% endblock %}
