{% extends "base.html" %}

{% block title %}系统设置 - TweetAnalyst{% endblock %}

{% block content %}
<div class="container mt-4">
    <h1 class="mb-4">系统设置</h1>

    <!-- 设置导航选项卡 -->
    <ul class="nav nav-tabs mb-4" id="settingsTabs" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="general-tab" data-bs-toggle="tab" data-bs-target="#general" type="button" role="tab" aria-controls="general" aria-selected="true">
                <i class="bi bi-gear"></i> 基本设置
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="twitter-tab" data-bs-toggle="tab" data-bs-target="#twitter" type="button" role="tab" aria-controls="twitter" aria-selected="false">
                <i class="bi bi-twitter"></i> Twitter设置
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="llm-tab" data-bs-toggle="tab" data-bs-target="#llm" type="button" role="tab" aria-controls="llm" aria-selected="false">
                <i class="bi bi-cpu"></i> LLM设置
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="proxy-tab" data-bs-toggle="tab" data-bs-target="#proxy" type="button" role="tab" aria-controls="proxy" aria-selected="false">
                <i class="bi bi-hdd-network"></i> 代理设置
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="notification-tab" data-bs-toggle="tab" data-bs-target="#notification" type="button" role="tab" aria-controls="notification" aria-selected="false">
                <i class="bi bi-bell"></i> 推送设置
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="account-tab" data-bs-toggle="tab" data-bs-target="#account" type="button" role="tab" aria-controls="account" aria-selected="false">
                <i class="bi bi-person"></i> 账号设置
            </button>
        </li>
    </ul>

    <!-- 选项卡内容 -->
    <div class="tab-content" id="settingsTabContent">
        <!-- 基本设置 -->
        <div class="tab-pane fade show active" id="general" role="tabpanel" aria-labelledby="general-tab">
            <div class="card">
                <div class="card-header">
                    <h4 class="mb-0">定时任务配置</h4>
                </div>
                <div class="card-body">
                    <form method="post" action="/api/settings/scheduler">
                        <div class="mb-3">
                            <label for="scheduler-interval" class="form-label">执行间隔（分钟）</label>
                            <input type="number" class="form-control" id="scheduler-interval" name="scheduler_interval" value="{{ config.get('SCHEDULER_INTERVAL_MINUTES', '30') }}" min="1" max="1440">
                            <div class="form-text">
                                定时任务执行间隔，单位为分钟，默认为30分钟
                            </div>
                        </div>
                        <button type="submit" class="btn btn-primary">保存定时任务配置</button>
                    </form>
                </div>
            </div>

            <div class="card mt-4">
                <div class="card-header">
                    <h4 class="mb-0">自动回复设置</h4>
                </div>
                <div class="card-body">
                    <form method="post" action="/api/settings/auto_reply">
                        <div class="mb-3">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="enable-auto-reply" name="enable_auto_reply" {% if enable_auto_reply %}checked{% endif %}>
                                <label class="form-check-label" for="enable-auto-reply">启用自动回复</label>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="auto-reply-prompt" class="form-label">自动回复提示词</label>
                            <textarea class="form-control" id="auto-reply-prompt" name="auto_reply_prompt" rows="5" placeholder="自动回复的LLM提示词">{{ auto_reply_prompt }}</textarea>
                            <div class="form-text">
                                用于生成回复内容的提示词模板，使用{content}作为内容占位符。<br>
                                注意：此设置为全局设置，也可以在账号管理中为每个账号单独设置。
                            </div>
                        </div>
                        <div class="d-flex justify-content-between">
                            <button type="submit" class="btn btn-primary">保存自动回复设置</button>
                            <button type="button" class="btn btn-outline-primary" id="test-auto-reply-btn">测试自动回复</button>
                        </div>
                    </form>
                    <div class="mt-3">
                        <div id="auto-reply-test-result" class="alert d-none" style="border: 2px solid; font-weight: 500;"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Twitter设置 -->
        <div class="tab-pane fade" id="twitter" role="tabpanel" aria-labelledby="twitter-tab">
            <div class="card">
                <div class="card-header">
                    <h4 class="mb-0">Twitter配置</h4>
                </div>
                <div class="card-body">
                    <form method="post" action="/api/settings/twitter">
                        <div class="mb-3">
                            <label for="twitter-username" class="form-label">用户名</label>
                            <input type="text" class="form-control" id="twitter-username" name="twitter_username" value="{{ config.get('TWITTER_USERNAME', '') }}">
                        </div>
                        <div class="mb-3">
                            <label for="twitter-password" class="form-label">密码</label>
                            <input type="password" class="form-control" id="twitter-password" name="twitter_password" value="{{ config.get('TWITTER_PASSWORD', '') }}">
                        </div>
                        <div class="mb-3">
                            <label for="twitter-session" class="form-label">会话数据</label>
                            <textarea class="form-control" id="twitter-session" name="twitter_session" rows="3">{{ config.get('TWITTER_SESSION', '') }}</textarea>
                            <div class="form-text">
                                可选，如果提供了会话数据，将优先使用会话数据登录
                            </div>
                        </div>
                        <div class="d-flex justify-content-between">
                            <button type="submit" class="btn btn-primary">保存Twitter配置</button>
                            <button type="button" class="btn btn-outline-primary" id="test-twitter-btn">测试Twitter连接</button>
                        </div>
                    </form>
                    <div class="mt-3">
                        <div id="twitter-test-result" class="alert d-none" style="border: 2px solid; font-weight: 500;"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- LLM设置 -->
        <div class="tab-pane fade" id="llm" role="tabpanel" aria-labelledby="llm-tab">
            <div class="card">
                <div class="card-header">
                    <h4 class="mb-0">LLM配置</h4>
                </div>
                <div class="card-body">
                    <form method="post" action="/api/settings/llm">
                        <div class="mb-3">
                            <label for="llm-api-key" class="form-label">API密钥</label>
                            <input type="password" class="form-control" id="llm-api-key" name="llm_api_key" value="{{ config.get('LLM_API_KEY', '') }}">
                            <div class="form-text">
                                xAI API密钥或其他兼容的LLM API密钥
                            </div>
                        </div>
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="llm-api-model" class="form-label">API模型</label>
                                <input type="text" class="form-control" id="llm-api-model" name="llm_api_model" value="{{ config.get('LLM_API_MODEL', 'grok-2-latest') }}">
                                <div class="form-text">
                                    如：grok-2-latest, gpt-4等
                                </div>
                            </div>
                            <div class="col-md-6">
                                <label for="llm-api-base" class="form-label">API基础URL</label>
                                <input type="text" class="form-control" id="llm-api-base" name="llm_api_base" value="{{ config.get('LLM_API_BASE', 'https://api.x.ai/v1') }}">
                                <div class="form-text">
                                    API服务器地址，默认为xAI官方地址
                                </div>
                            </div>
                        </div>
                        <div class="d-flex justify-content-between">
                            <button type="submit" class="btn btn-primary">保存LLM配置</button>
                            <button type="button" class="btn btn-outline-primary" id="test-llm-btn">测试LLM连接</button>
                        </div>
                    </form>
                    <div class="mt-3">
                        <div id="llm-test-result" class="alert d-none" style="border: 2px solid; font-weight: 500;"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 代理设置 -->
        <div class="tab-pane fade" id="proxy" role="tabpanel" aria-labelledby="proxy-tab">
            <div class="card">
                <div class="card-header">
                    <h4 class="mb-0">代理设置</h4>
                </div>
                <div class="card-body">
                    <form method="post" action="/api/settings/proxy">
                        <div class="mb-3">
                            <label for="http-proxy" class="form-label">HTTP代理</label>
                            <input type="text" class="form-control" id="http-proxy" name="http_proxy" value="{{ http_proxy }}" placeholder="http://127.0.0.1:7890">
                            <div class="form-text">
                                设置HTTP代理，用于访问Twitter等需要代理的网站。<br>
                                格式：http://主机:端口 或 socks5://主机:端口
                            </div>
                        </div>
                        <div class="d-flex justify-content-between">
                            <button type="submit" class="btn btn-primary">保存代理设置</button>
                            <button type="button" class="btn btn-outline-primary" id="test-proxy-btn">测试代理连接</button>
                        </div>
                    </form>
                    <div class="mt-3">
                        <div id="proxy-test-result" class="alert d-none" style="border: 2px solid; font-weight: 500;"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 推送设置 -->
        <div class="tab-pane fade" id="notification" role="tabpanel" aria-labelledby="notification-tab">
            <div class="card">
                <div class="card-header">
                    <h4 class="mb-0">推送设置</h4>
                </div>
                <div class="card-body">
                    <form method="post" action="/api/settings/notification">
                        <div class="mb-3">
                            <label for="apprise-urls" class="form-label">Apprise URLs</label>
                            <textarea class="form-control" id="apprise-urls" name="apprise_urls" rows="5" placeholder="每行一个Apprise URL">{{ apprise_urls }}</textarea>
                            <div class="form-text">
                                支持多种推送方式，每行一个URL。例如：<br>
                                tgram://bottoken/ChatID<br>
                                discord://webhook_id/webhook_token<br>
                                wecombot://key<br>
                                更多格式请参考 <a href="https://github.com/caronc/apprise/wiki" target="_blank">Apprise Wiki</a>
                            </div>
                        </div>
                        <div class="d-flex justify-content-between">
                            <button type="submit" class="btn btn-primary">保存推送设置</button>
                            <button type="button" class="btn btn-outline-primary" id="test-notification-btn">测试推送</button>
                        </div>
                    </form>
                    <div class="mt-3">
                        <div id="notification-test-result" class="alert d-none" style="border: 2px solid; font-weight: 500;"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 账号设置 -->
        <div class="tab-pane fade" id="account" role="tabpanel" aria-labelledby="account-tab">
            <div class="card">
                <div class="card-header">
                    <h4 class="mb-0">账号设置</h4>
                </div>
                <div class="card-body">
                    <form method="post" action="/api/settings/account">
                        <div class="mb-3">
                            <label for="current-password" class="form-label">当前密码</label>
                            <input type="password" class="form-control" id="current-password" name="current_password">
                        </div>
                        <div class="mb-3">
                            <label for="new-password" class="form-label">新密码</label>
                            <input type="password" class="form-control" id="new-password" name="new_password">
                        </div>
                        <div class="mb-3">
                            <label for="confirm-password" class="form-label">确认新密码</label>
                            <input type="password" class="form-control" id="confirm-password" name="confirm_password">
                        </div>
                        <button type="submit" class="btn btn-primary">更改密码</button>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // 处理URL中的锚点，激活对应的选项卡
    document.addEventListener('DOMContentLoaded', function() {
        // 获取URL中的锚点
        let hash = window.location.hash;
        if (hash) {
            // 移除开头的#号
            hash = hash.substring(1);

            // 尝试激活对应的选项卡
            const tab = document.getElementById(hash + '-tab');
            if (tab) {
                const tabTrigger = new bootstrap.Tab(tab);
                tabTrigger.show();

                // 滚动到选项卡位置
                setTimeout(function() {
                    window.scrollTo(0, 0);
                }, 100);
            }
        }

        // 为选项卡添加点击事件，更新URL锚点
        const tabs = document.querySelectorAll('button[data-bs-toggle="tab"]');
        tabs.forEach(function(tab) {
            tab.addEventListener('shown.bs.tab', function(event) {
                // 获取激活的选项卡ID
                const id = event.target.getAttribute('aria-controls');

                // 更新URL锚点，但不刷新页面
                if (history.pushState) {
                    history.pushState(null, null, '#' + id);
                } else {
                    window.location.hash = id;
                }
            });
        });
    });
    // 通用测试函数
    function testConnection(type, inputId, resultDivId, buttonId, requestUrl, requestBodyFn, successHandler, failureHandler) {
        const button = document.getElementById(buttonId);
        if (!button) return;

        button.addEventListener('click', function() {
            const inputValue = inputId ? document.getElementById(inputId).value : '';
            const resultDiv = document.getElementById(resultDivId);

            // 显示加载状态
            button.disabled = true;
            button.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> 测试中...';

            // 显示初始状态信息
            resultDiv.classList.remove('d-none', 'alert-success', 'alert-danger');
            resultDiv.classList.add('alert-info');
            resultDiv.innerHTML = `<h5><i class="bi bi-hourglass-split text-info"></i> 正在测试...</h5><p>正在连接${type}，请稍候...</p><div class="progress mt-2"><div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 100%"></div></div>`;

            // 准备请求体
            const requestBody = requestBodyFn ? requestBodyFn(inputValue) : {};

            // 发送请求
            fetch(requestUrl, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(requestBody),
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    resultDiv.classList.remove('alert-danger', 'alert-info');
                    resultDiv.classList.add('alert-success');

                    let resultHtml = `<h5><i class="bi bi-check-circle-fill text-success"></i> 测试成功</h5><p>${data.message}</p>`;

                    // 使用自定义成功处理函数
                    if (successHandler) {
                        resultHtml = successHandler(data, resultHtml);
                    }

                    resultDiv.innerHTML = resultHtml;
                } else {
                    resultDiv.classList.remove('alert-success', 'alert-info');
                    resultDiv.classList.add('alert-danger');

                    let failureHtml = `<h5><i class="bi bi-x-circle-fill text-danger"></i> 测试失败</h5><p>${data.message}</p>`;

                    // 使用自定义失败处理函数
                    if (failureHandler) {
                        failureHtml = failureHandler(data, failureHtml);
                    }

                    resultDiv.innerHTML = failureHtml;
                }
            })
            .catch(error => {
                console.error('Error:', error);
                resultDiv.classList.remove('alert-success', 'alert-info');
                resultDiv.classList.add('alert-danger');
                resultDiv.innerHTML = `<h5><i class="bi bi-exclamation-triangle-fill text-warning"></i> 请求错误</h5>
                    <p>${error.message}</p>
                    <div class="mt-2">
                        <strong>调试信息:</strong>
                        <ul>
                            <li>请求URL: ${requestUrl}</li>
                            <li>请求方法: POST</li>
                            <li>请求参数: ${JSON.stringify(requestBody)}</li>
                        </ul>
                    </div>`;
            })
            .finally(() => {
                // 恢复按钮状态
                button.disabled = false;
                button.innerHTML = `测试${type}连接`;
            });
        });
    }

    // 测试Twitter连接
    testConnection(
        'Twitter API',
        'twitter-username',
        'twitter-test-result',
        'test-twitter-btn',
        '/api/test/twitter',
        (accountId) => ({ account_id: accountId }),
        (data, resultHtml) => {
            if (data.data) {
                resultHtml += '<ul>';
                if (data.data.account_id) resultHtml += `<li>账号ID: ${data.data.account_id}</li>`;
                if (data.data.post_count) resultHtml += `<li>获取推文数: ${data.data.post_count}</li>`;
                if (data.data.response_time) resultHtml += `<li>响应时间: ${data.data.response_time}</li>`;
                resultHtml += '</ul>';

                if (data.data.first_post) {
                    resultHtml += '<h6>第一条推文:</h6>';
                    resultHtml += '<ul>';
                    resultHtml += `<li>ID: ${data.data.first_post.id}</li>`;
                    resultHtml += `<li>时间: ${data.data.first_post.time}</li>`;
                    resultHtml += `<li>内容: ${data.data.first_post.content}</li>`;
                    resultHtml += '</ul>';
                }
            }
            return resultHtml;
        },
        (data, failureHtml) => {
            failureHtml += '<div class="mt-3 p-2 bg-light border-start border-warning border-4">';
            failureHtml += '<p class="mb-1"><strong>可能的解决方案：</strong></p>';
            failureHtml += '<ul class="mb-0">';
            failureHtml += '<li>检查网络连接是否正常</li>';
            failureHtml += '<li>确认Twitter账号和密码是否正确</li>';
            failureHtml += '<li>检查代理设置是否正确</li>';
            failureHtml += '<li>尝试使用会话数据登录</li>';
            failureHtml += '</ul>';
            failureHtml += '</div>';
            return failureHtml;
        }
    );

    // 测试LLM连接
    testConnection(
        'LLM API',
        'llm-api-model',
        'llm-test-result',
        'test-llm-btn',
        '/api/test/llm',
        (model) => ({ prompt: "请用一句话回答：今天天气怎么样？", model: model }),
        (data, resultHtml) => {
            if (data.data) {
                resultHtml += '<ul>';
                if (data.data.prompt) resultHtml += `<li>提示词: ${data.data.prompt}</li>`;
                if (data.data.response_time) resultHtml += `<li>响应时间: ${data.data.response_time}</li>`;
                resultHtml += '</ul>';

                if (data.data.response) {
                    resultHtml += '<h6>LLM响应:</h6>';
                    resultHtml += `<div class="p-2 bg-light">${data.data.response}</div>`;
                }
            }
            return resultHtml;
        },
        (data, failureHtml) => {
            failureHtml += '<div class="mt-3 p-2 bg-light border-start border-warning border-4">';
            failureHtml += '<p class="mb-1"><strong>可能的解决方案：</strong></p>';
            failureHtml += '<ul class="mb-0">';
            failureHtml += '<li>检查LLM API密钥是否正确</li>';
            failureHtml += '<li>确认API基础URL是否正确</li>';
            failureHtml += '<li>检查网络连接是否正常</li>';
            failureHtml += '<li>检查代理设置是否正确</li>';
            failureHtml += '</ul>';
            failureHtml += '</div>';
            return failureHtml;
        }
    );

    // 测试代理连接
    testConnection(
        '代理',
        'http-proxy',
        'proxy-test-result',
        'test-proxy-btn',
        '/api/test/proxy',
        (proxy) => ({ url: "https://api.ipify.org?format=json" }),
        (data, resultHtml) => {
            if (data.data) {
                resultHtml += '<ul>';
                if (data.data.url) resultHtml += `<li>测试URL: ${data.data.url}</li>`;
                if (data.data.ip) resultHtml += `<li>当前IP: ${data.data.ip}</li>`;
                if (data.data.proxy) resultHtml += `<li>代理设置: ${data.data.proxy}</li>`;
                if (data.data.response_time) resultHtml += `<li>响应时间: ${data.data.response_time}</li>`;
                resultHtml += '</ul>';
            }
            return resultHtml;
        },
        (data, failureHtml) => {
            failureHtml += '<div class="mt-3 p-2 bg-light border-start border-warning border-4">';
            failureHtml += '<p class="mb-1"><strong>可能的解决方案：</strong></p>';
            failureHtml += '<ul class="mb-0">';
            failureHtml += '<li>检查代理地址和端口是否正确</li>';
            failureHtml += '<li>确认代理服务器是否正常运行</li>';
            failureHtml += '<li>检查网络连接是否正常</li>';
            failureHtml += '<li>尝试使用不同的测试URL</li>';
            failureHtml += '</ul>';
            failureHtml += '</div>';
            return failureHtml;
        }
    );

    // 测试推送
    testConnection(
        '推送',
        'apprise-urls',
        'notification-test-result',
        'test-notification-btn',
        '/api/test/notification',
        (urls) => ({ urls: urls }),
        (data, resultHtml) => {
            if (data.data) {
                resultHtml += '<ul>';
                if (data.data.sent_to) resultHtml += `<li>发送到: ${data.data.sent_to}</li>`;
                if (data.data.response_time) resultHtml += `<li>响应时间: ${data.data.response_time}</li>`;
                resultHtml += '</ul>';
            }
            return resultHtml;
        },
        (data, failureHtml) => {
            failureHtml += '<div class="mt-3 p-2 bg-light border-start border-warning border-4">';
            failureHtml += '<p class="mb-1"><strong>可能的解决方案：</strong></p>';
            failureHtml += '<ul class="mb-0">';
            failureHtml += '<li>检查Apprise URL格式是否正确</li>';
            failureHtml += '<li>确认推送服务是否可用</li>';
            failureHtml += '<li>检查网络连接是否正常</li>';
            failureHtml += '<li>尝试使用不同的推送方式</li>';
            failureHtml += '</ul>';
            failureHtml += '</div>';
            return failureHtml;
        }
    );
</script>
{% endblock %}
