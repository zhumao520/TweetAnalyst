{% extends "base.html" %}

{% block title %}账号管理 - TweetAnalyst{% endblock %}

{% block content %}
<div class="row mb-3">
    <div class="col-12">
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="{{ url_for('index') }}">首页</a></li>
                <li class="breadcrumb-item active" aria-current="page">账号管理</li>
            </ol>
        </nav>
    </div>
</div>

<div class="row mb-4">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center">
            <h2 class="border-bottom pb-2">
                <i class="bi bi-people-fill me-2 text-primary"></i>社交媒体账号管理
            </h2>
            <div class="btn-group">
                <button id="run-all-accounts-btn" class="btn btn-success me-2">
                    <i class="bi bi-play-fill me-1"></i> <span class="btn-text">立即抓取所有账号</span>
                    <span class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span>
                </button>
                <a href="{{ url_for('add_account') }}" class="btn btn-primary">
                    <i class="bi bi-plus-lg me-1"></i> 添加账号
                </a>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-md-12">
        <div class="card shadow-sm">
            <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="bi bi-list-ul me-2"></i>账号列表
                </h5>
                <div>
                    <button id="filter-accounts-btn" class="btn btn-sm btn-light me-2" data-bs-toggle="collapse" data-bs-target="#filterOptions" aria-expanded="false" aria-controls="filterOptions">
                        <i class="bi bi-funnel me-1"></i> 筛选
                    </button>
                    <div class="btn-group">
                        <button type="button" class="btn btn-sm btn-light dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false">
                            <i class="bi bi-sort-down me-1"></i> 排序
                        </button>
                        <ul class="dropdown-menu dropdown-menu-end">
                            <li><button class="dropdown-item sort-btn" data-sort="id">按ID排序</button></li>
                            <li><button class="dropdown-item sort-btn" data-sort="platform">按平台排序</button></li>
                            <li><button class="dropdown-item sort-btn" data-sort="account">按账号排序</button></li>
                            <li><button class="dropdown-item sort-btn" data-sort="created">按创建时间排序</button></li>
                        </ul>
                    </div>
                </div>
            </div>

            <!-- 筛选选项 -->
            <div class="collapse" id="filterOptions">
                <div class="card-body bg-light border-bottom">
                    <div class="row g-3">
                        <div class="col-md-3">
                            <label for="platform-filter" class="form-label">平台</label>
                            <select class="form-select form-select-sm" id="platform-filter">
                                <option value="">全部平台</option>
                                <option value="twitter">Twitter</option>
                                <option value="weibo">微博</option>
                                <option value="other">其他</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label for="tag-filter" class="form-label">标签</label>
                            <select class="form-select form-select-sm" id="tag-filter">
                                <option value="">全部标签</option>
                                {% set tags = [] %}
                                {% for account in accounts %}
                                    {% if account.tag and account.tag not in tags %}
                                        {% set _ = tags.append(account.tag) %}
                                        <option value="{{ account.tag }}">{{ account.tag }}</option>
                                    {% endif %}
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label for="auto-reply-filter" class="form-label">自动回复</label>
                            <select class="form-select form-select-sm" id="auto-reply-filter">
                                <option value="">全部</option>
                                <option value="enabled">已启用</option>
                                <option value="disabled">未启用</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label for="ai-filter" class="form-label">AI分析</label>
                            <select class="form-select form-select-sm" id="ai-filter">
                                <option value="">全部</option>
                                <option value="enabled">AI分析</option>
                                <option value="disabled">直接推送</option>
                            </select>
                        </div>
                    </div>
                    <div class="d-flex justify-content-end mt-3">
                        <button id="reset-filter-btn" class="btn btn-sm btn-outline-secondary me-2">
                            <i class="bi bi-arrow-counterclockwise me-1"></i> 重置
                        </button>
                        <button id="apply-filter-btn" class="btn btn-sm btn-primary">
                            <i class="bi bi-check2 me-1"></i> 应用筛选
                        </button>
                    </div>
                </div>
            </div>

            <div class="card-body p-0">
                {% if accounts %}
                <div class="table-responsive">
                    <table class="table table-hover mb-0" id="accounts-table">
                        <thead class="table-light">
                            <tr>
                                <th class="border-0">
                                    <div class="d-flex align-items-center">
                                        <i class="bi bi-hash me-1"></i>ID
                                        <button class="btn btn-sm text-muted sort-btn ms-1" data-sort="id">
                                            <i class="bi bi-arrow-down-up"></i>
                                        </button>
                                    </div>
                                </th>
                                <th class="border-0">
                                    <div class="d-flex align-items-center">
                                        <i class="bi bi-globe me-1"></i>平台
                                        <button class="btn btn-sm text-muted sort-btn ms-1" data-sort="platform">
                                            <i class="bi bi-arrow-down-up"></i>
                                        </button>
                                    </div>
                                </th>
                                <th class="border-0">
                                    <div class="d-flex align-items-center">
                                        <i class="bi bi-person me-1"></i>账号
                                        <button class="btn btn-sm text-muted sort-btn ms-1" data-sort="account">
                                            <i class="bi bi-arrow-down-up"></i>
                                        </button>
                                    </div>
                                </th>
                                <th class="border-0">
                                    <i class="bi bi-tag me-1"></i>标签
                                </th>
                                <th class="border-0">
                                    <i class="bi bi-chat-dots me-1"></i>自动回复
                                </th>
                                <th class="border-0">
                                    <i class="bi bi-robot me-1"></i>AI分析
                                </th>
                                <th class="border-0">
                                    <div class="d-flex align-items-center">
                                        <i class="bi bi-calendar-date me-1"></i>创建时间
                                        <button class="btn btn-sm text-muted sort-btn ms-1" data-sort="created">
                                            <i class="bi bi-arrow-down-up"></i>
                                        </button>
                                    </div>
                                </th>
                                <th class="border-0 text-end">
                                    <i class="bi bi-gear me-1"></i>操作
                                </th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for account in accounts %}
                            <tr class="account-row"
                                data-id="{{ account.id }}"
                                data-platform="{{ account.type }}"
                                data-account="{{ account.account_id }}"
                                data-tag="{{ account.tag }}"
                                data-auto-reply="{{ 'enabled' if account.enable_auto_reply else 'disabled' }}"
                                data-ai="{{ 'disabled' if account.bypass_ai else 'enabled' }}"
                                data-created="{{ account.created_at.timestamp() }}">
                                <td>{{ account.id }}</td>
                                <td>
                                    {% if account.type == 'twitter' %}
                                        <span class="badge bg-primary"><i class="bi bi-twitter me-1"></i>Twitter</span>
                                    {% elif account.type == 'weibo' %}
                                        <span class="badge bg-danger"><i class="bi bi-sina-weibo me-1"></i>微博</span>
                                    {% else %}
                                        <span class="badge bg-secondary"><i class="bi bi-globe me-1"></i>{{ account.type }}</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <div class="d-flex align-items-center">
                                        <span class="me-2">{{ account.account_id }}</span>
                                        <button class="btn btn-sm btn-outline-secondary copy-btn" data-clipboard-text="{{ account.account_id }}" title="复制账号ID">
                                            <i class="bi bi-clipboard"></i>
                                        </button>
                                    </div>
                                </td>
                                <td>
                                    {% if account.tag %}
                                        <span class="badge bg-info">{{ account.tag }}</span>
                                    {% else %}
                                        <span class="text-muted">-</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if account.enable_auto_reply %}
                                        <span class="badge bg-success"><i class="bi bi-check-circle me-1"></i>已启用</span>
                                    {% else %}
                                        <span class="badge bg-secondary"><i class="bi bi-x-circle me-1"></i>未启用</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if account.bypass_ai %}
                                        <span class="badge bg-warning text-dark" title="所有内容将直接推送，不经过AI分析">
                                            <i class="bi bi-lightning me-1"></i>直接推送
                                        </span>
                                    {% else %}
                                        <span class="badge bg-info">
                                            <i class="bi bi-robot me-1"></i>AI分析
                                        </span>
                                    {% endif %}
                                </td>
                                <td>
                                    <span title="{{ account.created_at.strftime('%Y-%m-%d %H:%M:%S') }}">
                                        {{ account.created_at.strftime('%Y-%m-%d %H:%M') }}
                                    </span>
                                </td>
                                <td>
                                    <div class="btn-group" role="group">
                                        <button type="button" class="btn btn-sm btn-outline-success run-account-btn"
                                                data-account-id="{{ account.account_id }}" title="抓取此账号内容">
                                            <i class="bi bi-play-fill"></i> <span class="btn-text">抓取</span>
                                            <span class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span>
                                        </button>
                                        <a href="{{ url_for('edit_account', account_id=account.account_id) }}" class="btn btn-sm btn-outline-primary" title="编辑账号信息">
                                            <i class="bi bi-pencil"></i> 编辑
                                        </a>
                                        <button type="button" class="btn btn-sm btn-outline-danger"
                                                data-bs-toggle="modal" data-bs-target="#deleteModal{{ account.id }}" title="删除此账号">
                                            <i class="bi bi-trash"></i> 删除
                                        </button>
                                    </div>

                                    <!-- 删除确认模态框 -->
                                    <div class="modal fade" id="deleteModal{{ account.id }}" tabindex="-1" aria-hidden="true">
                                        <div class="modal-dialog">
                                            <div class="modal-content">
                                                <div class="modal-header bg-danger text-white">
                                                    <h5 class="modal-title">
                                                        <i class="bi bi-exclamation-triangle-fill me-2"></i>确认删除
                                                    </h5>
                                                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                                                </div>
                                                <div class="modal-body">
                                                    <p>您确定要删除以下账号吗？</p>
                                                    <div class="alert alert-warning">
                                                        <div class="d-flex align-items-center">
                                                            {% if account.type == 'twitter' %}
                                                                <i class="bi bi-twitter fs-4 me-3"></i>
                                                            {% elif account.type == 'weibo' %}
                                                                <i class="bi bi-sina-weibo fs-4 me-3"></i>
                                                            {% else %}
                                                                <i class="bi bi-globe fs-4 me-3"></i>
                                                            {% endif %}
                                                            <div>
                                                                <strong>{{ account.type }}:</strong> {{ account.account_id }}<br>
                                                                <small class="text-muted">标签: {{ account.tag or '无' }}</small>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <p class="text-danger"><strong>警告:</strong> 此操作不可撤销，账号相关的所有数据将被永久删除。</p>
                                                </div>
                                                <div class="modal-footer">
                                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                                                        <i class="bi bi-x-circle me-1"></i>取消
                                                    </button>
                                                    <form action="{{ url_for('delete_account', account_id=account.account_id) }}" method="post">
                                                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                                        <button type="submit" class="btn btn-danger">
                                                            <i class="bi bi-trash me-1"></i>确认删除
                                                        </button>
                                                    </form>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="text-center py-5">
                    <i class="bi bi-people fs-1 text-muted mb-3"></i>
                    <h5>暂无账号</h5>
                    <p class="text-muted">您还没有添加任何社交媒体账号</p>
                    <a href="{{ url_for('add_account') }}" class="btn btn-primary mt-2">
                        <i class="bi bi-plus-lg me-1"></i> 添加第一个账号
                    </a>
                </div>
                {% endif %}
            </div>

            {% if accounts %}
            <div class="card-footer bg-light">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <small class="text-muted">共 <span id="total-accounts">{{ accounts|length }}</span> 个账号</small>
                    </div>
                    <a href="{{ url_for('add_account') }}" class="btn btn-primary btn-sm">
                        <i class="bi bi-plus-lg me-1"></i> 添加账号
                    </a>
                </div>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- 账号详情侧边栏 -->
<div class="offcanvas offcanvas-end" tabindex="-1" id="accountDetailsOffcanvas" aria-labelledby="accountDetailsOffcanvasLabel">
    <div class="offcanvas-header">
        <h5 class="offcanvas-title" id="accountDetailsOffcanvasLabel">账号详情</h5>
        <button type="button" class="btn-close text-reset" data-bs-dismiss="offcanvas" aria-label="Close"></button>
    </div>
    <div class="offcanvas-body" id="account-details-content">
        <!-- 账号详情内容将通过JavaScript动态加载 -->
        <div class="d-flex justify-content-center align-items-center h-100">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">加载中...</span>
            </div>
        </div>
    </div>
</div>
<!-- 任务状态模态框 -->
<div class="modal fade" id="taskStatusModal" tabindex="-1" aria-labelledby="taskStatusModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="taskStatusModalLabel">
                    <i class="bi bi-activity me-2"></i>监控任务状态
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="关闭"></button>
            </div>
            <div class="modal-body">
                <div id="task-status-content">
                    <!-- 任务状态头部 -->
                    <div class="alert alert-primary d-flex align-items-center mb-3" id="task-status-alert">
                        <div class="spinner-border spinner-border-sm text-primary me-3" role="status" id="task-spinner">
                            <span class="visually-hidden">加载中...</span>
                        </div>
                        <div>
                            <h6 class="alert-heading mb-1">任务进行中</h6>
                            <p class="mb-0" id="task-message">正在准备任务...</p>
                        </div>
                    </div>

                    <!-- 任务进度条 -->
                    <div class="progress mb-3" id="task-progress-container" style="height: 10px; display: none;">
                        <div class="progress-bar progress-bar-striped progress-bar-animated" id="task-progress" role="progressbar" style="width: 0%"></div>
                    </div>

                    <!-- 任务详情 -->
                    <div class="row">
                        <div class="col-md-6">
                            <div class="card border-0 shadow-sm mb-3">
                                <div class="card-header bg-light">
                                    <h6 class="card-title mb-0">
                                        <i class="bi bi-info-circle me-2 text-primary"></i>任务信息
                                    </h6>
                                </div>
                                <div class="card-body">
                                    <ul class="list-group list-group-flush">
                                        <li class="list-group-item d-flex justify-content-between align-items-center px-0">
                                            <span>
                                                <i class="bi bi-check2-circle me-2 text-primary"></i>状态
                                            </span>
                                            <span class="badge bg-info" id="task-status-text">准备中</span>
                                        </li>
                                        <li class="list-group-item d-flex justify-content-between align-items-center px-0">
                                            <span>
                                                <i class="bi bi-clock me-2 text-primary"></i>开始时间
                                            </span>
                                            <span id="task-start-time">-</span>
                                        </li>
                                        <li class="list-group-item d-flex justify-content-between align-items-center px-0">
                                            <span>
                                                <i class="bi bi-hourglass-split me-2 text-primary"></i>运行时间
                                            </span>
                                            <span id="task-duration">0秒</span>
                                        </li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card border-0 shadow-sm mb-3">
                                <div class="card-header bg-light">
                                    <h6 class="card-title mb-0">
                                        <i class="bi bi-bar-chart me-2 text-primary"></i>处理统计
                                    </h6>
                                </div>
                                <div class="card-body">
                                    <div class="row text-center">
                                        <div class="col-6">
                                            <div class="p-3">
                                                <h3 class="text-primary mb-0" id="task-posts-count">0</h3>
                                                <p class="text-muted small mb-0">处理的帖子</p>
                                            </div>
                                        </div>
                                        <div class="col-6">
                                            <div class="p-3">
                                                <h3 class="text-success mb-0" id="task-relevant-count">0</h3>
                                                <p class="text-muted small mb-0">相关内容</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 任务日志 -->
                    <div class="card border-0 shadow-sm" id="task-log-container">
                        <div class="card-header bg-light">
                            <h6 class="card-title mb-0">
                                <i class="bi bi-journal-text me-2 text-primary"></i>任务日志
                            </h6>
                        </div>
                        <div class="card-body p-0">
                            <div class="list-group list-group-flush" id="task-log">
                                <div class="list-group-item">
                                    <div class="d-flex w-100 justify-content-between">
                                        <h6 class="mb-1">任务初始化</h6>
                                        <small class="text-muted" id="task-init-time">刚刚</small>
                                    </div>
                                    <p class="mb-1">系统正在准备执行监控任务...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
                    <i class="bi bi-x-circle me-1"></i>关闭
                </button>
                <a href="{{ url_for('results') }}" class="btn btn-primary" id="view-results-btn" style="display: none;">
                    <i class="bi bi-search me-1"></i>查看结果
                </a>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
    // 全局变量
    let taskStatusModal;
    let taskStatusInterval;
    let taskStartTime;
    let lastUpdateTime;
    let currentSortField = 'id';
    let currentSortDirection = 'asc';
    let activeFilters = {};

    // 初始化页面
    document.addEventListener('DOMContentLoaded', function() {
        // 初始化模态框
        taskStatusModal = new bootstrap.Modal(document.getElementById('taskStatusModal'));

        // 初始化当前时间
        lastUpdateTime = new Date();
        const taskInitTime = document.getElementById('task-init-time');
        if (taskInitTime) {
            taskInitTime.textContent = formatTime(lastUpdateTime);
        }

        // 初始化事件监听器
        initEventListeners();

        // 初始化剪贴板功能
        initClipboard();

        // 初始化排序和筛选
        initSortAndFilter();
    });

    // 初始化事件监听器
    function initEventListeners() {
        // 绑定全局抓取按钮事件
        const runAllBtn = document.getElementById('run-all-accounts-btn');
        if (runAllBtn) {
            runAllBtn.addEventListener('click', function() {
                handleRunButtonClick(this);
            });
        }

        // 绑定单个账号抓取按钮事件
        document.querySelectorAll('.run-account-btn').forEach(button => {
            button.addEventListener('click', function() {
                const accountId = this.getAttribute('data-account-id');
                handleRunButtonClick(this, accountId);
            });
        });

        // 绑定账号行点击事件 - 显示详情
        document.querySelectorAll('.account-row').forEach(row => {
            row.addEventListener('dblclick', function() {
                const accountId = this.getAttribute('data-id');
                showAccountDetails(accountId);
            });
        });
    }

    // 处理运行按钮点击
    function handleRunButtonClick(button, accountId = null) {
        // 显示加载状态
        const btnText = button.querySelector('.btn-text');
        const spinner = button.querySelector('.spinner-border');

        button.disabled = true;
        btnText.textContent = accountId ? '启动中...' : '正在启动...';
        spinner.classList.remove('d-none');

        // 运行任务
        runTask(accountId)
            .catch(error => {
                // 显示错误通知
                showToast('错误', `启动任务失败: ${error.message}`, 'danger');
            })
            .finally(() => {
                // 恢复按钮状态
                button.disabled = false;
                btnText.textContent = accountId ? '抓取' : '立即抓取所有账号';
                spinner.classList.add('d-none');
            });
    }

    // 初始化剪贴板功能
    function initClipboard() {
        document.querySelectorAll('.copy-btn').forEach(button => {
            button.addEventListener('click', function(e) {
                e.stopPropagation(); // 防止触发行点击事件

                const text = this.getAttribute('data-clipboard-text');
                navigator.clipboard.writeText(text)
                    .then(() => {
                        // 显示复制成功提示
                        const originalHTML = this.innerHTML;
                        this.innerHTML = '<i class="bi bi-check"></i>';
                        this.classList.add('btn-success');
                        this.classList.remove('btn-outline-secondary');

                        setTimeout(() => {
                            this.innerHTML = originalHTML;
                            this.classList.remove('btn-success');
                            this.classList.add('btn-outline-secondary');
                        }, 1500);

                        showToast('成功', '已复制到剪贴板', 'success');
                    })
                    .catch(err => {
                        console.error('复制失败:', err);
                        showToast('错误', '复制失败', 'danger');
                    });
            });
        });
    }

    // 初始化排序和筛选功能
    function initSortAndFilter() {
        // 排序按钮点击事件
        document.querySelectorAll('.sort-btn').forEach(button => {
            button.addEventListener('click', function() {
                const sortField = this.getAttribute('data-sort');

                // 如果点击的是当前排序字段，则切换排序方向
                if (sortField === currentSortField) {
                    currentSortDirection = currentSortDirection === 'asc' ? 'desc' : 'asc';
                } else {
                    currentSortField = sortField;
                    currentSortDirection = 'asc';
                }

                // 执行排序
                sortAccounts(currentSortField, currentSortDirection);

                // 更新排序按钮图标
                updateSortButtonIcons();
            });
        });

        // 筛选按钮点击事件
        const applyFilterBtn = document.getElementById('apply-filter-btn');
        if (applyFilterBtn) {
            applyFilterBtn.addEventListener('click', function() {
                // 收集筛选条件
                activeFilters = {
                    platform: document.getElementById('platform-filter').value,
                    tag: document.getElementById('tag-filter').value,
                    autoReply: document.getElementById('auto-reply-filter').value,
                    ai: document.getElementById('ai-filter').value
                };

                // 应用筛选
                filterAccounts();

                // 关闭筛选面板
                const filterCollapse = bootstrap.Collapse.getInstance(document.getElementById('filterOptions'));
                if (filterCollapse) {
                    filterCollapse.hide();
                }

                // 更新账号计数
                updateAccountCount();
            });
        }

        // 重置筛选按钮点击事件
        const resetFilterBtn = document.getElementById('reset-filter-btn');
        if (resetFilterBtn) {
            resetFilterBtn.addEventListener('click', function() {
                // 重置筛选表单
                document.getElementById('platform-filter').value = '';
                document.getElementById('tag-filter').value = '';
                document.getElementById('auto-reply-filter').value = '';
                document.getElementById('ai-filter').value = '';

                // 清空筛选条件
                activeFilters = {};

                // 显示所有账号
                document.querySelectorAll('.account-row').forEach(row => {
                    row.style.display = '';
                });

                // 更新账号计数
                updateAccountCount();
            });
        }
    }

    // 显示账号详情
    function showAccountDetails(accountId) {
        // 获取账号详情侧边栏
        const offcanvas = document.getElementById('accountDetailsOffcanvas');
        const contentArea = document.getElementById('account-details-content');

        if (offcanvas && contentArea) {
            // 显示加载中
            contentArea.innerHTML = `
                <div class="d-flex justify-content-center align-items-center h-100">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">加载中...</span>
                    </div>
                </div>
            `;

            // 显示侧边栏
            const bsOffcanvas = new bootstrap.Offcanvas(offcanvas);
            bsOffcanvas.show();

            // 加载账号详情
            fetch(`/api/accounts/${accountId}`)
                .then(response => {
                    // 检查响应是否成功
                    if (!response.ok) {
                        throw new Error(`服务器返回错误: ${response.status} ${response.statusText}`);
                    }
                    // 检查Content-Type是否为application/json
                    const contentType = response.headers.get('content-type');
                    if (!contentType || !contentType.includes('application/json')) {
                        throw new Error(`预期JSON响应，但收到: ${contentType}`);
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.success) {
                        // API返回的数据在data.data字段中
                        const accountData = data.data;
                        if (!accountData) {
                            throw new Error('API返回的数据格式不正确，缺少account数据');
                        }
                        console.log('账号数据:', accountData); // 调试日志
                        renderAccountDetails(accountData, contentArea);
                    } else {
                        contentArea.innerHTML = `
                            <div class="alert alert-danger">
                                <i class="bi bi-exclamation-triangle-fill me-2"></i>
                                加载账号详情失败: ${data.message || '未知错误'}
                            </div>
                        `;
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    contentArea.innerHTML = `
                        <div class="alert alert-danger">
                            <i class="bi bi-exclamation-triangle-fill me-2"></i>
                            加载账号详情失败: ${error.message}
                        </div>
                        <button class="btn btn-primary mt-3" onclick="showAccountDetails('${accountId}')">
                            <i class="bi bi-arrow-clockwise me-1"></i>重试
                        </button>
                    `;
                });
        }
    }

    // 渲染账号详情
    function renderAccountDetails(account, container) {
        if (!account || !container) return;

        // 格式化创建时间
        const createdAt = new Date(account.created_at);
        const formattedDate = createdAt.toLocaleString();

        // 设置平台图标
        let platformIcon = 'globe';
        if (account.type === 'twitter') platformIcon = 'twitter';
        else if (account.type === 'weibo') platformIcon = 'sina-weibo';

        // 渲染详情
        container.innerHTML = `
            <div class="account-details">
                <div class="text-center mb-4">
                    <div class="avatar-container mb-3">
                        <i class="bi bi-${platformIcon} fs-1 text-primary"></i>
                    </div>
                    <h4>${account.account_id}</h4>
                    <span class="badge bg-primary mb-2">${account.type}</span>
                    ${account.tag ? `<span class="badge bg-info ms-2">${account.tag}</span>` : ''}
                </div>

                <div class="card mb-3 shadow-sm">
                    <div class="card-header bg-light">
                        <h6 class="mb-0"><i class="bi bi-info-circle me-2"></i>基本信息</h6>
                    </div>
                    <div class="card-body">
                        <ul class="list-group list-group-flush">
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                <span>ID</span>
                                <span class="badge bg-secondary">${account.id}</span>
                            </li>
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                <span>平台</span>
                                <span>${account.type}</span>
                            </li>
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                <span>账号</span>
                                <div>
                                    <span class="me-2">${account.account_id}</span>
                                    <button class="btn btn-sm btn-outline-secondary copy-btn" data-clipboard-text="${account.account_id}">
                                        <i class="bi bi-clipboard"></i>
                                    </button>
                                </div>
                            </li>
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                <span>创建时间</span>
                                <span>${formattedDate}</span>
                            </li>
                        </ul>
                    </div>
                </div>

                <div class="card mb-3 shadow-sm">
                    <div class="card-header bg-light">
                        <h6 class="mb-0"><i class="bi bi-gear me-2"></i>功能设置</h6>
                    </div>
                    <div class="card-body">
                        <ul class="list-group list-group-flush">
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                <span>自动回复</span>
                                ${account.enable_auto_reply
                                    ? '<span class="badge bg-success"><i class="bi bi-check-circle me-1"></i>已启用</span>'
                                    : '<span class="badge bg-secondary"><i class="bi bi-x-circle me-1"></i>未启用</span>'}
                            </li>
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                <span>AI分析</span>
                                ${account.bypass_ai
                                    ? '<span class="badge bg-warning text-dark"><i class="bi bi-lightning me-1"></i>直接推送</span>'
                                    : '<span class="badge bg-info"><i class="bi bi-robot me-1"></i>AI分析</span>'}
                            </li>
                        </ul>
                    </div>
                </div>

                <div class="d-grid gap-2">
                    ${account.account_id ?
                      `<a href="/accounts/edit/${account.account_id}" class="btn btn-primary">
                        <i class="bi bi-pencil me-1"></i>编辑账号
                       </a>` :
                      `<button class="btn btn-secondary" disabled>
                        <i class="bi bi-pencil me-1"></i>无法编辑 (账号ID不存在)
                       </button>`
                    }
                    <button class="btn btn-success run-account-detail-btn" data-account-id="${account.account_id}">
                        <i class="bi bi-play-fill me-1"></i>抓取此账号
                    </button>
                </div>
            </div>
        `;

        // 绑定复制按钮事件
        container.querySelectorAll('.copy-btn').forEach(button => {
            button.addEventListener('click', function() {
                const text = this.getAttribute('data-clipboard-text');
                navigator.clipboard.writeText(text)
                    .then(() => {
                        const originalHTML = this.innerHTML;
                        this.innerHTML = '<i class="bi bi-check"></i>';
                        this.classList.add('btn-success');
                        this.classList.remove('btn-outline-secondary');

                        setTimeout(() => {
                            this.innerHTML = originalHTML;
                            this.classList.remove('btn-success');
                            this.classList.add('btn-outline-secondary');
                        }, 1500);
                    })
                    .catch(err => console.error('复制失败:', err));
            });
        });

        // 绑定抓取按钮事件
        container.querySelectorAll('.run-account-detail-btn').forEach(button => {
            button.addEventListener('click', function() {
                const accountId = this.getAttribute('data-account-id');
                handleRunButtonClick(this, accountId);
            });
        });
    }

    // 排序账号
    function sortAccounts(field, direction) {
        const table = document.getElementById('accounts-table');
        if (!table) return;

        const tbody = table.querySelector('tbody');
        const rows = Array.from(tbody.querySelectorAll('tr.account-row'));

        // 根据字段和方向排序
        rows.sort((a, b) => {
            let valueA, valueB;

            // 获取排序值
            if (field === 'id') {
                valueA = parseInt(a.getAttribute('data-id'));
                valueB = parseInt(b.getAttribute('data-id'));
            } else if (field === 'platform') {
                valueA = a.getAttribute('data-platform');
                valueB = b.getAttribute('data-platform');
            } else if (field === 'account') {
                valueA = a.getAttribute('data-account');
                valueB = b.getAttribute('data-account');
            } else if (field === 'created') {
                valueA = parseFloat(a.getAttribute('data-created'));
                valueB = parseFloat(b.getAttribute('data-created'));
            }

            // 比较
            if (valueA === valueB) return 0;

            // 根据排序方向返回结果
            const result = valueA < valueB ? -1 : 1;
            return direction === 'asc' ? result : -result;
        });

        // 重新排列行
        rows.forEach(row => tbody.appendChild(row));
    }

    // 更新排序按钮图标
    function updateSortButtonIcons() {
        document.querySelectorAll('.sort-btn').forEach(button => {
            const field = button.getAttribute('data-sort');
            const icon = button.querySelector('i');

            if (field === currentSortField) {
                icon.className = currentSortDirection === 'asc'
                    ? 'bi bi-arrow-down'
                    : 'bi bi-arrow-up';
            } else {
                icon.className = 'bi bi-arrow-down-up';
            }
        });
    }

    // 筛选账号
    function filterAccounts() {
        const rows = document.querySelectorAll('.account-row');

        rows.forEach(row => {
            let visible = true;

            // 检查每个筛选条件
            if (activeFilters.platform && row.getAttribute('data-platform') !== activeFilters.platform) {
                visible = false;
            }

            if (activeFilters.tag && row.getAttribute('data-tag') !== activeFilters.tag) {
                visible = false;
            }

            if (activeFilters.autoReply && row.getAttribute('data-auto-reply') !== activeFilters.autoReply) {
                visible = false;
            }

            if (activeFilters.ai && row.getAttribute('data-ai') !== activeFilters.ai) {
                visible = false;
            }

            // 设置行的可见性
            row.style.display = visible ? '' : 'none';
        });
    }

    // 更新账号计数
    function updateAccountCount() {
        const totalElement = document.getElementById('total-accounts');
        if (!totalElement) return;

        // 计算可见行数
        const visibleRows = document.querySelectorAll('.account-row[style=""],.account-row:not([style])').length;
        totalElement.textContent = visibleRows;
    }

    // 显示提示消息
    function showToast(title, message, type = 'info') {
        // 检查是否已存在toast容器
        let toastContainer = document.querySelector('.toast-container');

        // 如果不存在，创建一个
        if (!toastContainer) {
            toastContainer = document.createElement('div');
            toastContainer.className = 'toast-container position-fixed bottom-0 end-0 p-3';
            document.body.appendChild(toastContainer);
        }

        // 创建toast元素
        const toastId = 'toast-' + Date.now();
        const toastHTML = `
            <div id="${toastId}" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
                <div class="toast-header bg-${type} text-white">
                    <strong class="me-auto">${title}</strong>
                    <small>刚刚</small>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast" aria-label="Close"></button>
                </div>
                <div class="toast-body">
                    ${message}
                </div>
            </div>
        `;

        // 添加到容器
        toastContainer.insertAdjacentHTML('beforeend', toastHTML);

        // 初始化并显示toast
        const toastElement = document.getElementById(toastId);
        const toast = new bootstrap.Toast(toastElement, { delay: 3000 });
        toast.show();

        // 自动移除
        toastElement.addEventListener('hidden.bs.toast', function() {
            toastElement.remove();
        });
    }

    // 格式化时间
    function formatTime(date) {
        if (!date) return '未知';

        const now = new Date();
        const diff = Math.floor((now - date) / 1000);

        if (diff < 60) return '刚刚';
        if (diff < 3600) return `${Math.floor(diff / 60)}分钟前`;
        if (diff < 86400) return `${Math.floor(diff / 3600)}小时前`;

        return date.toLocaleString();
    }

    // 运行任务函数
    function runTask(accountId = null) {
        return new Promise((resolve, reject) => {
            // 重置模态框状态
            resetTaskModal();

            // 显示模态框
            taskStatusModal.show();

            // 准备请求数据
            const requestData = {};
            if (accountId) {
                requestData.account_id = accountId;
                updateTaskMessage(`正在抓取账号: ${accountId}`);
                addTaskLogEntry('开始任务', `开始抓取账号: ${accountId}`);
            } else {
                updateTaskMessage('正在抓取所有账号');
                addTaskLogEntry('开始任务', '开始抓取所有监控账号');
            }

            // 发送请求启动任务
            fetch('/api/tasks/run', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(requestData),
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP错误: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    // 记录开始时间
                    taskStartTime = new Date();

                    // 更新状态警报
                    updateTaskAlert('进行中', 'primary');

                    // 更新状态
                    updateTaskStatus(data.status);

                    // 添加日志条目
                    addTaskLogEntry('任务启动', '监控任务已成功启动');

                    // 启动定时查询状态
                    taskStatusInterval = setInterval(checkTaskStatus, 1000);

                    // 显示进度条
                    const progressContainer = document.getElementById('task-progress-container');
                    if (progressContainer) {
                        progressContainer.style.display = 'block';
                    }

                    // 解析Promise
                    resolve(data);
                } else {
                    // 显示错误
                    updateTaskAlert('失败', 'danger');
                    updateTaskMessage(`启动任务失败: ${data.message}`);
                    updateTaskStatusBadge('失败', 'danger');
                    hideTaskSpinner();

                    // 添加日志条目
                    addTaskLogEntry('启动失败', `任务启动失败: ${data.message}`, 'danger');

                    // 拒绝Promise
                    reject(new Error(data.message));
                }
            })
            .catch(error => {
                console.error('Error:', error);
                updateTaskAlert('错误', 'danger');
                updateTaskMessage(`请求错误: ${error.message}`);
                updateTaskStatusBadge('错误', 'danger');
                hideTaskSpinner();

                // 添加日志条目
                addTaskLogEntry('系统错误', `请求错误: ${error.message}`, 'danger');

                // 拒绝Promise
                reject(error);
            });
        });
    }

    // 查询任务状态
    function checkTaskStatus() {
        fetch('/api/tasks/status')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                updateTaskStatus(data.status);

                // 如果任务已完成，停止查询
                if (!data.status.is_running) {
                    taskCompleted(data.status);
                }
            }
        })
        .catch(error => {
            console.error('Error:', error);
            clearInterval(taskStatusInterval);
            hideTaskSpinner();
            updateTaskMessage(`获取状态失败: ${error.message}`);
            updateTaskAlert('错误', 'danger');

            // 添加日志条目
            addTaskLogEntry('状态查询失败', `获取任务状态失败: ${error.message}`, 'danger');
        });
    }

    // 任务完成处理
    function taskCompleted(status) {
        clearInterval(taskStatusInterval);
        hideTaskSpinner();

        // 显示查看结果按钮
        document.getElementById('view-results-btn').style.display = 'block';

        // 更新状态警报
        if (status.status === 'completed') {
            updateTaskAlert('完成', 'success');
            addTaskLogEntry('任务完成', `任务已成功完成，处理了 ${status.total_posts} 条内容，发现 ${status.relevant_posts} 条相关内容`, 'success');
        } else {
            updateTaskAlert('失败', 'danger');
            addTaskLogEntry('任务失败', `任务执行失败: ${status.message}`, 'danger');
        }

        // 更新进度条
        const progressBar = document.getElementById('task-progress');
        if (progressBar) {
            progressBar.style.width = '100%';
            if (status.status === 'completed') {
                progressBar.className = 'progress-bar bg-success';
            } else {
                progressBar.className = 'progress-bar bg-danger';
            }
        }
    }

    // 更新任务状态显示
    function updateTaskStatus(status) {
        if (!status) return;

        // 更新消息
        updateTaskMessage(status.message);

        // 更新状态徽章
        updateTaskStatusBadge(status.status);

        // 更新计数
        document.getElementById('task-posts-count').textContent = status.total_posts || 0;
        document.getElementById('task-relevant-count').textContent = status.relevant_posts || 0;

        // 更新时间信息
        if (status.start_time) {
            const startTime = new Date(status.start_time * 1000);
            document.getElementById('task-start-time').textContent = startTime.toLocaleString();

            // 计算运行时间
            const now = status.is_running ? new Date() : new Date(status.end_time * 1000);
            const durationSec = Math.floor((now - startTime) / 1000);
            document.getElementById('task-duration').textContent = formatDuration(durationSec);

            // 更新进度条
            if (status.progress && status.progress > 0) {
                const progressBar = document.getElementById('task-progress');
                if (progressBar) {
                    progressBar.style.width = `${Math.min(status.progress, 100)}%`;
                }
            }
        }

        // 如果有新消息，添加到日志
        if (status.message && status.message !== document.getElementById('task-message').textContent) {
            addTaskLogEntry('状态更新', status.message);
        }
    }

    // 更新任务消息
    function updateTaskMessage(message) {
        const messageEl = document.getElementById('task-message');
        if (messageEl && message) {
            messageEl.textContent = message;
        }
    }

    // 更新任务状态徽章
    function updateTaskStatusBadge(status, forceClass = null) {
        const statusText = document.getElementById('task-status-text');
        if (!statusText) return;

        statusText.textContent = status;

        // 设置徽章样式
        let badgeClass = 'bg-info';

        if (forceClass) {
            badgeClass = `bg-${forceClass}`;
        } else if (status === 'running') {
            badgeClass = 'bg-primary';
        } else if (status === 'completed') {
            badgeClass = 'bg-success';
        } else if (status === 'failed') {
            badgeClass = 'bg-danger';
        }

        statusText.className = `badge ${badgeClass}`;
    }

    // 更新任务警报
    function updateTaskAlert(title, type) {
        const alertEl = document.getElementById('task-status-alert');
        const titleEl = alertEl.querySelector('.alert-heading');

        if (alertEl && titleEl) {
            alertEl.className = `alert alert-${type} d-flex align-items-center mb-3`;
            titleEl.textContent = `任务${title}`;
        }
    }

    // 隐藏任务加载动画
    function hideTaskSpinner() {
        const spinner = document.getElementById('task-spinner');
        if (spinner) {
            spinner.style.display = 'none';
        }
    }

    // 添加任务日志条目
    function addTaskLogEntry(title, message, type = 'info') {
        const logContainer = document.getElementById('task-log');
        if (!logContainer) return;

        // 创建日志条目
        const entry = document.createElement('div');
        entry.className = 'list-group-item';

        // 设置条目样式
        if (type === 'danger') {
            entry.classList.add('list-group-item-danger');
        } else if (type === 'success') {
            entry.classList.add('list-group-item-success');
        } else if (type === 'warning') {
            entry.classList.add('list-group-item-warning');
        }

        // 设置条目内容
        const now = new Date();
        entry.innerHTML = `
            <div class="d-flex w-100 justify-content-between">
                <h6 class="mb-1">${title}</h6>
                <small class="text-muted">${now.toLocaleTimeString()}</small>
            </div>
            <p class="mb-1">${message}</p>
        `;

        // 添加到日志容器的顶部
        logContainer.insertBefore(entry, logContainer.firstChild);
    }

    // 格式化持续时间
    function formatDuration(seconds) {
        if (seconds < 60) {
            return `${seconds}秒`;
        } else if (seconds < 3600) {
            const minutes = Math.floor(seconds / 60);
            const remainingSeconds = seconds % 60;
            return `${minutes}分${remainingSeconds}秒`;
        } else {
            const hours = Math.floor(seconds / 3600);
            const minutes = Math.floor((seconds % 3600) / 60);
            return `${hours}小时${minutes}分`;
        }
    }

    // 重置模态框状态
    function resetTaskModal() {
        // 清除之前的定时器
        if (taskStatusInterval) {
            clearInterval(taskStatusInterval);
        }

        // 重置显示
        document.getElementById('task-spinner').style.display = 'inline-block';
        document.getElementById('task-message').textContent = '正在准备任务...';
        updateTaskStatusBadge('准备中', 'info');
        document.getElementById('task-posts-count').textContent = '0';
        document.getElementById('task-relevant-count').textContent = '0';
        document.getElementById('task-start-time').textContent = '-';
        document.getElementById('task-duration').textContent = '0秒';
        document.getElementById('view-results-btn').style.display = 'none';

        // 重置进度条
        const progressBar = document.getElementById('task-progress');
        const progressContainer = document.getElementById('task-progress-container');
        if (progressBar && progressContainer) {
            progressBar.style.width = '0%';
            progressBar.className = 'progress-bar progress-bar-striped progress-bar-animated';
            progressContainer.style.display = 'none';
        }

        // 重置警报
        updateTaskAlert('进行中', 'primary');

        // 重置日志
        const logContainer = document.getElementById('task-log');
        if (logContainer) {
            logContainer.innerHTML = `
                <div class="list-group-item">
                    <div class="d-flex w-100 justify-content-between">
                        <h6 class="mb-1">任务初始化</h6>
                        <small class="text-muted">${new Date().toLocaleTimeString()}</small>
                    </div>
                    <p class="mb-1">系统正在准备执行监控任务...</p>
                </div>
            `;
        }
    }

    // 添加CSS动画
    const style = document.createElement('style');
    style.textContent = `
        @keyframes rotate {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        .rotate-animation {
            animation: rotate 1s linear;
        }
    `;
    document.head.appendChild(style);
</script>
{% endblock %}