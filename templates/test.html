{% extends 'base.html' %}

{% block title %}系统测试与诊断 - TweetAnalyst{% endblock %}

{% block extra_css %}
<style>
    /* 系统状态卡片样式 */
    .status-card {
        transition: all 0.3s ease;
        border-radius: 0.5rem;
        box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
        height: 100%;
    }

    .status-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
    }

    .status-card .card-header {
        border-radius: 0.5rem 0.5rem 0 0;
        font-weight: 600;
    }

    .status-badge {
        font-size: 0.85rem;
        padding: 0.35rem 0.65rem;
        transition: all 0.3s ease;
    }

    /* 组件状态指示器 */
    .component-status {
        padding: 0.75rem;
        border-radius: 0.5rem;
        margin-bottom: 0.75rem;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        justify-content: space-between;
    }

    .component-status:hover {
        transform: translateX(5px);
    }

    .component-status .status-icon {
        font-size: 1.5rem;
        margin-right: 1rem;
    }

    .component-status .status-text {
        font-weight: 500;
    }

    /* 测试按钮样式 */
    .test-btn {
        transition: all 0.3s ease;
        border-radius: 0.5rem;
        position: relative;
        overflow: hidden;
    }

    .test-btn:hover {
        transform: translateY(-2px);
    }

    .test-btn::after {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(255, 255, 255, 0.1);
        transform: translateX(-100%);
        transition: transform 0.5s ease;
    }

    .test-btn:hover::after {
        transform: translateX(0);
    }

    /* 测试结果区域 */
    .test-result {
        border-radius: 0.5rem;
        transition: all 0.3s ease;
        max-height: 0;
        overflow: hidden;
        opacity: 0;
    }

    .test-result.show {
        max-height: 1000px;
        opacity: 1;
        margin-top: 1rem;
    }

    /* 维护操作卡片 */
    .maintenance-card {
        border-radius: 0.5rem;
        transition: all 0.3s ease;
        overflow: hidden;
    }

    .maintenance-card:hover {
        transform: translateY(-3px);
        box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
    }

    .maintenance-card .card-header {
        font-weight: 600;
    }

    .maintenance-btn {
        transition: all 0.3s ease;
        border-radius: 0.4rem;
    }

    .maintenance-btn:hover {
        transform: translateY(-2px);
    }

    /* 进度条样式 */
    .progress {
        height: 0.5rem;
        border-radius: 1rem;
        overflow: hidden;
    }

    /* 动画效果 */
    @keyframes pulse {
        0% { transform: scale(1); }
        50% { transform: scale(1.05); }
        100% { transform: scale(1); }
    }

    .pulse {
        animation: pulse 2s infinite;
    }

    /* 响应式调整 */
    @media (max-width: 768px) {
        .status-card {
            margin-bottom: 1rem;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="container py-4">
    <!-- 页面标题和面包屑导航 -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb mb-0">
                    <li class="breadcrumb-item"><a href="{{ url_for('index') }}">首页</a></li>
                    <li class="breadcrumb-item active" aria-current="page">系统测试与诊断</li>
                </ol>
            </nav>
            <h2 class="mt-2"><i class="bi bi-speedometer2 text-primary me-2"></i>系统测试与诊断</h2>
        </div>
        <div>
            <a href="{{ url_for('unified_settings') }}" class="btn btn-outline-primary">
                <i class="bi bi-gear me-1"></i>系统设置
            </a>
        </div>
    </div>

    <!-- 系统状态概览 -->
    <div class="row mb-4">
        <!-- 系统信息卡片 -->
        <div class="col-md-4 mb-4">
            <div class="card status-card border-primary border-opacity-50 h-100">
                <div class="card-header bg-primary bg-opacity-10 text-primary">
                    <i class="bi bi-info-circle me-2"></i>系统信息
                </div>
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <span class="fw-medium">版本</span>
                        <span class="badge bg-primary status-badge">{{ system_status.system.version }}</span>
                    </div>
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <span class="fw-medium">运行时间</span>
                        <span class="badge bg-primary status-badge">{{ system_status.system.uptime }}</span>
                    </div>
                    <div class="d-flex justify-content-between align-items-center">
                        <span class="fw-medium">平台</span>
                        <span class="badge bg-secondary status-badge">{{ system_status.system.platform }}</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- 配置信息卡片 -->
        <div class="col-md-4 mb-4">
            <div class="card status-card border-info border-opacity-50 h-100">
                <div class="card-header bg-info bg-opacity-10 text-info">
                    <i class="bi bi-gear me-2"></i>配置信息
                </div>
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <span class="fw-medium">LLM模型</span>
                        <span class="badge bg-info status-badge">{{ system_status.config.llm_model }}</span>
                    </div>
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <span class="fw-medium">定时任务间隔</span>
                        <span class="badge bg-info status-badge">{{ system_status.config.scheduler_interval }}分钟</span>
                    </div>
                    <div class="d-flex justify-content-between align-items-center">
                        <span class="fw-medium">代理设置</span>
                        <span class="badge bg-secondary status-badge text-truncate" style="max-width: 200px;" title="{{ system_status.config.proxy }}">{{ system_status.config.proxy }}</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- 组件状态卡片 -->
        <div class="col-md-4 mb-4">
            <div class="card status-card border-success border-opacity-50 h-100">
                <div class="card-header bg-success bg-opacity-10 text-success">
                    <i class="bi bi-hdd-stack me-2"></i>组件状态
                </div>
                <div class="card-body p-3">
                    <div class="component-status bg-light" id="twitter-component-status">
                        <div class="d-flex align-items-center">
                            <i class="bi bi-twitter status-icon text-primary"></i>
                            <span class="status-text">Twitter API</span>
                        </div>
                        <span id="twitter-status" class="badge bg-secondary">{{ system_status.components.twitter_api.status }}</span>
                    </div>

                    <div class="component-status bg-light" id="llm-component-status">
                        <div class="d-flex align-items-center">
                            <i class="bi bi-cpu status-icon text-info"></i>
                            <span class="status-text">LLM API</span>
                        </div>
                        <span id="llm-status" class="badge bg-secondary">{{ system_status.components.llm_api.status }}</span>
                    </div>

                    <div class="component-status bg-light" id="proxy-component-status">
                        <div class="d-flex align-items-center">
                            <i class="bi bi-globe status-icon text-success"></i>
                            <span class="status-text">代理</span>
                        </div>
                        <span id="proxy-status" class="badge bg-secondary">{{ system_status.components.proxy.status }}</span>
                    </div>

                    <div class="component-status bg-light" id="notification-component-status">
                        <div class="d-flex align-items-center">
                            <i class="bi bi-bell status-icon text-danger"></i>
                            <span class="status-text">推送功能</span>
                        </div>
                        <span id="notification-status" class="badge bg-secondary">{{ system_status.components.notification.status if system_status.components.notification else '未配置' }}</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 系统诊断和快速操作 -->
    <div class="row">
        <!-- 系统诊断卡片 -->
        <div class="col-lg-6 mb-4">
            <div class="card status-card border-primary border-opacity-50">
                <div class="card-header bg-primary bg-opacity-10 text-primary d-flex justify-content-between align-items-center">
                    <div>
                        <i class="bi bi-lightning-charge me-2"></i>系统诊断
                    </div>
                    <button type="button" class="btn btn-sm btn-primary" id="test-all-btn">
                        <i class="bi bi-lightning-charge-fill me-1"></i>一键诊断所有组件
                    </button>
                </div>
                <div class="card-body">
                    <!-- 测试按钮组 -->
                    <div class="row g-3 mb-3">
                        <div class="col-md-3">
                            <button type="button" class="btn btn-outline-primary w-100 test-btn" id="test-twitter-btn">
                                <i class="bi bi-twitter me-1"></i>测试Twitter
                                <span class="badge bg-secondary ms-1" id="twitter-test-badge">未测试</span>
                            </button>
                        </div>
                        <div class="col-md-3">
                            <button type="button" class="btn btn-outline-info w-100 test-btn" id="test-llm-btn">
                                <i class="bi bi-cpu me-1"></i>测试LLM API
                                <span class="badge bg-secondary ms-1" id="llm-test-badge">未测试</span>
                            </button>
                        </div>
                        <div class="col-md-3">
                            <button type="button" class="btn btn-outline-success w-100 test-btn" id="test-proxy-btn">
                                <i class="bi bi-globe me-1"></i>测试代理
                                <span class="badge bg-secondary ms-1" id="proxy-test-badge">未测试</span>
                            </button>
                        </div>
                        <div class="col-md-3">
                            <button type="button" class="btn btn-outline-danger w-100 test-btn" id="test-notification-btn">
                                <i class="bi bi-bell me-1"></i>测试推送
                                <span class="badge bg-secondary ms-1" id="notification-test-badge">未测试</span>
                            </button>
                        </div>
                    </div>

                    <!-- 系统推送测试区域 -->
                    <div class="card bg-light mb-3">
                        <div class="card-body">
                            <h6 class="card-title">
                                <i class="bi bi-bell-fill me-2 text-danger"></i>系统推送测试
                            </h6>
                            <div class="row g-2">
                                <div class="col-md-8">
                                    <div class="input-group">
                                        <span class="input-group-text"><i class="bi bi-chat-text"></i></span>
                                        <input type="text" class="form-control" id="notification-message" placeholder="输入测试消息内容" value="这是一条测试推送消息">
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <button type="button" class="btn btn-danger w-100" id="send-notification-btn">
                                        <i class="bi bi-send me-1"></i>发送测试消息
                                    </button>
                                </div>
                            </div>
                            <div class="form-text mt-1">
                                <i class="bi bi-info-circle me-1"></i>测试消息将发送到系统设置中配置的所有推送渠道
                            </div>
                        </div>
                    </div>

                    <!-- 测试结果区域 -->
                    <div id="test-result" class="alert d-none test-result" style="border: 2px solid; font-weight: 500;"></div>
                </div>
            </div>
        </div>

        <!-- 快速操作卡片 -->
        <div class="col-lg-6 mb-4">
            <div class="card status-card border-success border-opacity-50">
                <div class="card-header bg-success bg-opacity-10 text-success">
                    <i class="bi bi-lightning me-2"></i>快速操作
                </div>
                <div class="card-body">
                    <div class="row g-3">
                        <!-- 监控任务操作 -->
                        <div class="col-md-6">
                            <div class="card h-100 maintenance-card bg-light">
                                <div class="card-body">
                                    <h6 class="card-title text-primary mb-3">
                                        <i class="bi bi-play-circle me-2"></i>监控任务
                                    </h6>
                                    <div class="d-grid gap-2">
                                        <button type="button" class="btn btn-success maintenance-btn" id="run-task-btn">
                                            <i class="bi bi-play-fill me-1"></i>立即执行监控任务
                                        </button>
                                        <button type="button" class="btn btn-warning maintenance-btn" id="run-task-reset-btn">
                                            <i class="bi bi-arrow-repeat me-1"></i>重置记录并执行
                                        </button>
                                        <button type="button" class="btn btn-info maintenance-btn" id="run-timeline-btn">
                                            <i class="bi bi-people-fill me-1"></i>获取时间线推文
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- 系统管理操作 -->
                        <div class="col-md-6">
                            <div class="card h-100 maintenance-card bg-light">
                                <div class="card-body">
                                    <h6 class="card-title text-primary mb-3">
                                        <i class="bi bi-gear-wide-connected me-2"></i>系统管理
                                    </h6>
                                    <div class="d-grid gap-2">
                                        <a href="/accounts" class="btn btn-primary maintenance-btn">
                                            <i class="bi bi-person-badge me-1"></i>管理监控账号
                                        </a>
                                        <a href="/unified_settings" class="btn btn-info maintenance-btn">
                                            <i class="bi bi-gear me-1"></i>系统设置
                                        </a>
                                        <a href="/results" class="btn btn-secondary maintenance-btn">
                                            <i class="bi bi-list-check me-1"></i>查看分析结果
                                        </a>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 系统提示信息 -->
                    <div class="alert alert-info mt-3 mb-0">
                        <div class="d-flex">
                            <div class="flex-shrink-0">
                                <i class="bi bi-info-circle-fill fs-4"></i>
                            </div>
                            <div class="flex-grow-1 ms-3">
                                <h6 class="alert-heading">系统提示</h6>
                                <ul class="mb-0 ps-3">
                                    <li>定时任务每 <strong>{{ system_status.config.scheduler_interval }}分钟</strong> 自动执行一次</li>
                                    <li>当前使用的LLM模型: <strong>{{ system_status.config.llm_model }}</strong></li>
                                    <li>如需更改设置，请前往 <a href="/unified_settings" class="alert-link">统一设置中心</a></li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 系统维护操作 -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card status-card border-danger border-opacity-50">
                <div class="card-header bg-danger bg-opacity-10 text-danger">
                    <i class="bi bi-exclamation-triangle me-2"></i>系统维护操作
                </div>
                <div class="card-body">
                    <!-- 警告提示 -->
                    <div class="alert alert-warning mb-4">
                        <div class="d-flex">
                            <div class="flex-shrink-0">
                                <i class="bi bi-exclamation-triangle-fill fs-4"></i>
                            </div>
                            <div class="flex-grow-1 ms-3">
                                <h5 class="alert-heading">警告</h5>
                                <p>以下操作可能会删除数据，请谨慎操作。建议在执行前先备份重要数据。</p>
                            </div>
                        </div>
                    </div>

                    <div class="row g-4">
                        <!-- 数据库维护 -->
                        <div class="col-md-6">
                            <div class="card maintenance-card border-danger">
                                <div class="card-header bg-danger bg-opacity-10 text-danger">
                                    <i class="bi bi-database me-2"></i>数据库维护
                                </div>
                                <div class="card-body">
                                    <div class="mb-3">
                                        <button type="button" class="btn btn-outline-danger w-100 maintenance-btn" id="clean-db-btn">
                                            <i class="bi bi-database-x me-1"></i>清理数据库
                                        </button>
                                        <small class="text-muted d-block mt-1">按时间或数量清理旧数据，支持多种清理策略</small>
                                    </div>
                                    <div class="mb-3">
                                        <button type="button" class="btn btn-outline-danger w-100 maintenance-btn" id="clean-by-count-btn">
                                            <i class="bi bi-123 me-1"></i>按数量清理
                                        </button>
                                        <small class="text-muted d-block mt-1">每个账号保留最新的N条记录，删除多余的旧记录</small>
                                    </div>
                                    <div>
                                        <button type="button" class="btn btn-outline-danger w-100 maintenance-btn" id="truncate-db-btn">
                                            <i class="bi bi-trash me-1"></i>清空所有数据
                                        </button>
                                        <small class="text-muted d-block mt-1">删除所有分析结果数据，谨慎操作！</small>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- 日志维护 -->
                        <div class="col-md-6">
                            <div class="card maintenance-card border-danger">
                                <div class="card-header bg-danger bg-opacity-10 text-danger">
                                    <i class="bi bi-journal-text me-2"></i>日志维护
                                </div>
                                <div class="card-body">
                                    <div class="mb-3">
                                        <button type="button" class="btn btn-outline-danger w-100 maintenance-btn" id="clean-logs-btn">
                                            <i class="bi bi-journal-x me-1"></i>清理日志文件
                                        </button>
                                        <small class="text-muted d-block mt-1">清空所有日志文件内容，但保留文件</small>
                                    </div>
                                    <div class="mb-3">
                                        <button type="button" class="btn btn-outline-danger w-100 maintenance-btn" id="backup-logs-btn">
                                            <i class="bi bi-journal-arrow-down me-1"></i>备份并清空日志
                                        </button>
                                        <small class="text-muted d-block mt-1">先备份日志文件，然后清空内容</small>
                                    </div>
                                    <div>
                                        <button type="button" class="btn btn-outline-danger w-100 maintenance-btn" id="delete-logs-btn">
                                            <i class="bi bi-trash me-1"></i>删除所有日志
                                        </button>
                                        <small class="text-muted d-block mt-1">删除所有日志文件，谨慎操作！</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>


</div>
{% endblock %}

{% block scripts %}
<script>
    // 全局变量
    const resultDiv = document.getElementById('test-result');

    // 页面加载完成后初始化
    document.addEventListener('DOMContentLoaded', function() {
        // 初始化组件状态样式
        updateComponentStatusStyles();

        // 添加事件监听器
        document.getElementById('test-twitter-btn').addEventListener('click', testTwitter);
        document.getElementById('test-llm-btn').addEventListener('click', testLLM);
        document.getElementById('test-proxy-btn').addEventListener('click', testProxy);
        document.getElementById('test-notification-btn').addEventListener('click', testNotification);
        document.getElementById('send-notification-btn').addEventListener('click', sendNotificationMessage);
        document.getElementById('test-all-btn').addEventListener('click', testAll);
    });

    // 更新组件状态样式
    function updateComponentStatusStyles() {
        const components = [
            { id: 'twitter-status', container: 'twitter-component-status', icon: 'twitter' },
            { id: 'llm-status', container: 'llm-component-status', icon: 'cpu' },
            { id: 'proxy-status', container: 'proxy-component-status', icon: 'globe' },
            { id: 'notification-status', container: 'notification-component-status', icon: 'bell' }
        ];

        components.forEach(component => {
            const statusBadge = document.getElementById(component.id);
            const container = document.getElementById(component.container);

            if (statusBadge && container) {
                const status = statusBadge.textContent.trim();

                if (status === '正常') {
                    statusBadge.className = 'badge bg-success';
                    container.classList.add('bg-success', 'bg-opacity-10');
                    container.classList.remove('bg-light', 'bg-danger', 'bg-opacity-10');
                } else if (status === '异常') {
                    statusBadge.className = 'badge bg-danger';
                    container.classList.add('bg-danger', 'bg-opacity-10');
                    container.classList.remove('bg-light', 'bg-success', 'bg-opacity-10');
                } else {
                    statusBadge.className = 'badge bg-secondary';
                }
            }
        });
    }

    // 显示测试结果
    function showTestResult(isVisible = true) {
        if (isVisible) {
            resultDiv.classList.remove('d-none');
            resultDiv.classList.add('show');

            // 滚动到结果区域
            setTimeout(() => {
                resultDiv.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            }, 300);
        } else {
            resultDiv.classList.remove('show');
            setTimeout(() => {
                resultDiv.classList.add('d-none');
            }, 300);
        }
    }

    // 测试Twitter连接
    function testTwitter() {
        const badge = document.getElementById('twitter-test-badge');
        const statusBadge = document.getElementById('twitter-status');
        const container = document.getElementById('twitter-component-status');

        // 更新状态
        badge.textContent = '测试中...';
        badge.className = 'badge bg-info ms-1';

        // 显示结果区域
        resultDiv.className = 'alert alert-info test-result';
        resultDiv.innerHTML = `
            <div class="d-flex align-items-center mb-3">
                <div class="spinner-border text-info me-3" role="status">
                    <span class="visually-hidden">加载中...</span>
                </div>
                <div>
                    <h5 class="mb-1">正在测试Twitter连接...</h5>
                    <p class="mb-0 text-muted">正在连接Twitter API，请稍候...</p>
                </div>
            </div>
            <div class="progress mt-2" style="height: 6px;">
                <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 100%"></div>
            </div>
        `;
        showTestResult();

        // 发送请求
        return fetch('/api/test/twitter', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({}),
        })
        .then(response => response.json())
        .then(data => {
            // 更新状态标签
            if (data.success) {
                badge.textContent = '正常';
                badge.className = 'badge bg-success ms-1';

                statusBadge.textContent = '正常';
                statusBadge.className = 'badge bg-success';

                container.classList.add('bg-success', 'bg-opacity-10');
                container.classList.remove('bg-light', 'bg-danger', 'bg-opacity-10');

                resultDiv.className = 'alert alert-success test-result';

                let resultHtml = `
                    <div class="d-flex">
                        <div class="flex-shrink-0">
                            <i class="bi bi-check-circle-fill text-success fs-1"></i>
                        </div>
                        <div class="flex-grow-1 ms-3">
                            <h5 class="alert-heading">Twitter连接测试成功</h5>
                            <p>${data.message}</p>
                `;

                if (data.data) {
                    resultHtml += '<ul class="mb-0">';
                    if (data.data.account_id) resultHtml += `<li>账号ID: <strong>${data.data.account_id}</strong></li>`;
                    if (data.data.post_count) resultHtml += `<li>获取推文数: <strong>${data.data.post_count}</strong></li>`;
                    if (data.data.response_time) resultHtml += `<li>响应时间: <strong>${data.data.response_time}</strong></li>`;
                    resultHtml += '</ul>';
                }

                resultHtml += `
                        </div>
                    </div>
                `;
                resultDiv.innerHTML = resultHtml;
            } else {
                badge.textContent = '异常';
                badge.className = 'badge bg-danger ms-1';

                statusBadge.textContent = '异常';
                statusBadge.className = 'badge bg-danger';

                container.classList.add('bg-danger', 'bg-opacity-10');
                container.classList.remove('bg-light', 'bg-success', 'bg-opacity-10');

                resultDiv.className = 'alert alert-danger test-result';

                let failureHtml = `
                    <div class="d-flex">
                        <div class="flex-shrink-0">
                            <i class="bi bi-x-circle-fill text-danger fs-1"></i>
                        </div>
                        <div class="flex-grow-1 ms-3">
                            <h5 class="alert-heading">Twitter连接测试失败</h5>
                            <p>${data.message}</p>

                            <div class="mt-3 p-3 bg-light border-start border-warning border-4 rounded">
                                <h6 class="mb-2"><i class="bi bi-lightbulb-fill text-warning me-2"></i>可能的解决方案：</h6>
                                <ul class="mb-0">
                                    <li>检查网络连接是否正常</li>
                                    <li>确认Twitter账号ID是否正确</li>
                                    <li>检查代理设置是否正确</li>
                                    <li>尝试使用不同的Twitter账号</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                `;

                resultDiv.innerHTML = failureHtml;
            }
            return data.success;
        })
        .catch(error => {
            console.error('Error:', error);

            badge.textContent = '错误';
            badge.className = 'badge bg-danger ms-1';

            statusBadge.textContent = '异常';
            statusBadge.className = 'badge bg-danger';

            container.classList.add('bg-danger', 'bg-opacity-10');
            container.classList.remove('bg-light', 'bg-success', 'bg-opacity-10');

            resultDiv.className = 'alert alert-danger test-result';
            resultDiv.innerHTML = `
                <div class="d-flex">
                    <div class="flex-shrink-0">
                        <i class="bi bi-exclamation-triangle-fill text-warning fs-1"></i>
                    </div>
                    <div class="flex-grow-1 ms-3">
                        <h5 class="alert-heading">Twitter连接请求错误</h5>
                        <p>${error.message}</p>

                        <div class="mt-3 p-3 bg-light rounded">
                            <h6 class="mb-2">调试信息:</h6>
                            <ul class="mb-0">
                                <li>请求URL: /api/test/twitter</li>
                                <li>请求方法: POST</li>
                            </ul>
                        </div>
                    </div>
                </div>
            `;
            return false;
        });
    }

    // 测试LLM API连接
    function testLLM() {
        const badge = document.getElementById('llm-test-badge');
        const statusBadge = document.getElementById('llm-status');

        // 更新状态
        badge.textContent = '测试中...';
        badge.classList.remove('bg-secondary', 'bg-success', 'bg-danger');
        badge.classList.add('bg-info');

        // 显示结果区域
        resultDiv.classList.remove('d-none', 'alert-success', 'alert-danger');
        resultDiv.classList.add('alert-info');
        resultDiv.innerHTML = '<h5><i class="bi bi-hourglass-split text-info"></i> 正在测试LLM API连接...</h5><p>正在连接LLM API，请稍候...</p><div class="progress mt-2"><div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 100%"></div></div>';

        // 发送请求
        return fetch('/api/test/llm', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({}),
        })
        .then(response => response.json())
        .then(data => {
            // 更新状态标签
            if (data.success) {
                badge.textContent = '正常';
                badge.classList.remove('bg-info', 'bg-secondary', 'bg-danger');
                badge.classList.add('bg-success');

                statusBadge.textContent = '正常';
                statusBadge.classList.remove('bg-secondary', 'bg-danger');
                statusBadge.classList.add('bg-success');

                resultDiv.classList.remove('alert-danger', 'alert-info');
                resultDiv.classList.add('alert-success');

                let resultHtml = `<h5><i class="bi bi-check-circle-fill text-success"></i> LLM API连接测试成功</h5><p>${data.message}</p>`;
                if (data.data) {
                    resultHtml += '<ul>';
                    if (data.data.model) resultHtml += `<li>模型: ${data.data.model}</li>`;
                    if (data.data.response_time) resultHtml += `<li>响应时间: ${data.data.response_time}</li>`;
                    resultHtml += '</ul>';

                    if (data.data.response) {
                        resultHtml += '<h6>LLM响应示例:</h6>';
                        resultHtml += `<div class="p-2 bg-light">${data.data.response.substring(0, 200)}${data.data.response.length > 200 ? '...' : ''}</div>`;
                    }
                }
                resultDiv.innerHTML = resultHtml;
            } else {
                badge.textContent = '异常';
                badge.classList.remove('bg-info', 'bg-secondary', 'bg-success');
                badge.classList.add('bg-danger');

                statusBadge.textContent = '异常';
                statusBadge.classList.remove('bg-secondary', 'bg-success');
                statusBadge.classList.add('bg-danger');

                resultDiv.classList.remove('alert-success', 'alert-info');
                resultDiv.classList.add('alert-danger');

                let failureHtml = `<h5><i class="bi bi-x-circle-fill text-danger"></i> LLM API连接测试失败</h5><p>${data.message}</p>`;

                // 添加故障排除建议
                failureHtml += '<div class="mt-3 p-2 bg-light border-start border-warning border-4">';
                failureHtml += '<p class="mb-1"><strong>可能的解决方案：</strong></p>';
                failureHtml += '<ul class="mb-0">';
                failureHtml += '<li>检查LLM API密钥是否正确</li>';
                failureHtml += '<li>确认API基础URL是否正确（默认为https://api.x.ai/v1）</li>';
                failureHtml += '<li>检查网络连接是否正常</li>';
                failureHtml += '<li>检查代理设置是否正确</li>';
                failureHtml += '</ul>';
                failureHtml += '</div>';

                resultDiv.innerHTML = failureHtml;
            }
            return data.success;
        })
        .catch(error => {
            console.error('Error:', error);

            badge.textContent = '错误';
            badge.classList.remove('bg-info', 'bg-secondary', 'bg-success');
            badge.classList.add('bg-danger');

            statusBadge.textContent = '异常';
            statusBadge.classList.remove('bg-secondary', 'bg-success');
            statusBadge.classList.add('bg-danger');

            resultDiv.classList.remove('alert-success', 'alert-info');
            resultDiv.classList.add('alert-danger');
            resultDiv.innerHTML = `<h5><i class="bi bi-exclamation-triangle-fill text-warning"></i> LLM API连接请求错误</h5>
                <p>${error.message}</p>
                <div class="mt-2">
                    <strong>调试信息:</strong>
                    <ul>
                        <li>请求URL: /api/test/llm</li>
                        <li>请求方法: POST</li>
                    </ul>
                </div>`;
            return false;
        });
    }

    // 测试代理连接
    function testProxy() {
        const badge = document.getElementById('proxy-test-badge');
        const statusBadge = document.getElementById('proxy-status');

        // 弹出对话框，让用户输入测试URL
        const testUrl = prompt('请输入测试URL（留空使用默认URL）:', 'http://connectivitycheck.gstatic.com/generate_204');

        // 如果用户取消了输入，则不执行测试
        if (testUrl === null) {
            return Promise.resolve(false);
        }

        // 更新状态
        badge.textContent = '测试中...';
        badge.classList.remove('bg-secondary', 'bg-success', 'bg-danger');
        badge.classList.add('bg-info');

        // 显示结果区域
        resultDiv.classList.remove('d-none', 'alert-success', 'alert-danger');
        resultDiv.classList.add('alert-info');
        resultDiv.innerHTML = '<h5><i class="bi bi-hourglass-split text-info"></i> 正在测试代理连接...</h5><p>正在测试代理连接，请稍候...</p><div class="progress mt-2"><div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 100%"></div></div>';

        // 准备请求数据
        const requestData = {};
        if (testUrl.trim() !== '') {
            requestData.url = testUrl.trim();
        }

        // 发送请求
        return fetch('/api/test/proxy', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(requestData),
        })
        .then(response => response.json())
        .then(data => {
            // 更新状态标签
            if (data.success) {
                badge.textContent = '正常';
                badge.classList.remove('bg-info', 'bg-secondary', 'bg-danger');
                badge.classList.add('bg-success');

                statusBadge.textContent = '正常';
                statusBadge.classList.remove('bg-secondary', 'bg-danger');
                statusBadge.classList.add('bg-success');

                resultDiv.classList.remove('alert-danger', 'alert-info');
                resultDiv.classList.add('alert-success');

                let resultHtml = `<h5><i class="bi bi-check-circle-fill text-success"></i> 代理连接测试成功</h5><p>${data.message}</p>`;

                if (data.data) {
                    // 如果是双重测试结果
                    if (data.data.baidu_test && data.data.foreign_test) {
                        resultHtml += '<div class="mb-3">';
                        resultHtml += `<h6>诊断结果:</h6>`;
                        resultHtml += `<div class="p-2 bg-light border-start border-info border-4">${data.message}</div>`;
                        resultHtml += '</div>';

                        resultHtml += '<div class="row">';

                        // 百度测试结果
                        resultHtml += '<div class="col-md-6">';
                        resultHtml += `<h6>国内网站测试 (${data.data.baidu_test.url}):</h6>`;
                        resultHtml += `<div class="p-2 ${data.data.baidu_test.success ? 'bg-success bg-opacity-10' : 'bg-danger bg-opacity-10'} rounded">`;
                        resultHtml += `<p><strong>状态:</strong> ${data.data.baidu_test.success ? '✅ 成功' : '❌ 失败'}</p>`;
                        if (data.data.baidu_test.status_code) {
                            resultHtml += `<p><strong>状态码:</strong> ${data.data.baidu_test.status_code}</p>`;
                        }
                        resultHtml += '</div>';
                        resultHtml += '</div>';

                        // 国外网站测试结果
                        resultHtml += '<div class="col-md-6">';
                        resultHtml += `<h6>国外网站测试 (${data.data.foreign_test.url}):</h6>`;
                        resultHtml += `<div class="p-2 ${data.data.foreign_test.success ? 'bg-success bg-opacity-10' : 'bg-danger bg-opacity-10'} rounded">`;
                        resultHtml += `<p><strong>状态:</strong> ${data.data.foreign_test.success ? '✅ 成功' : '❌ 失败'}</p>`;
                        if (data.data.foreign_test.status_code) {
                            resultHtml += `<p><strong>状态码:</strong> ${data.data.foreign_test.status_code}</p>`;
                            if (data.data.foreign_test.status_code === 204) {
                                resultHtml += `<p><small>状态码204表示Google连接测试成功</small></p>`;
                            }
                        }
                        resultHtml += '</div>';
                        resultHtml += '</div>';

                        resultHtml += '</div>';

                        // 代理信息
                        if (data.data.proxy) {
                            resultHtml += `<p class="mt-3"><strong>当前代理设置:</strong> ${data.data.proxy}</p>`;
                        }
                    } else {
                        // 单一URL测试结果
                        resultHtml += '<ul>';
                        if (data.data.url) resultHtml += `<li>测试URL: ${data.data.url}</li>`;
                        if (data.data.ip) resultHtml += `<li>当前IP: ${data.data.ip}</li>`;
                        if (data.data.proxy) resultHtml += `<li>代理设置: ${data.data.proxy}</li>`;
                        if (data.data.response_time) resultHtml += `<li>响应时间: ${data.data.response_time}</li>`;
                        resultHtml += '</ul>';
                    }
                }

                resultDiv.innerHTML = resultHtml;
            } else {
                badge.textContent = '异常';
                badge.classList.remove('bg-info', 'bg-secondary', 'bg-success');
                badge.classList.add('bg-danger');

                statusBadge.textContent = '异常';
                statusBadge.classList.remove('bg-secondary', 'bg-success');
                statusBadge.classList.add('bg-danger');

                resultDiv.classList.remove('alert-success', 'alert-info');
                resultDiv.classList.add('alert-danger');

                let failureHtml = `<h5><i class="bi bi-x-circle-fill text-danger"></i> 代理连接测试失败</h5><p>${data.message}</p>`;

                // 添加故障排除建议
                failureHtml += '<div class="mt-3 p-2 bg-light border-start border-warning border-4">';
                failureHtml += '<p class="mb-1"><strong>可能的解决方案：</strong></p>';
                failureHtml += '<ul class="mb-0">';
                failureHtml += '<li>检查代理地址和端口是否正确</li>';
                failureHtml += '<li>确认代理服务器是否正常运行</li>';
                failureHtml += '<li>检查网络连接是否正常</li>';
                failureHtml += '</ul>';
                failureHtml += '</div>';

                resultDiv.innerHTML = failureHtml;
            }
            return data.success;
        })
        .catch(error => {
            console.error('Error:', error);

            badge.textContent = '错误';
            badge.classList.remove('bg-info', 'bg-secondary', 'bg-success');
            badge.classList.add('bg-danger');

            statusBadge.textContent = '异常';
            statusBadge.classList.remove('bg-secondary', 'bg-success');
            statusBadge.classList.add('bg-danger');

            resultDiv.classList.remove('alert-success', 'alert-info');
            resultDiv.classList.add('alert-danger');
            resultDiv.innerHTML = `<h5><i class="bi bi-exclamation-triangle-fill text-warning"></i> 代理连接请求错误</h5>
                <p>${error.message}</p>
                <div class="mt-2">
                    <strong>调试信息:</strong>
                    <ul>
                        <li>请求URL: /api/test/proxy</li>
                        <li>请求方法: POST</li>
                    </ul>
                </div>`;
            return false;
        });
    }

    // 测试推送功能
    function testNotification() {
        const badge = document.getElementById('notification-test-badge');
        const statusBadge = document.getElementById('notification-status');
        const container = document.getElementById('notification-component-status');

        // 更新状态
        badge.textContent = '测试中...';
        badge.classList.remove('bg-secondary', 'bg-success', 'bg-danger');
        badge.classList.add('bg-info');

        // 显示结果区域
        resultDiv.classList.remove('d-none', 'alert-success', 'alert-danger');
        resultDiv.classList.add('alert-info');
        resultDiv.innerHTML = '<h5><i class="bi bi-hourglass-split text-info"></i> 正在测试推送功能...</h5><p>正在测试推送功能，请稍候...</p><div class="progress mt-2"><div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 100%"></div></div>';
        showTestResult();

        // 发送请求
        return fetch('/api/test/notification', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({}),
        })
        .then(response => response.json())
        .then(data => {
            // 更新状态标签
            if (data.success) {
                badge.textContent = '正常';
                badge.classList.remove('bg-info', 'bg-secondary', 'bg-danger');
                badge.classList.add('bg-success');

                statusBadge.textContent = '正常';
                statusBadge.classList.remove('bg-secondary', 'bg-danger');
                statusBadge.classList.add('bg-success');

                container.classList.add('bg-success', 'bg-opacity-10');
                container.classList.remove('bg-light', 'bg-danger', 'bg-opacity-10');

                resultDiv.classList.remove('alert-danger', 'alert-info');
                resultDiv.classList.add('alert-success');

                let resultHtml = `
                    <div class="d-flex">
                        <div class="flex-shrink-0">
                            <i class="bi bi-check-circle-fill text-success fs-1"></i>
                        </div>
                        <div class="flex-grow-1 ms-3">
                            <h5 class="alert-heading">推送功能测试成功</h5>
                            <p>${data.message}</p>
                `;

                if (data.data) {
                    resultHtml += '<ul class="mb-0">';
                    if (data.data.channels) resultHtml += `<li>推送渠道数: <strong>${data.data.channels}</strong></li>`;
                    if (data.data.response_time) resultHtml += `<li>响应时间: <strong>${data.data.response_time}</strong></li>`;
                    resultHtml += '</ul>';
                }

                resultHtml += `
                        </div>
                    </div>
                `;
                resultDiv.innerHTML = resultHtml;
            } else {
                badge.textContent = '异常';
                badge.classList.remove('bg-info', 'bg-secondary', 'bg-success');
                badge.classList.add('bg-danger');

                statusBadge.textContent = '异常';
                statusBadge.classList.remove('bg-secondary', 'bg-success');
                statusBadge.classList.add('bg-danger');

                container.classList.add('bg-danger', 'bg-opacity-10');
                container.classList.remove('bg-light', 'bg-success', 'bg-opacity-10');

                resultDiv.classList.remove('alert-success', 'alert-info');
                resultDiv.classList.add('alert-danger');

                let failureHtml = `
                    <div class="d-flex">
                        <div class="flex-shrink-0">
                            <i class="bi bi-x-circle-fill text-danger fs-1"></i>
                        </div>
                        <div class="flex-grow-1 ms-3">
                            <h5 class="alert-heading">推送功能测试失败</h5>
                            <p>${data.message}</p>

                            <div class="mt-3 p-3 bg-light border-start border-warning border-4 rounded">
                                <h6 class="mb-2"><i class="bi bi-lightbulb-fill text-warning me-2"></i>可能的解决方案：</h6>
                                <ul class="mb-0">
                                    <li>检查推送设置是否正确配置</li>
                                    <li>确认Apprise URLs是否有效</li>
                                    <li>检查网络连接是否正常</li>
                                    <li>尝试在系统设置中重新配置推送</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                `;

                resultDiv.innerHTML = failureHtml;
            }
            return data.success;
        })
        .catch(error => {
            console.error('Error:', error);

            badge.textContent = '错误';
            badge.classList.remove('bg-info', 'bg-secondary', 'bg-success');
            badge.classList.add('bg-danger');

            statusBadge.textContent = '异常';
            statusBadge.classList.remove('bg-secondary', 'bg-success');
            statusBadge.classList.add('bg-danger');

            container.classList.add('bg-danger', 'bg-opacity-10');
            container.classList.remove('bg-light', 'bg-success', 'bg-opacity-10');

            resultDiv.classList.remove('alert-success', 'alert-info');
            resultDiv.classList.add('alert-danger');
            resultDiv.innerHTML = `
                <div class="d-flex">
                    <div class="flex-shrink-0">
                        <i class="bi bi-exclamation-triangle-fill text-warning fs-1"></i>
                    </div>
                    <div class="flex-grow-1 ms-3">
                        <h5 class="alert-heading">推送功能请求错误</h5>
                        <p>${error.message}</p>

                        <div class="mt-3 p-3 bg-light rounded">
                            <h6 class="mb-2">调试信息:</h6>
                            <ul class="mb-0">
                                <li>请求URL: /api/test/notification</li>
                                <li>请求方法: POST</li>
                            </ul>
                        </div>
                    </div>
                </div>
            `;
            return false;
        });
    }

    // 发送测试推送消息
    function sendNotificationMessage() {
        const message = document.getElementById('notification-message').value.trim();
        if (!message) {
            alert('请输入测试消息内容');
            return;
        }

        // 显示结果区域
        resultDiv.classList.remove('d-none', 'alert-success', 'alert-danger');
        resultDiv.classList.add('alert-info');
        resultDiv.innerHTML = '<h5><i class="bi bi-hourglass-split text-info"></i> 正在发送测试消息...</h5><p>正在发送测试消息，请稍候...</p><div class="progress mt-2"><div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 100%"></div></div>';
        showTestResult();

        // 发送请求
        fetch('/api/test/send_notification', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ message: message }),
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                resultDiv.classList.remove('alert-danger', 'alert-info');
                resultDiv.classList.add('alert-success');

                let resultHtml = `
                    <div class="d-flex">
                        <div class="flex-shrink-0">
                            <i class="bi bi-check-circle-fill text-success fs-1"></i>
                        </div>
                        <div class="flex-grow-1 ms-3">
                            <h5 class="alert-heading">测试消息发送成功</h5>
                            <p>${data.message}</p>
                            <div class="mt-3 p-3 bg-light rounded">
                                <h6 class="mb-2">发送的消息内容:</h6>
                                <p class="mb-0">${message}</p>
                            </div>
                        </div>
                    </div>
                `;
                resultDiv.innerHTML = resultHtml;

                // 更新推送状态
                const statusBadge = document.getElementById('notification-status');
                const container = document.getElementById('notification-component-status');

                if (statusBadge && container) {
                    statusBadge.textContent = '正常';
                    statusBadge.className = 'badge bg-success';

                    container.classList.add('bg-success', 'bg-opacity-10');
                    container.classList.remove('bg-light', 'bg-danger', 'bg-opacity-10');
                }
            } else {
                resultDiv.classList.remove('alert-success', 'alert-info');
                resultDiv.classList.add('alert-danger');

                let failureHtml = `
                    <div class="d-flex">
                        <div class="flex-shrink-0">
                            <i class="bi bi-x-circle-fill text-danger fs-1"></i>
                        </div>
                        <div class="flex-grow-1 ms-3">
                            <h5 class="alert-heading">测试消息发送失败</h5>
                            <p>${data.message}</p>

                            <div class="mt-3 p-3 bg-light border-start border-warning border-4 rounded">
                                <h6 class="mb-2"><i class="bi bi-lightbulb-fill text-warning me-2"></i>可能的解决方案：</h6>
                                <ul class="mb-0">
                                    <li>检查推送设置是否正确配置</li>
                                    <li>确认Apprise URLs是否有效</li>
                                    <li>检查网络连接是否正常</li>
                                    <li>尝试在系统设置中重新配置推送</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                `;
                resultDiv.innerHTML = failureHtml;

                // 更新推送状态
                const statusBadge = document.getElementById('notification-status');
                const container = document.getElementById('notification-component-status');

                if (statusBadge && container) {
                    statusBadge.textContent = '异常';
                    statusBadge.className = 'badge bg-danger';

                    container.classList.add('bg-danger', 'bg-opacity-10');
                    container.classList.remove('bg-light', 'bg-success', 'bg-opacity-10');
                }
            }
        })
        .catch(error => {
            console.error('Error:', error);

            resultDiv.classList.remove('alert-success', 'alert-info');
            resultDiv.classList.add('alert-danger');
            resultDiv.innerHTML = `
                <div class="d-flex">
                    <div class="flex-shrink-0">
                        <i class="bi bi-exclamation-triangle-fill text-warning fs-1"></i>
                    </div>
                    <div class="flex-grow-1 ms-3">
                        <h5 class="alert-heading">测试消息发送请求错误</h5>
                        <p>${error.message}</p>

                        <div class="mt-3 p-3 bg-light rounded">
                            <h6 class="mb-2">调试信息:</h6>
                            <ul class="mb-0">
                                <li>请求URL: /api/test/send_notification</li>
                                <li>请求方法: POST</li>
                                <li>消息内容: ${message}</li>
                            </ul>
                        </div>
                    </div>
                </div>
            `;
        });
    }

    // 一键诊断所有组件
    async function testAll() {
        // 禁用所有按钮
        document.getElementById('test-all-btn').disabled = true;
        document.getElementById('test-twitter-btn').disabled = true;
        document.getElementById('test-llm-btn').disabled = true;
        document.getElementById('test-proxy-btn').disabled = true;
        document.getElementById('test-notification-btn').disabled = true;

        // 显示初始状态信息
        resultDiv.classList.remove('d-none', 'alert-success', 'alert-danger');
        resultDiv.classList.add('alert-info');
        resultDiv.innerHTML = '<h5><i class="bi bi-hourglass-split text-info"></i> 正在执行系统诊断...</h5><p>正在依次测试各个组件，请稍候...</p><div class="progress mt-2"><div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 100%"></div></div>';

        // 依次测试各个组件
        let twitterResult = false;
        let llmResult = false;
        let proxyResult = false;
        let notificationResult = false;

        try {
            // 测试Twitter连接
            resultDiv.innerHTML = '<h5><i class="bi bi-hourglass-split text-info"></i> 正在执行系统诊断...</h5><p>正在测试Twitter连接 (1/4)...</p><div class="progress mt-2"><div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 25%"></div></div>';
            twitterResult = await testTwitter();

            // 测试LLM API连接
            resultDiv.innerHTML = '<h5><i class="bi bi-hourglass-split text-info"></i> 正在执行系统诊断...</h5><p>正在测试LLM API连接 (2/4)...</p><div class="progress mt-2"><div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 50%"></div></div>';
            llmResult = await testLLM();

            // 测试代理连接
            resultDiv.innerHTML = '<h5><i class="bi bi-hourglass-split text-info"></i> 正在执行系统诊断...</h5><p>正在测试代理连接 (3/4)...</p><div class="progress mt-2"><div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 75%"></div></div>';
            proxyResult = await testProxy();

            // 测试推送功能
            resultDiv.innerHTML = '<h5><i class="bi bi-hourglass-split text-info"></i> 正在执行系统诊断...</h5><p>正在测试推送功能 (4/4)...</p><div class="progress mt-2"><div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 100%"></div></div>';
            notificationResult = await testNotification();

            // 显示诊断结果
            const successCount = (twitterResult ? 1 : 0) + (llmResult ? 1 : 0) + (proxyResult ? 1 : 0) + (notificationResult ? 1 : 0);
            const totalCount = 4; // 总共测试的组件数量

            if (successCount === totalCount) {
                resultDiv.classList.remove('alert-info', 'alert-danger');
                resultDiv.classList.add('alert-success');
                resultDiv.innerHTML = `<h5><i class="bi bi-check-circle-fill text-success"></i> 系统诊断完成</h5>
                    <p>所有组件测试通过，系统运行正常！</p>
                    <div class="mt-3">
                        <div class="d-flex justify-content-between mb-2">
                            <span><i class="bi bi-twitter"></i> Twitter连接</span>
                            <span class="badge bg-success">正常</span>
                        </div>
                        <div class="d-flex justify-content-between mb-2">
                            <span><i class="bi bi-cpu"></i> LLM API连接</span>
                            <span class="badge bg-success">正常</span>
                        </div>
                        <div class="d-flex justify-content-between mb-2">
                            <span><i class="bi bi-globe"></i> 代理连接</span>
                            <span class="badge bg-success">正常</span>
                        </div>
                        <div class="d-flex justify-content-between mb-2">
                            <span><i class="bi bi-bell"></i> 推送功能</span>
                            <span class="badge bg-success">正常</span>
                        </div>
                    </div>
                    <div class="alert alert-success mt-3">
                        <i class="bi bi-info-circle"></i> 系统各组件运行正常，您可以放心使用所有功能。
                    </div>`;
            } else if (successCount === 0) {
                resultDiv.classList.remove('alert-info', 'alert-success');
                resultDiv.classList.add('alert-danger');
                resultDiv.innerHTML = `<h5><i class="bi bi-x-circle-fill text-danger"></i> 系统诊断完成</h5>
                    <p>所有组件测试失败，系统可能无法正常工作！</p>
                    <div class="mt-3">
                        <div class="d-flex justify-content-between mb-2">
                            <span><i class="bi bi-twitter"></i> Twitter连接</span>
                            <span class="badge bg-danger">异常</span>
                        </div>
                        <div class="d-flex justify-content-between mb-2">
                            <span><i class="bi bi-cpu"></i> LLM API连接</span>
                            <span class="badge bg-danger">异常</span>
                        </div>
                        <div class="d-flex justify-content-between mb-2">
                            <span><i class="bi bi-globe"></i> 代理连接</span>
                            <span class="badge bg-danger">异常</span>
                        </div>
                        <div class="d-flex justify-content-between mb-2">
                            <span><i class="bi bi-bell"></i> 推送功能</span>
                            <span class="badge bg-danger">异常</span>
                        </div>
                    </div>
                    <div class="alert alert-danger mt-3">
                        <i class="bi bi-exclamation-triangle-fill"></i> 系统所有组件都存在问题，请检查网络连接和系统配置。
                    </div>`;
            } else {
                resultDiv.classList.remove('alert-info');
                resultDiv.classList.add('alert-warning');
                resultDiv.innerHTML = `<h5><i class="bi bi-exclamation-triangle-fill text-warning"></i> 系统诊断完成</h5>
                    <p>部分组件测试通过，系统可能无法正常工作！</p>
                    <div class="mt-3">
                        <div class="d-flex justify-content-between mb-2">
                            <span><i class="bi bi-twitter"></i> Twitter连接</span>
                            <span class="badge ${twitterResult ? 'bg-success' : 'bg-danger'}">${twitterResult ? '正常' : '异常'}</span>
                        </div>
                        <div class="d-flex justify-content-between mb-2">
                            <span><i class="bi bi-cpu"></i> LLM API连接</span>
                            <span class="badge ${llmResult ? 'bg-success' : 'bg-danger'}">${llmResult ? '正常' : '异常'}</span>
                        </div>
                        <div class="d-flex justify-content-between mb-2">
                            <span><i class="bi bi-globe"></i> 代理连接</span>
                            <span class="badge ${proxyResult ? 'bg-success' : 'bg-danger'}">${proxyResult ? '正常' : '异常'}</span>
                        </div>
                        <div class="d-flex justify-content-between mb-2">
                            <span><i class="bi bi-bell"></i> 推送功能</span>
                            <span class="badge ${notificationResult ? 'bg-success' : 'bg-danger'}">${notificationResult ? '正常' : '异常'}</span>
                        </div>
                    </div>
                    <div class="alert alert-warning mt-3">
                        <i class="bi bi-info-circle"></i> 系统部分组件存在问题，请检查相关配置。
                    </div>`;
            }
        } catch (error) {
            console.error('Error during system diagnosis:', error);
            resultDiv.classList.remove('alert-info', 'alert-success');
            resultDiv.classList.add('alert-danger');
            resultDiv.innerHTML = `<h5><i class="bi bi-exclamation-triangle-fill text-danger"></i> 系统诊断出错</h5>
                <p>执行诊断过程中发生错误：${error.message}</p>
                <div class="alert alert-danger mt-3">
                    <i class="bi bi-exclamation-triangle-fill"></i> 请刷新页面后重试，或联系系统管理员。
                </div>`;
        } finally {
            // 恢复按钮状态
            document.getElementById('test-all-btn').disabled = false;
            document.getElementById('test-twitter-btn').disabled = false;
            document.getElementById('test-llm-btn').disabled = false;
            document.getElementById('test-proxy-btn').disabled = false;
        }
    }



    // 清理数据库
    function cleanDatabase(type, days, max_records = 0, account_id = '') {
        // 获取CSRF令牌
        const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');

        // 显示结果区域
        resultDiv.classList.remove('d-none', 'alert-success', 'alert-danger');
        resultDiv.classList.add('alert-info');
        resultDiv.innerHTML = '<h5><i class="bi bi-hourglass-split text-info"></i> 正在清理数据库...</h5><p>正在执行数据库清理操作，请稍候...</p><div class="progress mt-2"><div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 100%"></div></div>';

        // 准备请求数据
        const requestData = {
            type: type,
            days: days
        };

        // 如果有最大记录数，添加到请求数据
        if (max_records > 0) {
            requestData.max_records = max_records;
        }

        // 如果有账号ID，添加到请求数据
        if (account_id) {
            requestData.account_id = account_id;
        }

        // 发送请求
        fetch('/api/test/clean_database', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            },
            body: JSON.stringify(requestData),
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                resultDiv.classList.remove('alert-info', 'alert-danger');
                resultDiv.classList.add('alert-success');

                let resultHtml = `<h5><i class="bi bi-check-circle-fill text-success"></i> 数据库清理成功</h5>`;

                if (data.data) {
                    if (data.data.type === 'truncate') {
                        resultHtml += `<p>已成功清空所有数据！</p>`;
                    } else if (data.data.type === 'all_irrelevant') {
                        resultHtml += `<p>已成功清理${data.data.account_id ? '账号 ' + data.data.account_id + ' 的' : ''}所有不相关的数据，共 ${data.data.deleted_count} 条记录。</p>`;
                    } else if (data.data.max_records) {
                        // 基于数量的清理
                        resultHtml += `<p>已成功清理${data.data.account_id ? '账号 ' + data.data.account_id + ' 的' : '每个账号的'}${data.data.type === 'irrelevant' ? '不相关' : ''}数据，共 ${data.data.deleted_count} 条记录。</p>`;
                        resultHtml += `<p>每个账号保留最新的 ${data.data.max_records} 条${data.data.type === 'irrelevant' ? '不相关' : ''}记录。</p>`;
                    } else {
                        // 基于时间的清理
                        resultHtml += `<p>已成功清理${data.data.account_id ? '账号 ' + data.data.account_id + ' 的' : ''} ${data.data.deleted_count} 条超过 ${data.data.days} 天的${data.data.type === 'irrelevant' ? '不相关' : ''}数据。</p>`;
                        if (data.data.cutoff_date) {
                            resultHtml += `<p>清理截止日期: ${new Date(data.data.cutoff_date).toLocaleString()}</p>`;
                        }
                    }
                }

                resultDiv.innerHTML = resultHtml;
            } else {
                resultDiv.classList.remove('alert-info', 'alert-success');
                resultDiv.classList.add('alert-danger');
                resultDiv.innerHTML = `<h5><i class="bi bi-x-circle-fill text-danger"></i> 数据库清理失败</h5><p>${data.message}</p>`;
            }
        })
        .catch(error => {
            console.error('Error:', error);
            resultDiv.classList.remove('alert-info', 'alert-success');
            resultDiv.classList.add('alert-danger');
            resultDiv.innerHTML = `<h5><i class="bi bi-exclamation-triangle-fill text-danger"></i> 数据库清理请求错误</h5><p>${error.message}</p>`;
        });
    }

    // 清理日志文件
    function cleanLogs(type) {
        // 获取CSRF令牌
        const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');

        // 显示结果区域
        resultDiv.classList.remove('d-none', 'alert-success', 'alert-danger');
        resultDiv.classList.add('alert-info');
        resultDiv.innerHTML = '<h5><i class="bi bi-hourglass-split text-info"></i> 正在清理日志文件...</h5><p>正在执行日志清理操作，请稍候...</p><div class="progress mt-2"><div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 100%"></div></div>';

        // 发送请求
        fetch('/api/test/clean_logs', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            },
            body: JSON.stringify({
                type: type
            }),
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                resultDiv.classList.remove('alert-info', 'alert-danger');
                resultDiv.classList.add('alert-success');

                let resultHtml = `<h5><i class="bi bi-check-circle-fill text-success"></i> 日志清理成功</h5>`;

                if (data.data) {
                    if (type === 'empty') {
                        resultHtml += `<p>已成功清空 ${data.data.count} 个日志文件的内容。</p>`;
                    } else if (type === 'delete') {
                        resultHtml += `<p>已成功删除 ${data.data.count} 个日志文件。</p>`;
                    } else if (type === 'backup_and_empty') {
                        resultHtml += `<p>已成功备份并清空 ${data.data.count} 个日志文件。</p>`;
                    }

                    if (data.data.cleaned_files && data.data.cleaned_files.length > 0) {
                        resultHtml += `<p>处理的文件:</p><ul>`;
                        data.data.cleaned_files.slice(0, 10).forEach(file => {
                            resultHtml += `<li>${file}</li>`;
                        });
                        if (data.data.cleaned_files.length > 10) {
                            resultHtml += `<li>...等共 ${data.data.cleaned_files.length} 个文件</li>`;
                        }
                        resultHtml += `</ul>`;
                    }
                }

                resultDiv.innerHTML = resultHtml;
            } else {
                resultDiv.classList.remove('alert-info', 'alert-success');
                resultDiv.classList.add('alert-danger');
                resultDiv.innerHTML = `<h5><i class="bi bi-x-circle-fill text-danger"></i> 日志清理失败</h5><p>${data.message}</p>`;
            }
        })
        .catch(error => {
            console.error('Error:', error);
            resultDiv.classList.remove('alert-info', 'alert-success');
            resultDiv.classList.add('alert-danger');
            resultDiv.innerHTML = `<h5><i class="bi bi-exclamation-triangle-fill text-danger"></i> 日志清理请求错误</h5><p>${error.message}</p>`;
        });
    }

    // 事件监听器
    document.addEventListener('DOMContentLoaded', function() {
        // 测试按钮事件监听
        document.getElementById('test-all-btn').addEventListener('click', testAll);
        document.getElementById('test-twitter-btn').addEventListener('click', testTwitter);
        document.getElementById('test-llm-btn').addEventListener('click', testLLM);
        document.getElementById('test-proxy-btn').addEventListener('click', testProxy);

        // 立即执行监控任务按钮事件监听
        document.getElementById('run-task-btn').addEventListener('click', function(e) {
            e.preventDefault();

            if (confirm('确定要立即执行监控任务吗？')) {
                // 获取CSRF令牌
                const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');

                fetch('/api/tasks/run', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrfToken
                    },
                    body: JSON.stringify({}),
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert('监控任务已启动，请稍后查看结果。');
                    } else {
                        alert('启动监控任务失败: ' + data.message);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('请求错误: ' + error.message);
                });
            }
        });

        // 重置记录并执行监控任务按钮事件监听
        document.getElementById('run-task-reset-btn').addEventListener('click', function(e) {
            e.preventDefault();

            if (confirm('确定要重置处理记录并执行监控任务吗？这将重新获取所有推文，包括已处理过的。')) {
                // 获取CSRF令牌
                const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');

                fetch('/api/tasks/run', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrfToken
                    },
                    body: JSON.stringify({
                        reset_cursor: true
                    }),
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert('已重置处理记录，监控任务已启动，请稍后查看结果。');
                    } else {
                        alert('启动监控任务失败: ' + data.message);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('请求错误: ' + error.message);
                });
            }
        });

        // 获取时间线推文按钮事件监听
        document.getElementById('run-timeline-btn').addEventListener('click', function(e) {
            e.preventDefault();

            if (confirm('确定要获取时间线（关注账号）的最新推文吗？')) {
                // 获取CSRF令牌
                const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');

                fetch('/api/tasks/run_timeline', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrfToken
                    },
                    body: JSON.stringify({}),
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert('时间线抓取任务已启动，请稍后查看结果。');
                    } else {
                        alert('启动时间线抓取任务失败: ' + data.message);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('请求错误: ' + error.message);
                });
            }
        });

        // 清理数据库按钮事件监听（基于时间清理）
        document.getElementById('clean-db-btn').addEventListener('click', function(e) {
            e.preventDefault();

            // 弹出对话框，让用户选择清理类型
            const cleanType = prompt('请选择清理类型（输入对应数字）：\n1. 基于时间清理所有旧数据\n2. 基于时间清理不相关的旧数据\n3. 清理所有不相关数据（不考虑时间）', '1');

            if (cleanType === null) {
                return;  // 用户取消了操作
            }

            let type = 'all';
            let days = 30;
            let max_records = 0;
            let account_id = '';

            // 基于时间的清理
            if (cleanType === '1' || cleanType === '2') {
                if (cleanType === '1') {
                    type = 'all';
                } else {
                    type = 'irrelevant';
                }

                // 询问是否针对特定账号
                const specificAccount = confirm('是否只清理特定账号的数据？');
                if (specificAccount) {
                    account_id = prompt('请输入要清理的账号ID：');
                    if (!account_id) {
                        alert('账号ID不能为空，操作已取消');
                        return;
                    }
                }

                days = parseInt(prompt('请输入要保留的最近天数（默认30天）：', '30')) || 30;

                if (confirm(`确定要清理${account_id ? '账号 ' + account_id + ' 的' : ''}${type === 'all' ? '所有' : '不相关的'}超过 ${days} 天的数据吗？此操作不可恢复！`)) {
                    cleanDatabase(type, days, max_records, account_id);
                }
            }
            // 清理所有不相关数据
            else if (cleanType === '3') {
                type = 'all_irrelevant';

                // 询问是否针对特定账号
                const specificAccount = confirm('是否只清理特定账号的数据？');
                if (specificAccount) {
                    account_id = prompt('请输入要清理的账号ID：');
                    if (!account_id) {
                        alert('账号ID不能为空，操作已取消');
                        return;
                    }
                }

                if (confirm(`确定要清理${account_id ? '账号 ' + account_id + ' 的' : ''}所有不相关数据吗？此操作不可恢复！`)) {
                    cleanDatabase(type, days, max_records, account_id);
                }
            }
            else {
                alert('无效的选择，操作已取消');
                return;
            }
        });

        // 按数量清理按钮事件监听
        document.getElementById('clean-by-count-btn').addEventListener('click', function(e) {
            e.preventDefault();

            // 弹出对话框，让用户选择清理类型
            const cleanType = prompt('请选择清理类型（输入对应数字）：\n1. 保留每个账号最新N条记录\n2. 保留每个账号最新N条不相关记录', '1');

            if (cleanType === null) {
                return;  // 用户取消了操作
            }

            let type = 'all';
            let days = 30;
            let max_records = 0;
            let account_id = '';

            if (cleanType === '1') {
                type = 'all';
            } else if (cleanType === '2') {
                type = 'irrelevant';
            } else {
                alert('无效的选择，操作已取消');
                return;
            }

            // 询问是否针对特定账号
            const specificAccount = confirm('是否只清理特定账号的数据？');
            if (specificAccount) {
                account_id = prompt('请输入要清理的账号ID：');
                if (!account_id) {
                    alert('账号ID不能为空，操作已取消');
                    return;
                }
            }

            max_records = parseInt(prompt('请输入每个账号要保留的最新记录数（默认100条）：', '100')) || 100;

            if (confirm(`确定要清理${account_id ? '账号 ' + account_id + ' 的' : '每个账号的'}${type === 'all' ? '' : '不相关'}数据，只保留最新的 ${max_records} 条记录吗？此操作不可恢复！`)) {
                cleanDatabase(type, days, max_records, account_id);
            }
        });

        // 清空所有数据按钮事件监听
        document.getElementById('truncate-db-btn').addEventListener('click', function(e) {
            e.preventDefault();

            if (confirm('警告：此操作将清空所有分析结果数据，且不可恢复！确定要继续吗？')) {
                if (confirm('再次确认：您确定要清空所有数据吗？此操作将删除所有分析结果，且不可恢复！')) {
                    cleanDatabase('truncate', 0);
                }
            }
        });

        // 清理日志文件按钮事件监听
        document.getElementById('clean-logs-btn').addEventListener('click', function(e) {
            e.preventDefault();

            if (confirm('确定要清空所有日志文件内容吗？此操作不可恢复！')) {
                cleanLogs('empty');
            }
        });

        // 备份并清空日志按钮事件监听
        document.getElementById('backup-logs-btn').addEventListener('click', function(e) {
            e.preventDefault();

            if (confirm('确定要备份并清空所有日志文件吗？')) {
                cleanLogs('backup_and_empty');
            }
        });

        // 删除所有日志按钮事件监听
        document.getElementById('delete-logs-btn').addEventListener('click', function(e) {
            e.preventDefault();

            if (confirm('警告：此操作将删除所有日志文件，且不可恢复！确定要继续吗？')) {
                if (confirm('再次确认：您确定要删除所有日志文件吗？此操作不可恢复！')) {
                    cleanLogs('delete');
                }
            }
        });


    });
</script>
{% endblock %}
