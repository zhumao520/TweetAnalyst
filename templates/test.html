{% extends 'base.html' %}

{% block title %}系统测试{% endblock %}

{% block content %}
<div class="container mt-4">
    <h1 class="mb-4">系统测试</h1>

    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">系统状态</h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <h6>系统信息</h6>
                        <ul class="list-group">
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                版本
                                <span class="badge bg-primary rounded-pill">{{ system_status.system.version }}</span>
                            </li>
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                运行时间
                                <span class="badge bg-primary rounded-pill">{{ system_status.system.uptime }}</span>
                            </li>

                        </ul>
                    </div>

                    <div class="mb-3">
                        <h6>配置信息</h6>
                        <ul class="list-group">
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                LLM模型
                                <span class="badge bg-primary rounded-pill">{{ system_status.config.llm_model }}</span>
                            </li>
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                定时任务间隔
                                <span class="badge bg-primary rounded-pill">{{ system_status.config.scheduler_interval }}分钟</span>
                            </li>
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                代理设置
                                <span class="badge bg-primary rounded-pill">{{ system_status.config.proxy }}</span>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">组件状态</h5>
                </div>
                <div class="card-body">
                    <ul class="list-group">
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            Twitter API
                            <span id="twitter-status" class="badge bg-secondary rounded-pill">{{ system_status.components.twitter_api.status }}</span>
                        </li>
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            LLM API
                            <span id="llm-status" class="badge bg-secondary rounded-pill">{{ system_status.components.llm_api.status }}</span>
                        </li>
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            代理
                            <span id="proxy-status" class="badge bg-secondary rounded-pill">{{ system_status.components.proxy.status }}</span>
                        </li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-md-4 mb-4">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">Twitter测试</h5>
                </div>
                <div class="card-body">
                    <form id="twitter-test-form">
                        <div class="mb-3">
                            <label for="twitter-account" class="form-label">Twitter账号ID</label>
                            <input type="text" class="form-control" id="twitter-account" placeholder="例如: elonmusk">
                            <div class="form-text">留空将使用默认测试账号</div>
                        </div>
                        <button type="submit" class="btn btn-primary" id="twitter-test-btn">
                            <span class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span>
                            测试连接
                        </button>
                    </form>
                    <div class="mt-3">
                        <div id="twitter-test-result" class="alert d-none" style="border: 2px solid; font-weight: 500;"></div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-4 mb-4">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">LLM测试</h5>
                </div>
                <div class="card-body">
                    <form id="llm-test-form">
                        <div class="mb-3">
                            <label for="llm-prompt" class="form-label">测试提示词</label>
                            <textarea class="form-control" id="llm-prompt" rows="3" placeholder="请输入测试提示词..."></textarea>
                            <div class="form-text">留空将使用默认测试提示词（使用Grok-2模型）</div>
                        </div>
                        <button type="submit" class="btn btn-primary" id="llm-test-btn">
                            <span class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span>
                            测试连接
                        </button>
                    </form>
                    <div class="mt-3">
                        <div id="llm-test-result" class="alert d-none" style="border: 2px solid; font-weight: 500;"></div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-4 mb-4">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">代理测试</h5>
                </div>
                <div class="card-body">
                    <form id="proxy-test-form">
                        <div class="mb-3">
                            <label for="proxy-url" class="form-label">测试URL</label>
                            <input type="text" class="form-control" id="proxy-url" placeholder="例如: https://api.ipify.org?format=json">
                            <div class="form-text">留空将使用默认测试URL</div>
                        </div>
                        <button type="submit" class="btn btn-primary" id="proxy-test-btn">
                            <span class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span>
                            测试连接
                        </button>
                    </form>
                    <div class="mt-3">
                        <div id="proxy-test-result" class="alert d-none" style="border: 2px solid; font-weight: 500;"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Twitter测试
    document.getElementById('twitter-test-form').addEventListener('submit', function(e) {
        e.preventDefault();
        const accountId = document.getElementById('twitter-account').value;
        const resultDiv = document.getElementById('twitter-test-result');
        const button = document.getElementById('twitter-test-btn');
        const spinner = button.querySelector('.spinner-border');

        // 显示加载状态
        button.disabled = true;
        spinner.classList.remove('d-none');
        resultDiv.classList.add('d-none');

        // 显示初始状态信息
        resultDiv.classList.remove('d-none');
        resultDiv.classList.add('alert-info');
        resultDiv.innerHTML = '<h5><i class="bi bi-hourglass-split text-info"></i> 正在测试...</h5><p>正在连接Twitter API，请稍候...</p><div class="progress mt-2"><div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 100%"></div></div>';

        // 发送请求
        fetch('/api/test/twitter', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ account_id: accountId }),
        })
        .then(response => response.json())
        .then(data => {
            // 更新状态标签
            const statusBadge = document.getElementById('twitter-status');
            if (data.success) {
                statusBadge.textContent = '正常';
                statusBadge.classList.remove('bg-secondary', 'bg-danger');
                statusBadge.classList.add('bg-success');

                resultDiv.classList.remove('alert-danger');
                resultDiv.classList.add('alert-success');

                let resultHtml = `<h5><i class="bi bi-check-circle-fill text-success"></i> 测试成功</h5><p>${data.message}</p>`;
                if (data.data) {
                    resultHtml += '<ul>';
                    if (data.data.account_id) resultHtml += `<li>账号ID: ${data.data.account_id}</li>`;
                    if (data.data.post_count) resultHtml += `<li>获取推文数: ${data.data.post_count}</li>`;
                    if (data.data.response_time) resultHtml += `<li>响应时间: ${data.data.response_time}</li>`;
                    resultHtml += '</ul>';

                    if (data.data.first_post) {
                        resultHtml += '<h6>第一条推文:</h6>';
                        resultHtml += '<ul>';
                        resultHtml += `<li>ID: ${data.data.first_post.id}</li>`;
                        resultHtml += `<li>时间: ${data.data.first_post.time}</li>`;
                        resultHtml += `<li>内容: ${data.data.first_post.content}</li>`;
                        resultHtml += '</ul>';
                    }
                }
                resultHtml += '<div class="mt-3 p-2 bg-light border-start border-success border-4"><small><i class="bi bi-info-circle"></i> <strong>提示：</strong>测试成功后，您可以在<a href="/unified_settings">统一设置中心</a>保存相关配置。</small></div>';
                resultDiv.innerHTML = resultHtml;
            } else {
                statusBadge.textContent = '异常';
                statusBadge.classList.remove('bg-secondary', 'bg-success');
                statusBadge.classList.add('bg-danger');

                resultDiv.classList.remove('alert-success');
                resultDiv.classList.add('alert-danger');
                let failureHtml = `<h5><i class="bi bi-x-circle-fill text-danger"></i> 测试失败</h5><p>${data.message}</p>`;

                // 添加故障排除建议
                failureHtml += '<div class="mt-3 p-2 bg-light border-start border-warning border-4">';
                failureHtml += '<p class="mb-1"><strong>可能的解决方案：</strong></p>';
                failureHtml += '<ul class="mb-0">';
                failureHtml += '<li>检查网络连接是否正常</li>';
                failureHtml += '<li>确认Twitter账号ID是否正确</li>';
                failureHtml += '<li>检查代理设置是否正确</li>';
                failureHtml += '<li>尝试使用不同的Twitter账号</li>';
                failureHtml += '</ul>';
                failureHtml += '</div>';

                resultDiv.innerHTML = failureHtml;
            }
        })
        .catch(error => {
            console.error('Error:', error);
            // 更新状态标签
            const statusBadge = document.getElementById('twitter-status');
            statusBadge.textContent = '异常';
            statusBadge.classList.remove('bg-secondary', 'bg-success');
            statusBadge.classList.add('bg-danger');

            resultDiv.classList.remove('alert-success', 'alert-info');
            resultDiv.classList.add('alert-danger');
            resultDiv.innerHTML = `<h5><i class="bi bi-exclamation-triangle-fill text-warning"></i> 请求错误</h5>
                <p>${error.message}</p>
                <div class="mt-2">
                    <strong>调试信息:</strong>
                    <ul>
                        <li>请求URL: /api/test/twitter</li>
                        <li>请求方法: POST</li>
                        <li>请求参数: account_id=${accountId || '(空)'}</li>
                    </ul>
                </div>`;
        })
        .finally(() => {
            // 恢复按钮状态
            button.disabled = false;
            spinner.classList.add('d-none');
            resultDiv.classList.remove('d-none');
        });
    });

    // LLM测试
    document.getElementById('llm-test-form').addEventListener('submit', function(e) {
        e.preventDefault();
        const prompt = document.getElementById('llm-prompt').value;
        const resultDiv = document.getElementById('llm-test-result');
        const button = document.getElementById('llm-test-btn');
        const spinner = button.querySelector('.spinner-border');

        // 显示加载状态
        button.disabled = true;
        spinner.classList.remove('d-none');
        resultDiv.classList.add('d-none');

        // 显示初始状态信息
        resultDiv.classList.remove('d-none');
        resultDiv.classList.add('alert-info');
        resultDiv.innerHTML = '<h5><i class="bi bi-hourglass-split text-info"></i> 正在测试...</h5><p>正在连接LLM API，请稍候...</p><div class="progress mt-2"><div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 100%"></div></div>';

        // 发送请求
        fetch('/api/test/llm', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ prompt: prompt }),
        })
        .then(response => response.json())
        .then(data => {
            // 更新状态标签
            const statusBadge = document.getElementById('llm-status');
            if (data.success) {
                statusBadge.textContent = '正常';
                statusBadge.classList.remove('bg-secondary', 'bg-danger');
                statusBadge.classList.add('bg-success');

                resultDiv.classList.remove('alert-danger');
                resultDiv.classList.add('alert-success');

                let resultHtml = `<h5><i class="bi bi-check-circle-fill text-success"></i> 测试成功</h5><p>${data.message}</p>`;
                if (data.data) {
                    resultHtml += '<ul>';
                    if (data.data.prompt) resultHtml += `<li>提示词: ${data.data.prompt}</li>`;
                    if (data.data.response_time) resultHtml += `<li>响应时间: ${data.data.response_time}</li>`;
                    resultHtml += '</ul>';

                    if (data.data.response) {
                        resultHtml += '<h6>LLM响应:</h6>';
                        resultHtml += `<div class="p-2 bg-light">${data.data.response}</div>`;
                    }
                }
                resultHtml += '<div class="mt-3 p-2 bg-light border-start border-success border-4"><small><i class="bi bi-info-circle"></i> <strong>提示：</strong>测试成功后，您可以在<a href="/unified_settings#llm">统一设置中心</a>保存LLM设置。</small></div>';
                resultDiv.innerHTML = resultHtml;
            } else {
                statusBadge.textContent = '异常';
                statusBadge.classList.remove('bg-secondary', 'bg-success');
                statusBadge.classList.add('bg-danger');

                resultDiv.classList.remove('alert-success');
                resultDiv.classList.add('alert-danger');
                let failureHtml = `<h5><i class="bi bi-x-circle-fill text-danger"></i> 测试失败</h5><p>${data.message}</p>`;

                // 添加故障排除建议
                failureHtml += '<div class="mt-3 p-2 bg-light border-start border-warning border-4">';
                failureHtml += '<p class="mb-1"><strong>可能的解决方案：</strong></p>';
                failureHtml += '<ul class="mb-0">';
                failureHtml += '<li>检查xAI API密钥是否正确</li>';
                failureHtml += '<li>确认API基础URL是否正确（默认为https://api.x.ai/v1）</li>';
                failureHtml += '<li>检查网络连接是否正常</li>';
                failureHtml += '<li>检查代理设置是否正确</li>';
                failureHtml += '</ul>';
                failureHtml += '</div>';

                resultDiv.innerHTML = failureHtml;
            }
        })
        .catch(error => {
            console.error('Error:', error);
            // 更新状态标签
            const statusBadge = document.getElementById('llm-status');
            statusBadge.textContent = '异常';
            statusBadge.classList.remove('bg-secondary', 'bg-success');
            statusBadge.classList.add('bg-danger');

            resultDiv.classList.remove('alert-success', 'alert-info');
            resultDiv.classList.add('alert-danger');
            resultDiv.innerHTML = `<h5><i class="bi bi-exclamation-triangle-fill text-warning"></i> 请求错误</h5>
                <p>${error.message}</p>
                <div class="mt-2">
                    <strong>调试信息:</strong>
                    <ul>
                        <li>请求URL: /api/test/llm</li>
                        <li>请求方法: POST</li>
                        <li>请求参数: prompt=${prompt ? '已提供' : '(空)'}</li>
                    </ul>
                </div>`;
        })
        .finally(() => {
            // 恢复按钮状态
            button.disabled = false;
            spinner.classList.add('d-none');
            resultDiv.classList.remove('d-none');
        });
    });

    // 代理测试
    document.getElementById('proxy-test-form').addEventListener('submit', function(e) {
        e.preventDefault();
        const url = document.getElementById('proxy-url').value;
        const resultDiv = document.getElementById('proxy-test-result');
        const button = document.getElementById('proxy-test-btn');
        const spinner = button.querySelector('.spinner-border');

        // 显示加载状态
        button.disabled = true;
        spinner.classList.remove('d-none');
        resultDiv.classList.add('d-none');

        // 显示初始状态信息
        resultDiv.classList.remove('d-none');
        resultDiv.classList.add('alert-info');
        resultDiv.innerHTML = '<h5><i class="bi bi-hourglass-split text-info"></i> 正在测试...</h5><p>正在测试代理连接，请稍候...</p><div class="progress mt-2"><div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 100%"></div></div>';

        // 发送请求
        fetch('/api/test/proxy', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ url: url }),
        })
        .then(response => response.json())
        .then(data => {
            // 更新状态标签
            const statusBadge = document.getElementById('proxy-status');
            if (data.success) {
                statusBadge.textContent = '正常';
                statusBadge.classList.remove('bg-secondary', 'bg-danger');
                statusBadge.classList.add('bg-success');

                resultDiv.classList.remove('alert-danger');
                resultDiv.classList.add('alert-success');

                let resultHtml = `<h5><i class="bi bi-check-circle-fill text-success"></i> 测试成功</h5><p>${data.message}</p>`;
                if (data.data) {
                    resultHtml += '<ul>';
                    if (data.data.url) resultHtml += `<li>测试URL: ${data.data.url}</li>`;
                    if (data.data.ip) resultHtml += `<li>当前IP: ${data.data.ip}</li>`;
                    if (data.data.proxy) resultHtml += `<li>代理设置: ${data.data.proxy}</li>`;
                    if (data.data.response_time) resultHtml += `<li>响应时间: ${data.data.response_time}</li>`;
                    resultHtml += '</ul>';
                }
                resultHtml += '<div class="mt-3 p-2 bg-light border-start border-success border-4"><small><i class="bi bi-info-circle"></i> <strong>提示：</strong>测试成功后，您可以在<a href="/unified_settings#proxy">统一设置中心</a>保存代理配置。</small></div>';
                resultDiv.innerHTML = resultHtml;
            } else {
                statusBadge.textContent = '异常';
                statusBadge.classList.remove('bg-secondary', 'bg-success');
                statusBadge.classList.add('bg-danger');

                resultDiv.classList.remove('alert-success');
                resultDiv.classList.add('alert-danger');
                let failureHtml = `<h5><i class="bi bi-x-circle-fill text-danger"></i> 测试失败</h5><p>${data.message}</p>`;

                // 添加故障排除建议
                failureHtml += '<div class="mt-3 p-2 bg-light border-start border-warning border-4">';
                failureHtml += '<p class="mb-1"><strong>可能的解决方案：</strong></p>';
                failureHtml += '<ul class="mb-0">';
                failureHtml += '<li>检查代理地址和端口是否正确</li>';
                failureHtml += '<li>确认代理服务器是否正常运行</li>';
                failureHtml += '<li>检查网络连接是否正常</li>';
                failureHtml += '<li>尝试使用不同的测试URL</li>';
                failureHtml += '</ul>';
                failureHtml += '</div>';

                resultDiv.innerHTML = failureHtml;
            }
        })
        .catch(error => {
            console.error('Error:', error);
            // 更新状态标签
            const statusBadge = document.getElementById('proxy-status');
            statusBadge.textContent = '异常';
            statusBadge.classList.remove('bg-secondary', 'bg-success');
            statusBadge.classList.add('bg-danger');

            resultDiv.classList.remove('alert-success', 'alert-info');
            resultDiv.classList.add('alert-danger');
            resultDiv.innerHTML = `<h5><i class="bi bi-exclamation-triangle-fill text-warning"></i> 请求错误</h5>
                <p>${error.message}</p>
                <div class="mt-2">
                    <strong>调试信息:</strong>
                    <ul>
                        <li>请求URL: /api/test/proxy</li>
                        <li>请求方法: POST</li>
                        <li>请求参数: url=${url || '(空)'}</li>
                    </ul>
                </div>`;
        })
        .finally(() => {
            // 恢复按钮状态
            button.disabled = false;
            spinner.classList.add('d-none');
            resultDiv.classList.remove('d-none');
        });
    });
</script>
{% endblock %}
