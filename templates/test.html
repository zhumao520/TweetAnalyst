{% extends 'base.html' %}

{% block title %}系统测试{% endblock %}

{% block content %}
<div class="container mt-4">
    <h1 class="mb-4">系统测试</h1>

    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">系统状态</h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <h6>系统信息</h6>
                        <ul class="list-group">
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                版本
                                <span class="badge bg-primary rounded-pill">{{ system_status.system.version }}</span>
                            </li>
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                运行时间
                                <span class="badge bg-primary rounded-pill">{{ system_status.system.uptime }}</span>
                            </li>

                        </ul>
                    </div>

                    <div class="mb-3">
                        <h6>配置信息</h6>
                        <ul class="list-group">
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                LLM模型
                                <span class="badge bg-primary rounded-pill">{{ system_status.config.llm_model }}</span>
                            </li>
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                定时任务间隔
                                <span class="badge bg-primary rounded-pill">{{ system_status.config.scheduler_interval }}分钟</span>
                            </li>
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                代理设置
                                <span class="badge bg-primary rounded-pill">{{ system_status.config.proxy }}</span>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">组件状态</h5>
                </div>
                <div class="card-body">
                    <ul class="list-group">
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            Twitter API
                            <span id="twitter-status" class="badge bg-secondary rounded-pill">{{ system_status.components.twitter_api.status }}</span>
                        </li>
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            LLM API
                            <span id="llm-status" class="badge bg-secondary rounded-pill">{{ system_status.components.llm_api.status }}</span>
                        </li>
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            代理
                            <span id="proxy-status" class="badge bg-secondary rounded-pill">{{ system_status.components.proxy.status }}</span>
                        </li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-md-6 mb-4">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">系统诊断</h5>
                </div>
                <div class="card-body">
                    <div class="d-grid gap-2">
                        <button type="button" class="btn btn-primary" id="test-all-btn">
                            <i class="bi bi-lightning-charge"></i> 一键诊断所有组件
                        </button>
                    </div>

                    <div class="mt-3">
                        <div class="list-group">
                            <button type="button" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center" id="test-twitter-btn">
                                <div>
                                    <i class="bi bi-twitter"></i> 测试Twitter连接
                                    <small class="d-block text-muted">检查是否能正常获取Twitter数据</small>
                                </div>
                                <span class="badge bg-secondary rounded-pill" id="twitter-test-badge">未测试</span>
                            </button>

                            <button type="button" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center" id="test-llm-btn">
                                <div>
                                    <i class="bi bi-cpu"></i> 测试LLM API连接
                                    <small class="d-block text-muted">检查是否能正常连接到LLM服务</small>
                                </div>
                                <span class="badge bg-secondary rounded-pill" id="llm-test-badge">未测试</span>
                            </button>

                            <button type="button" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center" id="test-proxy-btn">
                                <div>
                                    <i class="bi bi-globe"></i> 测试代理连接
                                    <small class="d-block text-muted">检查代理服务是否正常工作</small>
                                </div>
                                <span class="badge bg-secondary rounded-pill" id="proxy-test-badge">未测试</span>
                            </button>
                        </div>
                    </div>

                    <div class="mt-3">
                        <div id="test-result" class="alert d-none" style="border: 2px solid; font-weight: 500;"></div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-6 mb-4">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">快速操作</h5>
                </div>
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <div class="d-grid">
                                <button type="button" class="btn btn-success" id="run-task-btn">
                                    <i class="bi bi-play-fill"></i> 立即执行监控任务
                                </button>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="d-grid">
                                <a href="/accounts" class="btn btn-primary">
                                    <i class="bi bi-person-badge"></i> 管理监控账号
                                </a>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="d-grid">
                                <a href="/unified_settings" class="btn btn-info">
                                    <i class="bi bi-gear"></i> 系统设置
                                </a>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="d-grid">
                                <a href="/results" class="btn btn-secondary">
                                    <i class="bi bi-list-check"></i> 查看分析结果
                                </a>
                            </div>
                        </div>
                    </div>

                    <div class="mt-4">
                        <h6><i class="bi bi-info-circle"></i> 系统提示</h6>
                        <div class="alert alert-light border">
                            <ul class="mb-0">
                                <li>定时任务每 <strong>{{ system_status.config.scheduler_interval }}分钟</strong> 自动执行一次</li>
                                <li>当前使用的LLM模型: <strong>{{ system_status.config.llm_model }}</strong></li>
                                <li>如需更改设置，请前往 <a href="/unified_settings">统一设置中心</a></li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-12 mb-4">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">系统日志</h5>
                    <button class="btn btn-sm btn-outline-secondary" id="refresh-logs-btn">
                        <i class="bi bi-arrow-clockwise"></i> 刷新
                    </button>
                </div>
                <div class="card-body">
                    <div class="alert alert-info">
                        <i class="bi bi-info-circle"></i> 此处显示最近的系统日志，帮助您排查问题。
                    </div>
                    <div class="bg-dark text-light p-3 rounded" style="max-height: 300px; overflow-y: auto;">
                        <pre id="system-logs" class="mb-0"><code>正在加载系统日志...</code></pre>
                    </div>
                    <div class="d-flex justify-content-between mt-2">
                        <div class="btn-group btn-group-sm">
                            <button class="btn btn-outline-secondary active" id="log-level-info">信息</button>
                            <button class="btn btn-outline-secondary" id="log-level-warning">警告</button>
                            <button class="btn btn-outline-secondary" id="log-level-error">错误</button>
                            <button class="btn btn-outline-secondary" id="log-level-debug">调试</button>
                        </div>
                        <div>
                            <select class="form-select form-select-sm" id="log-lines">
                                <option value="20">20行</option>
                                <option value="50" selected>50行</option>
                                <option value="100">100行</option>
                                <option value="200">200行</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // 全局变量
    const resultDiv = document.getElementById('test-result');

    // 测试Twitter连接
    function testTwitter() {
        const badge = document.getElementById('twitter-test-badge');
        const statusBadge = document.getElementById('twitter-status');

        // 更新状态
        badge.textContent = '测试中...';
        badge.classList.remove('bg-secondary', 'bg-success', 'bg-danger');
        badge.classList.add('bg-info');

        // 显示结果区域
        resultDiv.classList.remove('d-none', 'alert-success', 'alert-danger');
        resultDiv.classList.add('alert-info');
        resultDiv.innerHTML = '<h5><i class="bi bi-hourglass-split text-info"></i> 正在测试Twitter连接...</h5><p>正在连接Twitter API，请稍候...</p><div class="progress mt-2"><div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 100%"></div></div>';

        // 发送请求
        return fetch('/api/test/twitter', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({}),
        })
        .then(response => response.json())
        .then(data => {
            // 更新状态标签
            if (data.success) {
                badge.textContent = '正常';
                badge.classList.remove('bg-info', 'bg-secondary', 'bg-danger');
                badge.classList.add('bg-success');

                statusBadge.textContent = '正常';
                statusBadge.classList.remove('bg-secondary', 'bg-danger');
                statusBadge.classList.add('bg-success');

                resultDiv.classList.remove('alert-danger', 'alert-info');
                resultDiv.classList.add('alert-success');

                let resultHtml = `<h5><i class="bi bi-check-circle-fill text-success"></i> Twitter连接测试成功</h5><p>${data.message}</p>`;
                if (data.data) {
                    resultHtml += '<ul>';
                    if (data.data.account_id) resultHtml += `<li>账号ID: ${data.data.account_id}</li>`;
                    if (data.data.post_count) resultHtml += `<li>获取推文数: ${data.data.post_count}</li>`;
                    if (data.data.response_time) resultHtml += `<li>响应时间: ${data.data.response_time}</li>`;
                    resultHtml += '</ul>';
                }
                resultDiv.innerHTML = resultHtml;
            } else {
                badge.textContent = '异常';
                badge.classList.remove('bg-info', 'bg-secondary', 'bg-success');
                badge.classList.add('bg-danger');

                statusBadge.textContent = '异常';
                statusBadge.classList.remove('bg-secondary', 'bg-success');
                statusBadge.classList.add('bg-danger');

                resultDiv.classList.remove('alert-success', 'alert-info');
                resultDiv.classList.add('alert-danger');

                let failureHtml = `<h5><i class="bi bi-x-circle-fill text-danger"></i> Twitter连接测试失败</h5><p>${data.message}</p>`;

                // 添加故障排除建议
                failureHtml += '<div class="mt-3 p-2 bg-light border-start border-warning border-4">';
                failureHtml += '<p class="mb-1"><strong>可能的解决方案：</strong></p>';
                failureHtml += '<ul class="mb-0">';
                failureHtml += '<li>检查网络连接是否正常</li>';
                failureHtml += '<li>确认Twitter账号ID是否正确</li>';
                failureHtml += '<li>检查代理设置是否正确</li>';
                failureHtml += '<li>尝试使用不同的Twitter账号</li>';
                failureHtml += '</ul>';
                failureHtml += '</div>';

                resultDiv.innerHTML = failureHtml;
            }
            return data.success;
        })
        .catch(error => {
            console.error('Error:', error);

            badge.textContent = '错误';
            badge.classList.remove('bg-info', 'bg-secondary', 'bg-success');
            badge.classList.add('bg-danger');

            statusBadge.textContent = '异常';
            statusBadge.classList.remove('bg-secondary', 'bg-success');
            statusBadge.classList.add('bg-danger');

            resultDiv.classList.remove('alert-success', 'alert-info');
            resultDiv.classList.add('alert-danger');
            resultDiv.innerHTML = `<h5><i class="bi bi-exclamation-triangle-fill text-warning"></i> Twitter连接请求错误</h5>
                <p>${error.message}</p>
                <div class="mt-2">
                    <strong>调试信息:</strong>
                    <ul>
                        <li>请求URL: /api/test/twitter</li>
                        <li>请求方法: POST</li>
                    </ul>
                </div>`;
            return false;
        });
    }

    // 测试LLM API连接
    function testLLM() {
        const badge = document.getElementById('llm-test-badge');
        const statusBadge = document.getElementById('llm-status');

        // 更新状态
        badge.textContent = '测试中...';
        badge.classList.remove('bg-secondary', 'bg-success', 'bg-danger');
        badge.classList.add('bg-info');

        // 显示结果区域
        resultDiv.classList.remove('d-none', 'alert-success', 'alert-danger');
        resultDiv.classList.add('alert-info');
        resultDiv.innerHTML = '<h5><i class="bi bi-hourglass-split text-info"></i> 正在测试LLM API连接...</h5><p>正在连接LLM API，请稍候...</p><div class="progress mt-2"><div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 100%"></div></div>';

        // 发送请求
        return fetch('/api/test/llm', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({}),
        })
        .then(response => response.json())
        .then(data => {
            // 更新状态标签
            if (data.success) {
                badge.textContent = '正常';
                badge.classList.remove('bg-info', 'bg-secondary', 'bg-danger');
                badge.classList.add('bg-success');

                statusBadge.textContent = '正常';
                statusBadge.classList.remove('bg-secondary', 'bg-danger');
                statusBadge.classList.add('bg-success');

                resultDiv.classList.remove('alert-danger', 'alert-info');
                resultDiv.classList.add('alert-success');

                let resultHtml = `<h5><i class="bi bi-check-circle-fill text-success"></i> LLM API连接测试成功</h5><p>${data.message}</p>`;
                if (data.data) {
                    resultHtml += '<ul>';
                    if (data.data.model) resultHtml += `<li>模型: ${data.data.model}</li>`;
                    if (data.data.response_time) resultHtml += `<li>响应时间: ${data.data.response_time}</li>`;
                    resultHtml += '</ul>';

                    if (data.data.response) {
                        resultHtml += '<h6>LLM响应示例:</h6>';
                        resultHtml += `<div class="p-2 bg-light">${data.data.response.substring(0, 200)}${data.data.response.length > 200 ? '...' : ''}</div>`;
                    }
                }
                resultDiv.innerHTML = resultHtml;
            } else {
                badge.textContent = '异常';
                badge.classList.remove('bg-info', 'bg-secondary', 'bg-success');
                badge.classList.add('bg-danger');

                statusBadge.textContent = '异常';
                statusBadge.classList.remove('bg-secondary', 'bg-success');
                statusBadge.classList.add('bg-danger');

                resultDiv.classList.remove('alert-success', 'alert-info');
                resultDiv.classList.add('alert-danger');

                let failureHtml = `<h5><i class="bi bi-x-circle-fill text-danger"></i> LLM API连接测试失败</h5><p>${data.message}</p>`;

                // 添加故障排除建议
                failureHtml += '<div class="mt-3 p-2 bg-light border-start border-warning border-4">';
                failureHtml += '<p class="mb-1"><strong>可能的解决方案：</strong></p>';
                failureHtml += '<ul class="mb-0">';
                failureHtml += '<li>检查LLM API密钥是否正确</li>';
                failureHtml += '<li>确认API基础URL是否正确（默认为https://api.x.ai/v1）</li>';
                failureHtml += '<li>检查网络连接是否正常</li>';
                failureHtml += '<li>检查代理设置是否正确</li>';
                failureHtml += '</ul>';
                failureHtml += '</div>';

                resultDiv.innerHTML = failureHtml;
            }
            return data.success;
        })
        .catch(error => {
            console.error('Error:', error);

            badge.textContent = '错误';
            badge.classList.remove('bg-info', 'bg-secondary', 'bg-success');
            badge.classList.add('bg-danger');

            statusBadge.textContent = '异常';
            statusBadge.classList.remove('bg-secondary', 'bg-success');
            statusBadge.classList.add('bg-danger');

            resultDiv.classList.remove('alert-success', 'alert-info');
            resultDiv.classList.add('alert-danger');
            resultDiv.innerHTML = `<h5><i class="bi bi-exclamation-triangle-fill text-warning"></i> LLM API连接请求错误</h5>
                <p>${error.message}</p>
                <div class="mt-2">
                    <strong>调试信息:</strong>
                    <ul>
                        <li>请求URL: /api/test/llm</li>
                        <li>请求方法: POST</li>
                    </ul>
                </div>`;
            return false;
        });
    }

    // 测试代理连接
    function testProxy() {
        const badge = document.getElementById('proxy-test-badge');
        const statusBadge = document.getElementById('proxy-status');

        // 更新状态
        badge.textContent = '测试中...';
        badge.classList.remove('bg-secondary', 'bg-success', 'bg-danger');
        badge.classList.add('bg-info');

        // 显示结果区域
        resultDiv.classList.remove('d-none', 'alert-success', 'alert-danger');
        resultDiv.classList.add('alert-info');
        resultDiv.innerHTML = '<h5><i class="bi bi-hourglass-split text-info"></i> 正在测试代理连接...</h5><p>正在测试代理连接，请稍候...</p><div class="progress mt-2"><div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 100%"></div></div>';

        // 发送请求
        return fetch('/api/test/proxy', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({}),
        })
        .then(response => response.json())
        .then(data => {
            // 更新状态标签
            if (data.success) {
                badge.textContent = '正常';
                badge.classList.remove('bg-info', 'bg-secondary', 'bg-danger');
                badge.classList.add('bg-success');

                statusBadge.textContent = '正常';
                statusBadge.classList.remove('bg-secondary', 'bg-danger');
                statusBadge.classList.add('bg-success');

                resultDiv.classList.remove('alert-danger', 'alert-info');
                resultDiv.classList.add('alert-success');

                let resultHtml = `<h5><i class="bi bi-check-circle-fill text-success"></i> 代理连接测试成功</h5><p>${data.message}</p>`;
                if (data.data) {
                    resultHtml += '<ul>';
                    if (data.data.url) resultHtml += `<li>测试URL: ${data.data.url}</li>`;
                    if (data.data.ip) resultHtml += `<li>当前IP: ${data.data.ip}</li>`;
                    if (data.data.proxy) resultHtml += `<li>代理设置: ${data.data.proxy}</li>`;
                    if (data.data.response_time) resultHtml += `<li>响应时间: ${data.data.response_time}</li>`;
                    resultHtml += '</ul>';
                }
                resultDiv.innerHTML = resultHtml;
            } else {
                badge.textContent = '异常';
                badge.classList.remove('bg-info', 'bg-secondary', 'bg-success');
                badge.classList.add('bg-danger');

                statusBadge.textContent = '异常';
                statusBadge.classList.remove('bg-secondary', 'bg-success');
                statusBadge.classList.add('bg-danger');

                resultDiv.classList.remove('alert-success', 'alert-info');
                resultDiv.classList.add('alert-danger');

                let failureHtml = `<h5><i class="bi bi-x-circle-fill text-danger"></i> 代理连接测试失败</h5><p>${data.message}</p>`;

                // 添加故障排除建议
                failureHtml += '<div class="mt-3 p-2 bg-light border-start border-warning border-4">';
                failureHtml += '<p class="mb-1"><strong>可能的解决方案：</strong></p>';
                failureHtml += '<ul class="mb-0">';
                failureHtml += '<li>检查代理地址和端口是否正确</li>';
                failureHtml += '<li>确认代理服务器是否正常运行</li>';
                failureHtml += '<li>检查网络连接是否正常</li>';
                failureHtml += '</ul>';
                failureHtml += '</div>';

                resultDiv.innerHTML = failureHtml;
            }
            return data.success;
        })
        .catch(error => {
            console.error('Error:', error);

            badge.textContent = '错误';
            badge.classList.remove('bg-info', 'bg-secondary', 'bg-success');
            badge.classList.add('bg-danger');

            statusBadge.textContent = '异常';
            statusBadge.classList.remove('bg-secondary', 'bg-success');
            statusBadge.classList.add('bg-danger');

            resultDiv.classList.remove('alert-success', 'alert-info');
            resultDiv.classList.add('alert-danger');
            resultDiv.innerHTML = `<h5><i class="bi bi-exclamation-triangle-fill text-warning"></i> 代理连接请求错误</h5>
                <p>${error.message}</p>
                <div class="mt-2">
                    <strong>调试信息:</strong>
                    <ul>
                        <li>请求URL: /api/test/proxy</li>
                        <li>请求方法: POST</li>
                    </ul>
                </div>`;
            return false;
        });
    }

    // 一键诊断所有组件
    async function testAll() {
        // 禁用所有按钮
        document.getElementById('test-all-btn').disabled = true;
        document.getElementById('test-twitter-btn').disabled = true;
        document.getElementById('test-llm-btn').disabled = true;
        document.getElementById('test-proxy-btn').disabled = true;

        // 显示初始状态信息
        resultDiv.classList.remove('d-none', 'alert-success', 'alert-danger');
        resultDiv.classList.add('alert-info');
        resultDiv.innerHTML = '<h5><i class="bi bi-hourglass-split text-info"></i> 正在执行系统诊断...</h5><p>正在依次测试各个组件，请稍候...</p><div class="progress mt-2"><div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 100%"></div></div>';

        // 依次测试各个组件
        let twitterResult = false;
        let llmResult = false;
        let proxyResult = false;

        try {
            // 测试Twitter连接
            resultDiv.innerHTML = '<h5><i class="bi bi-hourglass-split text-info"></i> 正在执行系统诊断...</h5><p>正在测试Twitter连接 (1/3)...</p><div class="progress mt-2"><div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 33%"></div></div>';
            twitterResult = await testTwitter();

            // 测试LLM API连接
            resultDiv.innerHTML = '<h5><i class="bi bi-hourglass-split text-info"></i> 正在执行系统诊断...</h5><p>正在测试LLM API连接 (2/3)...</p><div class="progress mt-2"><div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 66%"></div></div>';
            llmResult = await testLLM();

            // 测试代理连接
            resultDiv.innerHTML = '<h5><i class="bi bi-hourglass-split text-info"></i> 正在执行系统诊断...</h5><p>正在测试代理连接 (3/3)...</p><div class="progress mt-2"><div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 100%"></div></div>';
            proxyResult = await testProxy();

            // 显示诊断结果
            const successCount = (twitterResult ? 1 : 0) + (llmResult ? 1 : 0) + (proxyResult ? 1 : 0);

            if (successCount === 3) {
                resultDiv.classList.remove('alert-info', 'alert-danger');
                resultDiv.classList.add('alert-success');
                resultDiv.innerHTML = `<h5><i class="bi bi-check-circle-fill text-success"></i> 系统诊断完成</h5>
                    <p>所有组件测试通过，系统运行正常！</p>
                    <div class="mt-3">
                        <div class="d-flex justify-content-between mb-2">
                            <span><i class="bi bi-twitter"></i> Twitter连接</span>
                            <span class="badge bg-success">正常</span>
                        </div>
                        <div class="d-flex justify-content-between mb-2">
                            <span><i class="bi bi-cpu"></i> LLM API连接</span>
                            <span class="badge bg-success">正常</span>
                        </div>
                        <div class="d-flex justify-content-between mb-2">
                            <span><i class="bi bi-globe"></i> 代理连接</span>
                            <span class="badge bg-success">正常</span>
                        </div>
                    </div>
                    <div class="alert alert-success mt-3">
                        <i class="bi bi-info-circle"></i> 系统各组件运行正常，您可以放心使用所有功能。
                    </div>`;
            } else if (successCount === 0) {
                resultDiv.classList.remove('alert-info', 'alert-success');
                resultDiv.classList.add('alert-danger');
                resultDiv.innerHTML = `<h5><i class="bi bi-x-circle-fill text-danger"></i> 系统诊断完成</h5>
                    <p>所有组件测试失败，系统可能无法正常工作！</p>
                    <div class="mt-3">
                        <div class="d-flex justify-content-between mb-2">
                            <span><i class="bi bi-twitter"></i> Twitter连接</span>
                            <span class="badge bg-danger">异常</span>
                        </div>
                        <div class="d-flex justify-content-between mb-2">
                            <span><i class="bi bi-cpu"></i> LLM API连接</span>
                            <span class="badge bg-danger">异常</span>
                        </div>
                        <div class="d-flex justify-content-between mb-2">
                            <span><i class="bi bi-globe"></i> 代理连接</span>
                            <span class="badge bg-danger">异常</span>
                        </div>
                    </div>
                    <div class="alert alert-danger mt-3">
                        <i class="bi bi-exclamation-triangle-fill"></i> 系统所有组件都存在问题，请检查网络连接和系统配置。
                    </div>`;
            } else {
                resultDiv.classList.remove('alert-info');
                resultDiv.classList.add('alert-warning');
                resultDiv.innerHTML = `<h5><i class="bi bi-exclamation-triangle-fill text-warning"></i> 系统诊断完成</h5>
                    <p>部分组件测试通过，系统可能无法正常工作！</p>
                    <div class="mt-3">
                        <div class="d-flex justify-content-between mb-2">
                            <span><i class="bi bi-twitter"></i> Twitter连接</span>
                            <span class="badge ${twitterResult ? 'bg-success' : 'bg-danger'}">${twitterResult ? '正常' : '异常'}</span>
                        </div>
                        <div class="d-flex justify-content-between mb-2">
                            <span><i class="bi bi-cpu"></i> LLM API连接</span>
                            <span class="badge ${llmResult ? 'bg-success' : 'bg-danger'}">${llmResult ? '正常' : '异常'}</span>
                        </div>
                        <div class="d-flex justify-content-between mb-2">
                            <span><i class="bi bi-globe"></i> 代理连接</span>
                            <span class="badge ${proxyResult ? 'bg-success' : 'bg-danger'}">${proxyResult ? '正常' : '异常'}</span>
                        </div>
                    </div>
                    <div class="alert alert-warning mt-3">
                        <i class="bi bi-info-circle"></i> 系统部分组件存在问题，请检查相关配置。
                    </div>`;
            }
        } catch (error) {
            console.error('Error during system diagnosis:', error);
            resultDiv.classList.remove('alert-info', 'alert-success');
            resultDiv.classList.add('alert-danger');
            resultDiv.innerHTML = `<h5><i class="bi bi-exclamation-triangle-fill text-danger"></i> 系统诊断出错</h5>
                <p>执行诊断过程中发生错误：${error.message}</p>
                <div class="alert alert-danger mt-3">
                    <i class="bi bi-exclamation-triangle-fill"></i> 请刷新页面后重试，或联系系统管理员。
                </div>`;
        } finally {
            // 恢复按钮状态
            document.getElementById('test-all-btn').disabled = false;
            document.getElementById('test-twitter-btn').disabled = false;
            document.getElementById('test-llm-btn').disabled = false;
            document.getElementById('test-proxy-btn').disabled = false;
        }
    }

    // 获取系统日志
    function fetchSystemLogs() {
        const logsContainer = document.getElementById('system-logs');
        logsContainer.innerHTML = '<code>正在加载系统日志...</code>';

        // 获取当前选择的日志级别和行数
        let level = 'info';
        document.querySelectorAll('.btn-group .btn').forEach(btn => {
            if (btn.classList.contains('active')) {
                if (btn.id === 'log-level-debug') level = 'debug';
                else if (btn.id === 'log-level-warning') level = 'warning';
                else if (btn.id === 'log-level-error') level = 'error';
                else level = 'info';
            }
        });

        const lines = document.getElementById('log-lines').value;

        // 调用API获取系统日志
        fetch(`/api/logs/system?lines=${lines}&level=${level}`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    if (data.data.log_entries && data.data.log_entries.length > 0) {
                        // 格式化日志，添加颜色
                        const formattedLogs = data.data.log_entries.map(log => {
                            // 为不同级别的日志添加颜色
                            if (log.includes('[ERROR]') || log.includes('[CRITICAL]')) {
                                return `<span class="text-danger">${log}</span>`;
                            } else if (log.includes('[WARNING]')) {
                                return `<span class="text-warning">${log}</span>`;
                            } else if (log.includes('[DEBUG]')) {
                                return `<span class="text-info">${log}</span>`;
                            } else {
                                return log;
                            }
                        });

                        logsContainer.innerHTML = `<code>${formattedLogs.join('\n')}</code>`;
                    } else {
                        logsContainer.innerHTML = '<code>暂无日志记录</code>';
                    }
                } else {
                    logsContainer.innerHTML = `<code>获取日志失败: ${data.message}</code>`;
                }
            })
            .catch(error => {
                console.error('Error fetching logs:', error);
                logsContainer.innerHTML = `<code>请求错误: ${error.message}</code>`;
            });
    }

    // 事件监听器
    document.addEventListener('DOMContentLoaded', function() {
        // 测试按钮事件监听
        document.getElementById('test-all-btn').addEventListener('click', testAll);
        document.getElementById('test-twitter-btn').addEventListener('click', testTwitter);
        document.getElementById('test-llm-btn').addEventListener('click', testLLM);
        document.getElementById('test-proxy-btn').addEventListener('click', testProxy);

        // 刷新日志按钮事件监听
        document.getElementById('refresh-logs-btn').addEventListener('click', fetchSystemLogs);

        // 日志级别按钮事件监听
        document.querySelectorAll('.btn-group .btn').forEach(btn => {
            btn.addEventListener('click', function() {
                // 移除所有按钮的active类
                document.querySelectorAll('.btn-group .btn').forEach(b => {
                    b.classList.remove('active');
                });
                // 添加当前按钮的active类
                this.classList.add('active');
                // 刷新日志
                fetchSystemLogs();
            });
        });

        // 日志行数选择事件监听
        document.getElementById('log-lines').addEventListener('change', fetchSystemLogs);

        // 立即执行监控任务按钮事件监听
        document.getElementById('run-task-btn').addEventListener('click', function(e) {
            e.preventDefault();

            if (confirm('确定要立即执行监控任务吗？')) {
                fetch('/api/tasks/run', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({}),
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert('监控任务已启动，请稍后查看结果。');
                    } else {
                        alert('启动监控任务失败: ' + data.message);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('请求错误: ' + error.message);
                });
            }
        });

        // 初始加载系统日志
        fetchSystemLogs();
    });
</script>
{% endblock %}
