{% extends "base.html" %}

{% block title %}é…ç½®ç®¡ç† - TweetAnalyst{% endblock %}

{% block head %}
<!-- é¢„åŠ è½½CodeMirrorèµ„æº -->
<link rel="preload" href="https://cdn.jsdelivr.net/npm/codemirror@5.65.0/lib/codemirror.min.css" as="style">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/codemirror@5.65.0/lib/codemirror.min.js" as="script">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/codemirror@5.65.0/mode/yaml/yaml.min.js" as="script">
{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/codemirror@5.65.0/lib/codemirror.min.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/codemirror@5.65.0/theme/monokai.min.css">
<style>
    .CodeMirror {
        height: 500px;
        border: 1px solid #ddd;
        font-family: 'Fira Code', 'Consolas', monospace;
        font-size: 14px;
    }

    .editor-toolbar {
        padding: 10px;
        background-color: #f8f9fa;
        border: 1px solid #ddd;
        border-bottom: none;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .editor-toolbar .btn-group {
        margin-right: 10px;
    }

    .config-container {
        position: relative;
    }

    .config-status {
        position: absolute;
        bottom: 10px;
        right: 10px;
        padding: 5px 10px;
        border-radius: 4px;
        background-color: rgba(0, 0, 0, 0.7);
        color: white;
        font-size: 12px;
        z-index: 100;
        display: none;
    }

    .config-help {
        max-height: 500px;
        overflow-y: auto;
    }

    /* è´¦å·å¡ç‰‡æ ·å¼ */
    .account-card {
        transition: all 0.3s ease;
        border: 1px solid #dee2e6;
    }

    .account-card:hover {
        box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
        transform: translateY(-5px);
    }

    .account-card .card-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .account-card .card-body {
        padding: 1rem;
    }

    .account-card .card-footer {
        background-color: #f8f9fa;
        border-top: 1px solid #dee2e6;
        padding: 0.75rem 1rem;
    }

    .add-account-card {
        height: 100%;
        border: 2px dashed #dee2e6;
        display: flex;
        justify-content: center;
        align-items: center;
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .add-account-card:hover {
        border-color: #6c757d;
        background-color: #f8f9fa;
    }

    /* æç¤ºè¯ç¼–è¾‘å™¨æ ·å¼ */
    #account-prompt {
        font-family: 'Fira Code', 'Consolas', monospace;
        font-size: 14px;
        resize: vertical;
    }

    /* æ¨¡æ¿æç¤ºæ ·å¼ */
    .template-preview {
        position: fixed;
        bottom: 20px;
        right: 20px;
        max-width: 400px;
        z-index: 1050;
    }
</style>
{% endblock %}

{% block content %}
<div class="row mb-3">
    <div class="col-12">
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="{{ url_for('index') }}">é¦–é¡µ</a></li>
                <li class="breadcrumb-item active" aria-current="page">é…ç½®ç®¡ç†</li>
            </ol>
        </nav>
    </div>
</div>

<div class="row">
    <div class="col-md-12 mb-4">
        <div class="card shadow-sm">
            <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                <h4 class="mb-0">
                    <i class="bi bi-gear-fill me-2"></i>ç¤¾äº¤åª’ä½“é…ç½®
                </h4>
                <div>
                    <button type="button" class="btn btn-light btn-sm me-2" id="show-help">
                        <i class="bi bi-question-circle"></i> å¸®åŠ©
                    </button>
                    <button type="button" class="btn btn-success" id="save-config">
                        <i class="bi bi-save"></i> ä¿å­˜é…ç½®
                    </button>
                </div>
            </div>

            <ul class="nav nav-tabs" id="configTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="form-tab" data-bs-toggle="tab" data-bs-target="#form-view" type="button" role="tab">è¡¨å•è§†å›¾</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="yaml-tab" data-bs-toggle="tab" data-bs-target="#yaml-view" type="button" role="tab">YAMLç¼–è¾‘å™¨</button>
                </li>
            </ul>

            <div class="tab-content" id="configTabContent">
                <!-- è¡¨å•è§†å›¾ -->
                <div class="tab-pane fade show active p-3" id="form-view" role="tabpanel">
                    <div class="mb-3">
                        <button type="button" class="btn btn-primary" id="add-account-btn">
                            <i class="bi bi-plus-circle me-1"></i>æ·»åŠ æ–°è´¦å·
                        </button>
                    </div>

                    <div id="accounts-container" class="row">
                        <!-- è´¦å·å¡ç‰‡å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
                    </div>
                </div>

                <!-- YAMLç¼–è¾‘å™¨è§†å›¾ -->
                <div class="tab-pane fade" id="yaml-view" role="tabpanel">
                    <div class="editor-toolbar">
                        <div class="btn-group" role="group" aria-label="ç¼–è¾‘å™¨å·¥å…·æ ">
                            <button type="button" class="btn btn-sm btn-outline-secondary" id="format-yaml">
                                <i class="bi bi-text-indent-left"></i> æ ¼å¼åŒ–
                            </button>
                            <button type="button" class="btn btn-sm btn-outline-secondary" id="validate-yaml">
                                <i class="bi bi-check-circle"></i> éªŒè¯
                            </button>
                        </div>
                        <div class="editor-info">
                            <small class="text-muted">è¡Œ: <span id="cursor-line">1</span>, åˆ—: <span id="cursor-ch">1</span></small>
                        </div>
                    </div>

                    <div class="config-container">
                        <form method="post" id="config-form">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                            <textarea id="config-editor" name="config">{{ config }}</textarea>
                        </form>
                        <div class="config-status" id="config-status"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- å¸®åŠ©æ¨¡æ€æ¡† -->
<div class="modal fade" id="help-modal" tabindex="-1" aria-labelledby="help-modal-label" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="help-modal-label">é…ç½®æ–‡ä»¶å¸®åŠ©</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="å…³é—­"></button>
            </div>
            <div class="modal-body config-help">
                <h5>YAMLé…ç½®æ ¼å¼è¯´æ˜</h5>
                <p>é…ç½®æ–‡ä»¶ä½¿ç”¨YAMLæ ¼å¼ï¼ŒåŒ…å«ä»¥ä¸‹ä¸»è¦éƒ¨åˆ†ï¼š</p>

                <div class="card mb-3">
                    <div class="card-header">ç¤¾äº¤åª’ä½“è´¦å·é…ç½®</div>
                    <div class="card-body">
                        <pre><code>social_networks:
  - type: twitter
    socialNetworkId: username
    tag: finance
    prompt: "è‡ªå®šä¹‰æç¤ºè¯..."
    bypass_ai: false</code></pre>

                        <ul class="mt-3">
                            <li><strong>type</strong>: ç¤¾äº¤åª’ä½“ç±»å‹ï¼Œç›®å‰æ”¯æŒ twitter</li>
                            <li><strong>socialNetworkId</strong>: è´¦å·IDæˆ–ç”¨æˆ·å</li>
                            <li><strong>tag</strong>: æ ‡ç­¾ï¼Œç”¨äºåˆ†ç±»å’Œä½¿ç”¨ä¸åŒçš„æç¤ºè¯æ¨¡æ¿</li>
                            <li><strong>prompt</strong>: è‡ªå®šä¹‰æç¤ºè¯ï¼Œå¦‚æœä¸æä¾›åˆ™ä½¿ç”¨é»˜è®¤æç¤ºè¯</li>
                            <li><strong>bypass_ai</strong>: æ˜¯å¦ç»•è¿‡AIåˆ¤æ–­ç›´æ¥æ¨é€ï¼Œé»˜è®¤ä¸ºfalse</li>
                        </ul>
                    </div>
                </div>

                <h5>é”®ç›˜å¿«æ·é”®</h5>
                <ul>
                    <li><kbd>Ctrl</kbd> + <kbd>S</kbd>: ä¿å­˜é…ç½®</li>
                    <li><kbd>Ctrl</kbd> + <kbd>F</kbd>: æŸ¥æ‰¾</li>
                    <li><kbd>Ctrl</kbd> + <kbd>Space</kbd>: è‡ªåŠ¨å®Œæˆ</li>
                    <li><kbd>F11</kbd>: å…¨å±ç¼–è¾‘</li>
                </ul>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å…³é—­</button>
            </div>
        </div>
    </div>
</div>

<!-- è´¦å·ç¼–è¾‘æ¨¡æ€æ¡† -->
<div class="modal fade" id="account-modal" tabindex="-1" aria-labelledby="account-modal-label" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="account-modal-label">ç¼–è¾‘è´¦å·</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="å…³é—­"></button>
            </div>
            <div class="modal-body">
                <form id="account-form">
                    <input type="hidden" id="account-index" value="-1">

                    <div class="row mb-3">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="account-type" class="form-label">å¹³å°ç±»å‹</label>
                                <select class="form-select" id="account-type" required>
                                    <option value="twitter">Twitter</option>
                                    <option value="weibo">å¾®åš</option>
                                </select>
                            </div>

                            <div class="mb-3">
                                <label for="account-id" class="form-label">è´¦å·ID</label>
                                <div class="input-group">
                                    <span class="input-group-text">@</span>
                                    <input type="text" class="form-control" id="account-id" placeholder="ç”¨æˆ·å" required>
                                </div>
                                <div class="form-text">ä¸åŒ…å«@ç¬¦å·çš„ç”¨æˆ·å</div>
                            </div>

                            <div class="mb-3">
                                <label for="account-tag" class="form-label">æ ‡ç­¾</label>
                                <input type="text" class="form-control" id="account-tag" placeholder="ä¾‹å¦‚: finance">
                                <div class="form-text">ç”¨äºåˆ†ç±»å’Œä½¿ç”¨ä¸åŒçš„æç¤ºè¯æ¨¡æ¿</div>
                            </div>

                            <div class="mb-3 form-check">
                                <input type="checkbox" class="form-check-input" id="account-auto-reply">
                                <label class="form-check-label" for="account-auto-reply">å¯ç”¨è‡ªåŠ¨å›å¤</label>
                            </div>

                            <div class="mb-3 form-check">
                                <input type="checkbox" class="form-check-input" id="account-bypass-ai">
                                <label class="form-check-label" for="account-bypass-ai">ç»•è¿‡AIåˆ¤æ–­ç›´æ¥æ¨é€</label>
                            </div>
                        </div>

                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="account-prompt" class="form-label">æç¤ºè¯æ¨¡æ¿</label>
                                <div class="d-flex justify-content-end mb-2">
                                    <div class="dropdown">
                                        <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" id="templateDropdown" data-bs-toggle="dropdown">
                                            æ’å…¥æ¨¡æ¿
                                        </button>
                                        <ul class="dropdown-menu">
                                            <li><a class="dropdown-item template-item" href="#" data-template="finance">è´¢ç»åˆ†ææ¨¡æ¿</a></li>
                                            <li><a class="dropdown-item template-item" href="#" data-template="tech">ç§‘æŠ€åˆ†ææ¨¡æ¿</a></li>
                                            <li><a class="dropdown-item template-item" href="#" data-template="general">é€šç”¨åˆ†ææ¨¡æ¿</a></li>
                                        </ul>
                                    </div>
                                </div>
                                <textarea class="form-control" id="account-prompt" rows="12" placeholder="è¾“å…¥æç¤ºè¯æ¨¡æ¿..."></textarea>
                                <div class="form-text">æç¤ºè¯ä¸­ä½¿ç”¨ {content} ä½œä¸ºå†…å®¹å ä½ç¬¦</div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
                <button type="button" class="btn btn-primary" id="save-account-btn">ä¿å­˜è´¦å·</button>
            </div>
        </div>
    </div>
</div>

<!-- åˆ é™¤ç¡®è®¤æ¨¡æ€æ¡† -->
<div class="modal fade" id="delete-confirm-modal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title">
                    <i class="bi bi-exclamation-triangle me-2"></i>ç¡®è®¤åˆ é™¤
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="å…³é—­"></button>
            </div>
            <div class="modal-body">
                <p>æ‚¨ç¡®å®šè¦åˆ é™¤è´¦å· <strong id="delete-account-name">@username</strong> å—ï¼Ÿ</p>
                <p class="text-danger">æ­¤æ“ä½œä¸å¯é€†ï¼Œè´¦å·é…ç½®å°†è¢«æ°¸ä¹…åˆ é™¤ã€‚</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
                <button type="button" class="btn btn-danger" id="confirm-delete-btn">ç¡®è®¤åˆ é™¤</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/codemirror@5.65.0/lib/codemirror.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/codemirror@5.65.0/mode/yaml/yaml.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/codemirror@5.65.0/addon/edit/matchbrackets.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/codemirror@5.65.0/addon/selection/active-line.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/codemirror@5.65.0/addon/fold/foldcode.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/codemirror@5.65.0/addon/fold/foldgutter.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/codemirror@5.65.0/addon/fold/yaml-fold.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/js-yaml@4.1.0/dist/js-yaml.min.js"></script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // åˆå§‹åŒ–ç¼–è¾‘å™¨
    const editor = CodeMirror.fromTextArea(document.getElementById('config-editor'), {
        mode: 'yaml',
        theme: 'monokai',
        lineNumbers: true,
        indentUnit: 2,
        tabSize: 2,
        lineWrapping: true,
        matchBrackets: true,
        styleActiveLine: true,
        foldGutter: true,
        gutters: ["CodeMirror-linenumbers", "CodeMirror-foldgutter"],
        extraKeys: {
            "Ctrl-S": function(cm) {
                saveConfig();
            },
            "F11": function(cm) {
                cm.setOption("fullScreen", !cm.getOption("fullScreen"));
            },
            "Esc": function(cm) {
                if (cm.getOption("fullScreen")) cm.setOption("fullScreen", false);
            }
        }
    });

    // å…‰æ ‡ä½ç½®æ˜¾ç¤º
    editor.on("cursorActivity", function() {
        const cursor = editor.getCursor();
        document.getElementById('cursor-line').textContent = cursor.line + 1;
        document.getElementById('cursor-ch').textContent = cursor.ch + 1;
    });

    // åˆå§‹åŒ–æç¤ºè¯ç¼–è¾‘å™¨
    let promptEditor = null;

    // è´¦å·æ•°æ®
    let accounts = [];
    let currentAccountIndex = -1;
    let deleteAccountIndex = -1;

    // æ¨¡æ¿æ•°æ®
    const templates = {
        finance: `ä½ ç°åœ¨æ˜¯ä¸€åè´¢ç»ä¸“å®¶ï¼Œè¯·å¯¹ä»¥ä¸‹è´¢ç»åšä¸»çš„å‘è¨€è¿›è¡Œåˆ†æï¼Œå¹¶ç»™æŒ‰æˆ‘æŒ‡å®šçš„æ ¼å¼è¿”å›åˆ†æç»“æœã€‚
è¿™æ˜¯ä½ éœ€è¦åˆ†æçš„å†…å®¹ï¼š{content}
è¿™æ˜¯è¾“å‡ºæ ¼å¼çš„è¯´æ˜ï¼š {
    "is_relevant": "æ˜¯å¦ä¸è´¢ç»ç›¸å…³ï¼Œä¸”ä¸ç¾è‚¡å¸‚åœºæˆ–ç¾å€ºå¸‚åœºæˆ–ç§‘æŠ€è‚¡æˆ–åŠå¯¼ä½“è‚¡æˆ–ä¸­å›½è‚¡ç¥¨å¸‚åœºæˆ–é¦™æ¸¯è‚¡ç¥¨å¸‚åœºæˆ–äººæ°‘å¸å…‘ç¾å…ƒæ±‡ç‡æˆ–ä¸­ç¾å…³ç³»ç›¸å…³ã€‚å¦‚æœç›¸å…³å°±è¿”å›1ï¼Œå¦‚æœä¸ç›¸å…³å°±è¿”å›0ã€‚åªéœ€è¦è¿”å›1æˆ–0è¿™ä¸¤ä¸ªå€¼ä¹‹ä¸€å³å¯",
    "analytical_briefing": "åˆ†æç®€æŠ¥"
}
å…¶ä¸­analytical_briefingçš„å€¼æ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œå®ƒæ˜¯é’ˆå¯¹å†…å®¹æ‰€åšçš„åˆ†æç®€æŠ¥ï¼Œä»…åœ¨is_relevantä¸º1æ—¶ä¼šè¿”å›è¿™ä¸ªå€¼ã€‚
analytical_briefingçš„å†…å®¹æ˜¯markdownæ ¼å¼çš„ï¼Œå®ƒéœ€è¦ç¬¦åˆä¸‹é¢çš„è§„èŒƒ
åŸå§‹æ­£æ–‡ï¼Œä»…å½“éœ€è¦åˆ†æçš„å†…å®¹ä¸æ˜¯ä¸ºä¸­æ–‡æ—¶ï¼Œè¿™éƒ¨åˆ†å†…å®¹æ‰ä¼šä¿ç•™ï¼Œå¦åˆ™è¿™éƒ¨åˆ†çš„å†…å®¹ä¸ºåŸå§‹çš„æ­£æ–‡
ç¿»è¯‘åçš„å†…å®¹ï¼Œä»…å½“éœ€è¦åˆ†æçš„å†…å®¹ä¸ºè‹±æ–‡æ—¶ï¼Œæ‰ä¼šæœ‰è¿™éƒ¨åˆ†çš„å†…å®¹ã€‚
## Brief Analysis
åˆ†æç»“æœã€‚è¿™éƒ¨åˆ†ä¼šå±•ç¤ºä¸€ä¸ªåˆ—è¡¨ï¼Œåˆ—è¡¨ä¸­åˆ†åˆ«åŒ…å«ç¾è‚¡å¸‚åœºã€ç¾å€ºå¸‚åœºã€ç§‘æŠ€è‚¡ã€åŠå¯¼ä½“è‚¡ã€ä¸­å›½è‚¡ç¥¨å¸‚åœºã€é¦™æ¸¯è‚¡ç¥¨å¸‚åœºã€äººæ°‘å¸å…‘ç¾å…ƒæ±‡ç‡ã€ä¸­ç¾å…³ç³»è¿™8ä¸ªé€‰é¡¹ã€‚ æ¯ä¸ªé€‰é¡¹çš„å€¼ä¸ºåˆ†åˆ«ä¸ºğŸ“ˆåˆ©å¤šå’ŒğŸ“‰åˆ©ç©ºã€‚å¦‚æœåˆ†æå†…å®¹å¯¹äºè¯¥é€‰é¡¹æ²¡æœ‰å½±å“ï¼Œå°±ä¸è¦é’ˆå¯¹è¿™ä¸ªé€‰é¡¹è¿”å›ä»»ä½•å†…å®¹ã€‚
## Summarize
è¿™éƒ¨åˆ†éœ€è¦ç”¨éå¸¸ç®€æ˜æ‰¼è¦çš„æ–‡å­—å¯¹åˆ†æç»“æœè¿›è¡Œæ€»ç»“ï¼Œä»¥åŠè§£é‡Šä¸ºä»€ä¹ˆåœ¨ä¸Šé¢é’ˆå¯¹ä¸åŒé€‰é¡¹ä¼šå¾—å‡ºä¸åŒçš„ç»“è®ºã€‚`,
        tech: `ä½ ç°åœ¨æ˜¯ä¸€åç§‘æŠ€ä¸“å®¶ï¼Œè¯·å¯¹ä»¥ä¸‹ç§‘æŠ€åšä¸»çš„å‘è¨€è¿›è¡Œåˆ†æï¼Œå¹¶ç»™æŒ‰æˆ‘æŒ‡å®šçš„æ ¼å¼è¿”å›åˆ†æç»“æœã€‚
è¿™æ˜¯ä½ éœ€è¦åˆ†æçš„å†…å®¹ï¼š{content}
è¿™æ˜¯è¾“å‡ºæ ¼å¼çš„è¯´æ˜ï¼š {
    "is_relevant": "æ˜¯å¦ä¸ç§‘æŠ€ç›¸å…³ï¼Œä¸”ä¸äººå·¥æ™ºèƒ½æˆ–å¤§è¯­è¨€æ¨¡å‹æˆ–èŠ¯ç‰‡æˆ–åŠå¯¼ä½“æˆ–äº‘è®¡ç®—æˆ–åŒºå—é“¾ç›¸å…³ã€‚å¦‚æœç›¸å…³å°±è¿”å›1ï¼Œå¦‚æœä¸ç›¸å…³å°±è¿”å›0ã€‚åªéœ€è¦è¿”å›1æˆ–0è¿™ä¸¤ä¸ªå€¼ä¹‹ä¸€å³å¯",
    "analytical_briefing": "åˆ†æç®€æŠ¥"
}
å…¶ä¸­analytical_briefingçš„å€¼æ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œå®ƒæ˜¯é’ˆå¯¹å†…å®¹æ‰€åšçš„åˆ†æç®€æŠ¥ï¼Œä»…åœ¨is_relevantä¸º1æ—¶ä¼šè¿”å›è¿™ä¸ªå€¼ã€‚
analytical_briefingçš„å†…å®¹æ˜¯markdownæ ¼å¼çš„ï¼Œå®ƒéœ€è¦ç¬¦åˆä¸‹é¢çš„è§„èŒƒ
åŸå§‹æ­£æ–‡ï¼Œä»…å½“éœ€è¦åˆ†æçš„å†…å®¹ä¸æ˜¯ä¸ºä¸­æ–‡æ—¶ï¼Œè¿™éƒ¨åˆ†å†…å®¹æ‰ä¼šä¿ç•™ï¼Œå¦åˆ™è¿™éƒ¨åˆ†çš„å†…å®¹ä¸ºåŸå§‹çš„æ­£æ–‡
ç¿»è¯‘åçš„å†…å®¹ï¼Œä»…å½“éœ€è¦åˆ†æçš„å†…å®¹ä¸ºè‹±æ–‡æ—¶ï¼Œæ‰ä¼šæœ‰è¿™éƒ¨åˆ†çš„å†…å®¹ã€‚
## Brief Analysis
åˆ†æç»“æœã€‚è¿™éƒ¨åˆ†ä¼šå±•ç¤ºä¸€ä¸ªåˆ—è¡¨ï¼Œåˆ—è¡¨ä¸­åˆ†åˆ«åŒ…å«äººå·¥æ™ºèƒ½ã€å¤§è¯­è¨€æ¨¡å‹ã€èŠ¯ç‰‡ã€åŠå¯¼ä½“ã€äº‘è®¡ç®—ã€åŒºå—é“¾è¿™6ä¸ªé€‰é¡¹ã€‚ æ¯ä¸ªé€‰é¡¹çš„å€¼ä¸ºåˆ†åˆ«ä¸ºğŸ“ˆç§¯æå’ŒğŸ“‰æ¶ˆæã€‚å¦‚æœåˆ†æå†…å®¹å¯¹äºè¯¥é€‰é¡¹æ²¡æœ‰å½±å“ï¼Œå°±ä¸è¦é’ˆå¯¹è¿™ä¸ªé€‰é¡¹è¿”å›ä»»ä½•å†…å®¹ã€‚
## Summarize
è¿™éƒ¨åˆ†éœ€è¦ç”¨éå¸¸ç®€æ˜æ‰¼è¦çš„æ–‡å­—å¯¹åˆ†æç»“æœè¿›è¡Œæ€»ç»“ï¼Œä»¥åŠè§£é‡Šä¸ºä»€ä¹ˆåœ¨ä¸Šé¢é’ˆå¯¹ä¸åŒé€‰é¡¹ä¼šå¾—å‡ºä¸åŒçš„ç»“è®ºã€‚`,
        general: `è¯·åˆ†æä»¥ä¸‹ç¤¾äº¤åª’ä½“å†…å®¹ï¼Œåˆ¤æ–­å…¶æ˜¯å¦ä¸æˆ‘ä»¬å…³æ³¨çš„ä¸»é¢˜ç›¸å…³ã€‚
ä¸»é¢˜ï¼šäººå·¥æ™ºèƒ½ã€æœºå™¨å­¦ä¹ ã€æ·±åº¦å­¦ä¹ ã€ç¥ç»ç½‘ç»œã€å¤§è¯­è¨€æ¨¡å‹ç­‰AIç›¸å…³æŠ€æœ¯å’Œåº”ç”¨ã€‚

å†…å®¹ï¼š{content}

è¯·æŒ‰ç…§ä»¥ä¸‹JSONæ ¼å¼å›å¤ï¼š
{
  "is_relevant": true/false,  // æ˜¯å¦ç›¸å…³
  "confidence": 0-100,  // ç½®ä¿¡åº¦ï¼Œ0-100çš„æ•´æ•°
  "reason": "åˆ¤æ–­ç†ç”±",  // ç®€è¦è¯´æ˜åˆ¤æ–­ç†ç”±
  "keywords": ["å…³é”®è¯1", "å…³é”®è¯2"]  // å†…å®¹ä¸­çš„ç›¸å…³å…³é”®è¯
}`
    };

    // ä¿å­˜é…ç½®
    function saveConfig() {
        editor.save();

        // éªŒè¯YAML
        try {
            jsyaml.load(editor.getValue());

            // æ˜¾ç¤ºä¿å­˜çŠ¶æ€
            showStatus("æ­£åœ¨ä¿å­˜...", "info");

            // æäº¤è¡¨å•
            document.getElementById('config-form').submit();
        } catch (e) {
            showStatus("YAMLæ ¼å¼é”™è¯¯: " + e.message, "error");
            return false;
        }
    }

    // æ ¼å¼åŒ–YAML
    function formatYaml() {
        try {
            const yaml = jsyaml.load(editor.getValue());
            const formatted = jsyaml.dump(yaml, {
                indent: 2,
                lineWidth: -1,
                noRefs: true,
                sortKeys: false
            });

            editor.setValue(formatted);
            showStatus("YAMLå·²æ ¼å¼åŒ–", "success");
        } catch (e) {
            showStatus("æ ¼å¼åŒ–å¤±è´¥: " + e.message, "error");
        }
    }

    // éªŒè¯YAML
    function validateYaml() {
        try {
            jsyaml.load(editor.getValue());
            showStatus("YAMLæ ¼å¼æ­£ç¡®", "success");
            return true;
        } catch (e) {
            showStatus("YAMLæ ¼å¼é”™è¯¯: " + e.message, "error");
            return false;
        }
    }

    // æ˜¾ç¤ºçŠ¶æ€ä¿¡æ¯
    function showStatus(message, type) {
        const statusEl = document.getElementById('config-status');
        statusEl.textContent = message;
        statusEl.style.display = 'block';

        // è®¾ç½®çŠ¶æ€ç±»å‹æ ·å¼
        statusEl.className = 'config-status';
        if (type === 'error') {
            statusEl.style.backgroundColor = 'rgba(220, 53, 69, 0.9)';
        } else if (type === 'success') {
            statusEl.style.backgroundColor = 'rgba(25, 135, 84, 0.9)';
        } else if (type === 'info') {
            statusEl.style.backgroundColor = 'rgba(13, 110, 253, 0.9)';
        }

        // 3ç§’åè‡ªåŠ¨éšè—
        setTimeout(function() {
            statusEl.style.display = 'none';
        }, 3000);
    }

    // è§£æYAMLé…ç½®
    function parseConfig() {
        try {
            const config = jsyaml.load(editor.getValue());
            if (config && config.social_networks && Array.isArray(config.social_networks)) {
                accounts = config.social_networks;
                renderAccounts();
            } else {
                accounts = [];
                renderAccounts();
            }
        } catch (e) {
            console.error('è§£æYAMLå¤±è´¥:', e);
            showStatus("è§£æYAMLå¤±è´¥: " + e.message, "error");
        }
    }

    // ç”ŸæˆYAMLé…ç½®
    function generateConfig() {
        const config = {
            social_networks: accounts
        };

        try {
            const yamlStr = jsyaml.dump(config, {
                indent: 2,
                lineWidth: -1,
                noRefs: true,
                sortKeys: false
            });

            editor.setValue(yamlStr);
            showStatus("é…ç½®å·²æ›´æ–°", "success");
        } catch (e) {
            console.error('ç”ŸæˆYAMLå¤±è´¥:', e);
            showStatus("ç”ŸæˆYAMLå¤±è´¥: " + e.message, "error");
        }
    }

    // æ¸²æŸ“è´¦å·å¡ç‰‡
    function renderAccounts() {
        const container = document.getElementById('accounts-container');
        container.innerHTML = '';

        // æ·»åŠ è´¦å·å¡ç‰‡
        accounts.forEach((account, index) => {
            const card = document.createElement('div');
            card.className = 'col-md-4 mb-3';
            card.innerHTML = `
                <div class="card h-100 account-card">
                    <div class="card-header">
                        <h5 class="mb-0">@${account.socialNetworkId || 'æœªå‘½å'}</h5>
                        <span class="badge ${account.type === 'twitter' ? 'bg-primary' : 'bg-danger'}">${account.type || 'unknown'}</span>
                    </div>
                    <div class="card-body">
                        <p><strong>æ ‡ç­¾:</strong> ${account.tag || 'æ— '}</p>
                        <p><strong>è‡ªåŠ¨å›å¤:</strong>
                            <span class="badge ${account.enableAutoReply ? 'bg-success' : 'bg-secondary'}">
                                ${account.enableAutoReply ? 'å¯ç”¨' : 'ç¦ç”¨'}
                            </span>
                        </p>
                        <p><strong>AIåˆ†æ:</strong>
                            <span class="badge ${account.bypass_ai ? 'bg-warning text-dark' : 'bg-info'}">
                                ${account.bypass_ai ? 'ç»•è¿‡' : 'å¯ç”¨'}
                            </span>
                        </p>
                        <p><strong>æç¤ºè¯:</strong>
                            <button class="btn btn-sm btn-outline-secondary view-prompt-btn" data-index="${index}">
                                æŸ¥çœ‹æç¤ºè¯
                            </button>
                        </p>
                    </div>
                    <div class="card-footer">
                        <button class="btn btn-sm btn-primary edit-account-btn" data-index="${index}">
                            <i class="bi bi-pencil me-1"></i>ç¼–è¾‘
                        </button>
                        <button class="btn btn-sm btn-danger delete-account-btn" data-index="${index}">
                            <i class="bi bi-trash me-1"></i>åˆ é™¤
                        </button>
                    </div>
                </div>
            `;
            container.appendChild(card);
        });

        // æ·»åŠ "æ·»åŠ è´¦å·"å¡ç‰‡
        const addCard = document.createElement('div');
        addCard.className = 'col-md-4 mb-3';
        addCard.innerHTML = `
            <div class="card h-100 add-account-card" id="add-account-card">
                <div class="card-body d-flex justify-content-center align-items-center">
                    <div class="text-center">
                        <i class="bi bi-plus-circle fs-1 mb-2"></i>
                        <p class="mb-0">æ·»åŠ æ–°è´¦å·</p>
                    </div>
                </div>
            </div>
        `;
        container.appendChild(addCard);

        // ç»‘å®šäº‹ä»¶
        document.querySelectorAll('.edit-account-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const index = parseInt(this.getAttribute('data-index'));
                editAccount(index);
            });
        });

        document.querySelectorAll('.delete-account-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const index = parseInt(this.getAttribute('data-index'));
                confirmDeleteAccount(index);
            });
        });

        document.querySelectorAll('.view-prompt-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const index = parseInt(this.getAttribute('data-index'));
                viewPrompt(index);
            });
        });

        document.getElementById('add-account-card').addEventListener('click', function() {
            addAccount();
        });
    }

    // ç¼–è¾‘è´¦å·
    function editAccount(index) {
        currentAccountIndex = index;
        const account = accounts[index];

        // å¡«å……è¡¨å•
        document.getElementById('account-modal-label').textContent = 'ç¼–è¾‘è´¦å·';
        document.getElementById('account-index').value = index;
        document.getElementById('account-type').value = account.type || 'twitter';
        document.getElementById('account-id').value = account.socialNetworkId || '';
        document.getElementById('account-tag').value = account.tag || '';
        document.getElementById('account-auto-reply').checked = account.enableAutoReply || false;
        document.getElementById('account-bypass-ai').checked = account.bypass_ai || false;
        document.getElementById('account-prompt').value = account.prompt || '';

        // æ˜¾ç¤ºæ¨¡æ€æ¡†
        const accountModal = new bootstrap.Modal(document.getElementById('account-modal'));
        accountModal.show();
    }

    // æ·»åŠ è´¦å·
    function addAccount() {
        currentAccountIndex = -1;

        // é‡ç½®è¡¨å•
        document.getElementById('account-modal-label').textContent = 'æ·»åŠ æ–°è´¦å·';
        document.getElementById('account-index').value = -1;
        document.getElementById('account-type').value = 'twitter';
        document.getElementById('account-id').value = '';
        document.getElementById('account-tag').value = 'general';
        document.getElementById('account-auto-reply').checked = false;
        document.getElementById('account-bypass-ai').checked = false;
        document.getElementById('account-prompt').value = '';

        // æ˜¾ç¤ºæ¨¡æ€æ¡†
        const accountModal = new bootstrap.Modal(document.getElementById('account-modal'));
        accountModal.show();
    }

    // ä¿å­˜è´¦å·
    function saveAccount() {
        // è·å–è¡¨å•æ•°æ®
        const index = parseInt(document.getElementById('account-index').value);
        const type = document.getElementById('account-type').value;
        const socialNetworkId = document.getElementById('account-id').value.trim();
        const tag = document.getElementById('account-tag').value.trim();
        const enableAutoReply = document.getElementById('account-auto-reply').checked;
        const bypass_ai = document.getElementById('account-bypass-ai').checked;
        const prompt = document.getElementById('account-prompt').value;

        // éªŒè¯æ•°æ®
        if (!socialNetworkId) {
            alert('è¯·è¾“å…¥è´¦å·ID');
            return;
        }

        // åˆ›å»ºè´¦å·å¯¹è±¡
        const account = {
            type,
            socialNetworkId,
            tag,
            enableAutoReply,
            bypass_ai,
            prompt
        };

        // æ·»åŠ æˆ–æ›´æ–°è´¦å·
        if (index >= 0) {
            accounts[index] = account;
        } else {
            accounts.push(account);
        }

        // æ›´æ–°YAML
        generateConfig();

        // é‡æ–°æ¸²æŸ“è´¦å·åˆ—è¡¨
        renderAccounts();

        // å…³é—­æ¨¡æ€æ¡†
        const accountModal = bootstrap.Modal.getInstance(document.getElementById('account-modal'));
        accountModal.hide();

        // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
        showStatus(index >= 0 ? "è´¦å·å·²æ›´æ–°" : "è´¦å·å·²æ·»åŠ ", "success");
    }

    // ç¡®è®¤åˆ é™¤è´¦å·
    function confirmDeleteAccount(index) {
        deleteAccountIndex = index;
        const account = accounts[index];

        // è®¾ç½®ç¡®è®¤ä¿¡æ¯
        document.getElementById('delete-account-name').textContent = '@' + account.socialNetworkId;

        // æ˜¾ç¤ºç¡®è®¤æ¨¡æ€æ¡†
        const deleteModal = new bootstrap.Modal(document.getElementById('delete-confirm-modal'));
        deleteModal.show();
    }

    // åˆ é™¤è´¦å·
    function deleteAccount() {
        if (deleteAccountIndex >= 0) {
            // åˆ é™¤è´¦å·
            accounts.splice(deleteAccountIndex, 1);

            // æ›´æ–°YAML
            generateConfig();

            // é‡æ–°æ¸²æŸ“è´¦å·åˆ—è¡¨
            renderAccounts();

            // å…³é—­æ¨¡æ€æ¡†
            const deleteModal = bootstrap.Modal.getInstance(document.getElementById('delete-confirm-modal'));
            deleteModal.hide();

            // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
            showStatus("è´¦å·å·²åˆ é™¤", "success");

            // é‡ç½®ç´¢å¼•
            deleteAccountIndex = -1;
        }
    }

    // æŸ¥çœ‹æç¤ºè¯
    function viewPrompt(index) {
        const account = accounts[index];

        // åˆ›å»ºæç¤ºè¯é¢„è§ˆ
        const previewEl = document.createElement('div');
        previewEl.className = 'alert alert-info alert-dismissible fade show template-preview';
        previewEl.innerHTML = `
            <h5>@${account.socialNetworkId} çš„æç¤ºè¯æ¨¡æ¿</h5>
            <pre class="mt-2 mb-0" style="max-height: 300px; overflow-y: auto;">${account.prompt || 'æ— æç¤ºè¯'}</pre>
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="å…³é—­"></button>
        `;

        // æ·»åŠ åˆ°é¡µé¢
        document.body.appendChild(previewEl);

        // 3ç§’åè‡ªåŠ¨å…³é—­
        setTimeout(function() {
            previewEl.remove();
        }, 10000);
    }

    // åˆå§‹åŒ–æ¨¡æ¿é€‰æ‹©
    function initTemplateSelection() {
        document.querySelectorAll('.template-item').forEach(item => {
            item.addEventListener('click', function(e) {
                e.preventDefault();
                const templateName = this.getAttribute('data-template');
                if (templates[templateName]) {
                    document.getElementById('account-prompt').value = templates[templateName];
                }
            });
        });
    }

    // äº‹ä»¶ç»‘å®š
    document.getElementById('save-config').addEventListener('click', saveConfig);
    document.getElementById('format-yaml').addEventListener('click', formatYaml);
    document.getElementById('validate-yaml').addEventListener('click', validateYaml);
    document.getElementById('show-help').addEventListener('click', function() {
        const helpModal = new bootstrap.Modal(document.getElementById('help-modal'));
        helpModal.show();
    });

    document.getElementById('add-account-btn').addEventListener('click', addAccount);
    document.getElementById('save-account-btn').addEventListener('click', saveAccount);
    document.getElementById('confirm-delete-btn').addEventListener('click', deleteAccount);

    // æ ‡ç­¾é¡µåˆ‡æ¢äº‹ä»¶
    document.getElementById('form-tab').addEventListener('click', function() {
        parseConfig();
    });

    document.getElementById('yaml-tab').addEventListener('click', function() {
        // å¦‚æœä»è¡¨å•è§†å›¾åˆ‡æ¢åˆ°YAMLè§†å›¾ï¼Œæ›´æ–°YAML
        generateConfig();
    });

    // æ·»åŠ é”®ç›˜å¿«æ·é”®
    document.addEventListener('keydown', function(e) {
        // Ctrl+S ä¿å­˜
        if (e.ctrlKey && e.key === 's') {
            e.preventDefault();
            saveConfig();
        }
    });

    // åˆå§‹åŒ–
    parseConfig();
    initTemplateSelection();
});
</script>
{% endblock %}
